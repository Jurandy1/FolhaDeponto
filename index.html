<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Portal de Recursos Humanos da SEMCAS - São Luís">
    <title>Portal RH - SEMCAS São Luís</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        semcas: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Inter', sans-serif; }
        body, .bg-white, .bg-gray-50, .text-gray-800 {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* --- PAPEL A4 (FOLHA DE PONTO E AVISO DE FÉRIAS) --- */
        :root {
            --bg-paper: #fff;
            --color-text-paper: #000;
            --border-paper: #000;
        }

        .page-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px 0;
            overflow-x: auto;
            perspective: 1000px;
        }

        .page {
            width: 210mm;
            min-width: 210mm;
            height: 297mm;
            background: var(--bg-paper);
            color: var(--color-text-paper);
            padding: 15mm 20mm; /* Margens padrão ABNT/Oficial */
            box-sizing: border-box;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            font-family: 'Times New Roman', Times, serif; /* Fonte Oficial para Documentos */
            position: relative;
        }

        /* Tabela Folha de Ponto */
        .folha-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 2px solid var(--border-paper);
            font-family: Arial, Helvetica, sans-serif; /* Ponto usa Arial */
        }
        .folha-table td, .folha-table th {
            border: 1px solid var(--border-paper);
            padding: 2px 4px;
            font-size: 11px;
            vertical-align: middle;
            color: var(--color-text-paper);
            overflow: hidden;
            white-space: nowrap;
        }
        
        /* Documento de Férias */
        .doc-header { text-align: center; margin-bottom: 40px; }
        .doc-brasao { width: 80px; height: auto; margin-bottom: 10px; }
        .doc-title { font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .doc-subtitle { font-size: 14px; font-weight: bold; }
        .doc-body { font-size: 14px; line-height: 1.6; text-align: justify; margin-bottom: 40px; }
        .doc-signature { margin-top: 80px; text-align: center; }
        .doc-line { border-top: 1px solid #000; width: 60%; margin: 0 auto 5px auto; }

        /* Inputs Editáveis */
        .input-linha {
            border: none; border-bottom: 1px solid #ccc; background: transparent;
            font-family: inherit; font-size: 11px; font-weight: bold; width: 100%; outline: none;
        }
        .input-linha:focus { border-bottom-color: #000; background-color: rgba(59, 130, 246, 0.1); }
        td[contenteditable="true"]:focus { background-color: #e8f0fe; outline: 2px solid #3b82f6; }

        /* Estilos Visuais Folha Ponto */
        .bg-gray-folha { background-color: #e5e7eb !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .bg-white-header { background-color: #fff !important; font-weight: bold; text-align: center; }
        .bg-white-cell { background-color: #fff !important; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s ease-out; 
            display: flex; align-items: center; gap: 10px; min-width: 250px;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }

        /* --- PRINT STYLES --- */
        @media print {
            header, .no-print, #ponto-controls, #content, #toast-container, .theme-toggle, .view-section { display: none !important; }
            body, html { margin: 0; padding: 0; background: #fff !important; color: #000 !important; }
            
            .print-active { display: block !important; }
            
            .page-wrapper { display: block; width: 100%; padding: 0; margin: 0; }
            .page { 
                margin: 0; border: none; box-shadow: none; width: 100%; height: 297mm; padding: 15mm 20mm; 
                page-break-after: always;
            }
            .input-linha { border-bottom: none; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .dark body { background-color: #fff !important; color: #000 !important; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .hero-banner { width: 100%; object-fit: cover; aspect-ratio: 3 / 1; }
        @media (max-width: 640px) { .hero-banner { aspect-ratio: 2 / 1; } }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- TOAST -->
    <div id="toast-container"></div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-semcas-600 dark:bg-gray-800 text-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-building-columns text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold leading-tight tracking-wide">Portal RH</h1>
                            <p class="text-xs text-blue-100 opacity-90">SEMCAS - São Luís</p>
                        </div>
                    </div>
                    <div class="flex gap-2 md:hidden">
                        <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-white/10 transition">
                            <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline text-yellow-300"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-3 md:mt-0 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                    <nav class="flex-grow">
                        <ul class="flex space-x-1 sm:space-x-2 text-sm whitespace-nowrap">
                            <li><button onclick="router('home')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="home"><i class="fas fa-home"></i> Início</button></li>
                            <li><button onclick="router('ferias')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="ferias"><i class="fas fa-umbrella-beach"></i> Férias</button></li>
                            <li><button onclick="router('ponto')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2 font-semibold" data-target="ponto"><i class="fas fa-clock"></i> Folha</button></li>
                            <li><button onclick="router('processos')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="processos"><i class="fas fa-folder-open"></i> Processos</button></li>
                            <li><button onclick="router('noticias')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="noticias"><i class="fas fa-newspaper"></i> Notícias</button></li>
                        </ul>
                    </nav>
                    <div class="hidden md:flex gap-2 ml-2">
                        <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-white/10 transition" title="Tema">
                            <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline text-yellow-300"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO -->
    <main class="flex-grow w-full max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
        
        <!-- HOME -->
        <div id="home-view" class="view-section hidden animate-fade-in">
            <div class="rounded-2xl overflow-hidden shadow-lg mb-6 ring-1 ring-black/5 relative group">
                <img id="bannerPrincipal" src="Gemini_Generated_Image_ufn1hnufn1hnufn1.png" alt="Recursos Humanos - SEMCAS" class="hero-banner transition transform group-hover:scale-[1.01] duration-700"/>
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6 md:p-10">
                    <div class="text-white">
                        <h2 class="text-3xl font-bold mb-2">Bem-vindo ao Portal do Servidor</h2>
                        <p class="opacity-90 max-w-2xl text-sm md:text-base">Centralize suas demandas de RH, emita folhas de ponto e acompanhe seus processos administrativos.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 p-3 rounded-lg"><i class="fas fa-database text-xl"></i></div>
                        <span class="text-xs font-bold bg-blue-50 dark:bg-gray-700 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full">Sistema</span>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Status da Conexão</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400" id="status-conexao">Verificando dados...</p>
                </div>
                <!-- Card Folha -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 p-3 rounded-lg"><i class="fas fa-clock text-xl"></i></div>
                        <button onclick="router('ponto')" class="text-xs font-bold text-purple-600 hover:underline">Acessar</button>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Folha de Ponto</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Gere sua folha individual ou em lote.</p>
                </div>
                <!-- Card Férias -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 p-3 rounded-lg"><i class="fas fa-umbrella-beach text-xl"></i></div>
                        <button onclick="router('ferias')" class="text-xs font-bold text-orange-600 hover:underline">Gerenciar</button>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Gestão de Férias</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Controle períodos aquisitivos e emita avisos.</p>
                </div>
            </div>
        </div>

        <!-- FÉRIAS ROBUSTAS -->
        <div id="ferias-view" class="view-section hidden">
            <!-- Header e Ações -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                        <i class="fas fa-umbrella-beach text-blue-600"></i> Gestão de Férias
                    </h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Sistema de Controle de Períodos Aquisitivos - Lei Mun. São Luís</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="abrirModalRegistroFerias()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition shadow flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Registrar Férias
                    </button>
                    <button onclick="carregarFerias()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-200 transition">
                        <i class="fas fa-sync-alt" id="icon-refresh-ferias"></i>
                    </button>
                    <button onclick="abrirHistoricoGeral()" class="bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-600 transition border dark:border-gray-600">
                        <i class="fas fa-archive"></i> Histórico Geral
                    </button>
                </div>
            </div>

            <!-- Dashboard Interativo -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <button onclick="filterFerias('vencida')" class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-100 dark:border-red-800/50 hover:bg-red-100 dark:hover:bg-red-900/40 transition text-left group">
                    <span class="text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider group-hover:underline">Vencidas</span>
                    <div class="text-3xl font-bold text-red-700 dark:text-red-400 mt-1" id="count-vencida">0</div>
                    <div class="text-[10px] text-red-500 mt-1">Clique para filtrar</div>
                </button>
                <button onclick="filterFerias('critico')" class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-800/50 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition text-left group">
                    <span class="text-xs font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider group-hover:underline">Crítico (< 60d)</span>
                    <div class="text-3xl font-bold text-orange-700 dark:text-orange-400 mt-1" id="count-critico">0</div>
                    <div class="text-[10px] text-orange-500 mt-1">Ação necessária</div>
                </button>
                <button onclick="filterFerias('atencao')" class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-100 dark:border-yellow-800/50 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition text-left group">
                    <span class="text-xs font-bold text-yellow-600 dark:text-yellow-400 uppercase tracking-wider group-hover:underline">Atenção (< 90d)</span>
                    <div class="text-3xl font-bold text-yellow-700 dark:text-yellow-400 mt-1" id="count-atencao">0</div>
                    <div class="text-[10px] text-yellow-500 mt-1">Planejamento</div>
                </button>
                <button onclick="filterFerias('emdia')" class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800/50 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition text-left group">
                    <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider group-hover:underline">Regular</span>
                    <div class="text-3xl font-bold text-blue-700 dark:text-blue-400 mt-1" id="count-emdia">0</div>
                    <div class="text-[10px] text-blue-500 mt-1">Sem pendências</div>
                </button>
            </div>

            <!-- Tabela -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700 flex flex-col lg:flex-row gap-4 items-center justify-between">
                    
                    <div class="flex items-center gap-2 w-full lg:w-auto p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg" id="batch-actions" style="display:none;">
                        <span class="text-xs font-bold text-blue-800 dark:text-blue-300 ml-2" id="batch-count">0 selecionados</span>
                        <div class="h-4 w-px bg-blue-300 dark:bg-blue-700"></div>
                        <button onclick="abrirModalRegistroFerias(true)" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 font-bold">
                            Registrar em Lote
                        </button>
                        <button onclick="limparSelecaoFerias()" class="text-xs text-blue-600 dark:text-blue-300 hover:underline px-2">Cancelar</button>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto flex-grow justify-end">
                        <div class="relative flex-grow max-w-md">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            <input id="filtroFerias" oninput="renderTabelaFerias()" placeholder="Buscar servidor por nome..." class="pl-9 w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-gray-700 dark:text-white">
                        </div>
                        <select id="filtroStatusFerias" onchange="renderTabelaFerias()" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none w-40">
                            <option value="todos">Todos Status</option>
                            <option value="vencida">Vencidas</option>
                            <option value="critico">Críticas</option>
                            <option value="atencao">Atenção</option>
                            <option value="emdia">Em Dia</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3 w-10 text-center"><input type="checkbox" onclick="toggleAllFerias(this)" class="accent-blue-600"></th>
                                <th class="px-4 py-3">Servidor</th>
                                <th class="px-4 py-3 hidden md:table-cell">Lotação</th>
                                <th class="px-4 py-3 hidden sm:table-cell">Limite Concessivo</th>
                                <th class="px-4 py-3 text-center">Saldo (Dias)</th>
                                <th class="px-4 py-3 text-center">Status</th>
                                <th class="px-4 py-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-ferias-body" class="divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800">
                            <!-- JS preenche -->
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-gray-50 dark:bg-gray-800 border-t dark:border-gray-700 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                    <div id="feriasPageInfo">Página 1</div>
                    <div class="flex gap-2">
                        <button id="feriasPrevBtn" class="px-3 py-1 rounded border hover:bg-white dark:hover:bg-gray-700" onclick="feriasPrev()">Ant</button>
                        <button id="feriasNextBtn" class="px-3 py-1 rounded border hover:bg-white dark:hover:bg-gray-700" onclick="feriasNext()">Próx</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- OUTRAS VIEWS (Ponto, Processos...) MANTIDAS MAS OCULTAS INICIALMENTE -->
        <div id="processos-view" class="view-section hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Processos SEI</h2>
            <div id="listaProcessos"></div>
            <button onclick="cadastrarProcessoDemo()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Adicionar Processo Demo</button>
        </div>
        <div id="noticias-view" class="view-section hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
             <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Notícias</h2>
             <div id="listaNoticias"></div>
        </div>

        <!-- PONTO (Restaurado com lógica completa) -->
        <div id="ponto-container" class="view-section hidden pb-20">
            <div id="ponto-controls" class="no-print bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6 sticky top-20 z-40">
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white"><i class="fas fa-print"></i> Gerador de Folha</h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Selecione o servidor e imprima (Papel A4).</p>
                    </div>
                    <button onclick="printPonto()" class="bg-gray-800 text-white px-5 py-2 rounded-lg font-bold"><i class="fas fa-print"></i> Imprimir</button>
                </div>
                <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                    <button onclick="switchTab('folha')" id="tab-btn-folha" class="tab-btn px-4 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600">Individual</button>
                    <button onclick="switchTab('lote')" id="tab-btn-lote" class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">Lote</button>
                    <button onclick="switchTab('feriados')" id="tab-btn-feriados" class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">Feriados</button>
                    <button onclick="switchTab('gestao')" id="tab-btn-gestao" class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">Gestão de Pessoas</button>
                </div>
                <div id="tab-folha" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-gray-50 dark:bg-gray-900/50 p-4 rounded">
                        <div class="md:col-span-5"><label class="text-xs font-bold">Servidor</label><select id="servidorSelect" class="w-full border rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-white"></select>
                        </div>
                        <div class="md:col-span-2"><button id="carregarDadosBtn" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">Preencher</button></div>
                        <div class="md:col-span-5 flex gap-2">
                             <div class="w-1/2"><label class="text-xs font-bold">Mês</label><select id="mesSelect" class="w-full border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white"></select></div>
                             <div class="w-1/2"><label class="text-xs font-bold">Ano</label><select id="anoSelect" class="w-full border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white"></select></div>
                        </div>
                    </div>
                </div>
                <div id="tab-lote" class="tab-content hidden">
                    <input id="filtroLote" class="w-full border rounded px-3 py-2 text-sm mb-3 dark:bg-gray-700 dark:text-white" placeholder="Filtrar...">
                    <div id="listaLote" class="h-40 overflow-y-auto bg-white dark:bg-gray-800 border rounded p-2 space-y-1 text-sm"></div>
                    <button onclick="imprimirLote()" class="w-full mt-3 bg-green-600 text-white py-2 rounded font-bold">Gerar Lote</button>
                </div>
                <div id="tab-feriados" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end bg-gray-50 dark:bg-gray-900/50 p-4 rounded mb-3">
                        <div class="flex items-center gap-2"><input id="chkFerNacional" type="checkbox" class="accent-blue-600"><label for="chkFerNacional" class="text-xs font-bold">Nacionais</label></div>
                        <div class="flex items-center gap-2"><input id="chkFerEstadual" type="checkbox" class="accent-blue-600"><label for="chkFerEstadual" class="text-xs font-bold">Estaduais (MA)</label></div>
                        <div class="flex items-center gap-2"><input id="chkFerMunicipal" type="checkbox" class="accent-blue-600"><label for="chkFerMunicipal" class="text-xs font-bold">Municipais (São Luís)</label></div>
                        <div><label class="text-xs font-bold">Ano</label><select id="feriadosAnoSelect" class="w-full border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white"></select></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 border rounded p-3">
                        <div class="flex gap-2 mb-3">
                            <input type="date" id="customFerData" class="border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white">
                            <input type="text" id="customFerNome" placeholder="Nome do feriado" class="flex-1 border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white">
                            <button id="btnAddFeriado" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold">Adicionar</button>
                        </div>
                        <div id="holidayListContainer" class="h-64 overflow-y-auto text-sm"></div>
                    </div>
                </div>
                <div id="tab-gestao" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 border rounded p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-users text-gray-500"></i>
                                <div class="font-bold">Vincular Unidade</div>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <div class="relative flex-1">
                                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                                    <input id="gpFiltroNome" class="pl-9 w-full border rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-white" placeholder="Buscar servidor">
                                </div>
                                <input id="gpUnidadeInput" class="w-64 border rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-white" placeholder="Unidade Administrativa">
                                <button id="gpSalvarBtn" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold">Vincular</button>
                            </div>
                            <div id="gpPendentesList" class="h-64 overflow-y-auto border rounded p-2 text-sm bg-white dark:bg-gray-800"></div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 border rounded p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-network-wired text-gray-500"></i>
                                <div class="font-bold">Vinculados</div>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <select id="gpUnidadeSelect" class="border rounded px-2 py-2 text-sm dark:bg-gray-700 dark:text-white"></select>
                                <input id="gpFiltroVinculados" class="flex-1 border rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-white" placeholder="Filtrar nome">
                                <button id="gpGerarFolhasBtn" class="bg-green-600 text-white px-3 py-2 rounded text-sm font-bold">Gerar Folhas</button>
                            </div>
                            <div id="gpVinculadosList" class="h-64 overflow-y-auto border rounded p-2 text-sm bg-white dark:bg-gray-800"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Folha de Ponto Layout A4 -->
            <div class="page-wrapper no-print:mt-4">
                <div class="page" id="mainPaper">
                    <table class="folha-table">
                        <tr><td class="bg-gray-folha titulo-folha" style="width: 70%;">REGISTRO INDIVIDUAL DE FREQUÊNCIA</td><td class="bg-white-header"><span id="labelMesAno">NOV/2025</span></td></tr>
                        <tr><td colspan="2" class="bg-white-header">Secretaria Municipal da Criança e Assistência Social/ SEMCAS</td></tr>
                        <tr><td class="bg-white-cell">Nome: <input id="inpNome" class="input-linha"></td><td class="bg-white-cell">Matrícula: <input id="inpMatricula" class="input-linha" style="width:80px"></td></tr>
                        <tr><td class="bg-white-cell">Cargo: <input id="inpCargo" class="input-linha"></td><td class="bg-white-cell">Vínculo: <input id="inpVinculo" class="input-linha"></td></tr>
                        <tr><td class="bg-white-cell">Unidade Administrativa: <input id="inpUnidade" class="input-linha"></td><td class="bg-white-cell"></td></tr>
                    </table>
                    <table class="folha-table" style="margin-top: -1px;">
                        <colgroup>
                            <col class="col-dia">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                        </colgroup>
                        <thead>
                            <tr class="bg-white-header">
                                <th rowspan="3">Dia</th>
                                <th colspan="8">Horário de Trabalho</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="4">Manhã</th>
                                <th colspan="4">Tarde</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>08:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>12:00</th>
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>14:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>18:00</th>
                            </tr>
                            <tr class="bg-gray-folha">
                                <th></th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                            </tr>
                        </thead>
                        <tbody id="daysTableBody"></tbody>
                    </table>
                    <!-- Assinaturas -->
                    <table class="footer-table" style="width:100%; border-collapse:collapse; margin-top:-1px;">
                         <tr>
                            <td class="box-assinatura" style="border:1px solid #000; height:100px; vertical-align:top; padding:5px; width:50%;">
                                <div style="font-weight: bold; font-size: 11px;">Chefia Imediata:</div>
                                <div style="margin-top:40px; border-top:1px solid #000; width:80%;"></div>
                                <div style="font-size:11px; margin-top:6px;">São Luís, <span contenteditable="true" style="display:inline-block; min-width:120px; border-bottom:1px dotted #000;">__/__/____</span></div>
                            </td>
                            <td class="box-assinatura" style="border:1px solid #000; height:100px; vertical-align:top; padding:5px; width:50%;">
                                <div style="font-weight: bold; font-size: 11px;">Visto (Área de Recursos Humanos):</div>
                                <div style="margin-top:40px; border-top:1px solid #000; width:80%;"></div>
                                <div style="font-size:11px; margin-top:6px;">São Luís, <span contenteditable="true" style="display:inline-block; min-width:120px; border-bottom:1px dotted #000;">__/__/____</span></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="printContainer" class="hidden"></div>
        </div>

        <!-- CONTEXTO DE IMPRESSÃO: DOCUMENTO DE FÉRIAS -->
        <div id="ferias-print-container" class="hidden">
            <div class="page" id="docFeriasPaper">
                <div class="doc-header">
                    <div style="width:80px; height:80px; background:#eee; margin:0 auto 10px auto; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid #ccc;">
                        <i class="fas fa-landmark text-3xl text-gray-400"></i>
                    </div>
                    <div class="doc-title">PREFEITURA DE SÃO LUÍS</div>
                    <div class="doc-subtitle">SECRETARIA MUNICIPAL DA CRIANÇA E ASSISTÊNCIA SOCIAL - SEMCAS</div>
                    <div style="margin-top:10px; font-weight:bold;">AVISO DE FÉRIAS</div>
                </div>

                <div class="doc-body">
                    <p style="margin-bottom: 20px;">
                        A <strong>SECRETARIA MUNICIPAL DA CRIANÇA E ASSISTÊNCIA SOCIAL</strong>, no uso de suas atribuições legais e em conformidade com o Estatuto do Servidor Público Municipal de São Luís, comunica ao(à) servidor(a) abaixo identificado(a) a concessão de suas férias regulamentares.
                    </p>

                    <table style="width:100%; margin-bottom: 20px; border-collapse:collapse; border:1px solid #000;">
                        <tr><td style="padding:5px; border:1px solid #000; font-weight:bold; width:30%;">NOME:</td><td style="padding:5px; border:1px solid #000;" id="docNome">Fulano de Tal</td></tr>
                        <tr><td style="padding:5px; border:1px solid #000; font-weight:bold;">MATRÍCULA:</td><td style="padding:5px; border:1px solid #000;" id="docMatricula">00000</td></tr>
                        <tr><td style="padding:5px; border:1px solid #000; font-weight:bold;">LOTAÇÃO:</td><td style="padding:5px; border:1px solid #000;" id="docLotacao">SEMCAS</td></tr>
                        <tr><td style="padding:5px; border:1px solid #000; font-weight:bold;">PERÍODO AQUISITIVO:</td><td style="padding:5px; border:1px solid #000;" id="docPeriodoAquisitivo">2024/2025</td></tr>
                    </table>

                    <p style="margin-bottom: 10px;">O gozo das férias ocorrerá no seguinte período:</p>

                    <table style="width:100%; margin-bottom: 30px; border-collapse:collapse; border:1px solid #000; text-align:center;">
                        <tr style="background:#eee; font-weight:bold;">
                            <td style="padding:5px; border:1px solid #000;">INÍCIO</td>
                            <td style="padding:5px; border:1px solid #000;">FIM</td>
                            <td style="padding:5px; border:1px solid #000;">DIAS</td>
                        </tr>
                        <tr>
                            <td style="padding:10px; border:1px solid #000;" id="docDataInicio">01/11/2025</td>
                            <td style="padding:10px; border:1px solid #000;" id="docDataFim">30/11/2025</td>
                            <td style="padding:10px; border:1px solid #000;" id="docDias">30</td>
                        </tr>
                    </table>
                </div>

                <div class="doc-signature">
                    <div style="margin-bottom: 10px;">São Luís - MA, <span id="docDataAtual">02 de Dezembro de 2025</span>.</div>
                    <br><br><br>
                    <div class="doc-line"></div>
                    <div><strong>Gestão de Recursos Humanos</strong></div>
                    <div style="font-size:12px;">SEMCAS</div>
                    <br><br><br>
                    <div class="doc-line" style="width:40%;"></div>
                    <div style="font-size:12px;">Ciente do Servidor(a)</div>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL REGISTRO DE FÉRIAS -->
            <div id="modalFerias" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md p-6 shadow-2xl border dark:border-gray-600">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white border-b pb-2">Registrar Férias</h3>
                    <div id="feriasBatchInfo" class="hidden mb-4 bg-blue-50 dark:bg-blue-900/30 p-3 rounded text-sm text-blue-800 dark:text-blue-300">
                        <i class="fas fa-layer-group"></i> Registrando para <span id="feriasBatchCount" class="font-bold">0</span> servidores.
                    </div>
                    <div class="space-y-4">
                        <div id="divServidorSingle">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Servidor</label>
                            <select id="feriasServidorSelect" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white"></select>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Data Início</label>
                                <input type="date" id="feriasInicio" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" onchange="calcularFimFerias()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Duração</label>
                                <select id="feriasDuracao" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" onchange="calcularFimFerias()">
                                    <option value="30">30 dias</option><option value="20">20 dias</option><option value="15">15 dias</option><option value="10">10 dias</option><option value="5">05 dias</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Tipo</label>
                                <div class="flex gap-3 text-xs">
                                    <label class="inline-flex items-center gap-2"><input type="radio" name="feriasTipo" value="programada" class="accent-blue-600" checked> Programada</label>
                                    <label class="inline-flex items-center gap-2"><input type="radio" name="feriasTipo" value="retroativa" class="accent-blue-600"> Já gozada</label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Mês/Ano</label>
                                <div class="flex gap-2">
                                    <select id="feriasMes" class="border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                        <option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                    </select>
                                    <input id="feriasAno" type="number" min="2000" max="2100" class="border rounded px-2 py-2 w-20 dark:bg-gray-700 dark:text-white"/>
                                </div>
                                <div class="mt-2 text-xs"><label class="inline-flex items-center gap-2"><input type="checkbox" id="feriasUseMesAno" class="accent-blue-600"> Usar Mês/Ano (primeiro dia)</label></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-900 p-3 rounded border dark:border-gray-700 flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Retorno:</span>
                            <span id="feriasRetornoDisplay" class="font-bold text-gray-800 dark:text-white">--/--/----</span>
                        </div>
                        <div class="flex gap-2 justify-end mt-4">
                            <button onclick="fecharModalFerias()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                            <button onclick="salvarFerias()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- MODAL CONFIG -->
    <div id="modalConfig" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-lg p-6 shadow-2xl border dark:border-gray-600">
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white"><i class="fas fa-cog"></i> Configuração de Dados</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Insira a URL pública (CSV) do Google Sheets para alimentar o sistema.</p>
            <input id="configUrlInput" class="w-full border rounded px-3 py-2 mb-2 dark:bg-gray-700 dark:text-white font-mono text-xs" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
            <div class="flex gap-2 justify-end mt-4">
                <button onclick="resetarConfig()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded text-sm mr-auto">Restaurar Padrão</button>
                <button onclick="document.getElementById('modalConfig').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                <button onclick="salvarConfig()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL HISTÓRICO DE FÉRIAS -->
    <div id="modalHistorico" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-lg p-6 shadow-2xl border dark:border-gray-600">
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white border-b pb-2">Histórico de Férias</h3>
            <div id="historicoNome" class="text-sm text-gray-600 dark:text-gray-300 mb-2"></div>
            <div id="historicoLista" class="max-h-64 overflow-y-auto text-sm"></div>
            <div class="flex gap-2 justify-end mt-4">
                <button onclick="fecharHistorico()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL HISTÓRICO GERAL -->
    <div id="modalHistoricoGeral" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-2xl p-6 shadow-2xl border dark:border-gray-600">
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white border-b pb-2">Histórico Geral de Férias</h3>
            <div class="flex gap-2 mb-3">
                <input id="historicoFiltroNome" class="flex-1 border rounded px-3 py-2 text-sm dark:bg-gray-700 dark:text-white" placeholder="Filtrar por nome">
                <button onclick="fecharHistoricoGeral()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Fechar</button>
            </div>
            <div id="historicoGeralLista" class="max-h-96 overflow-y-auto text-sm"></div>
        </div>
    </div>

    <script>
        // --- DADOS DE FALLBACK (PARA QUANDO A PLANILHA FALHAR) ---
        const DUMMY_DATA = [
            { "Nome": "ANA PAULA SILVA", "Matricula": "12345", "Lotacao": "RH", "Admissao": "01/02/2020", "Cargo": "Analista" },
            { "Nome": "CARLOS EDUARDO SOUZA", "Matricula": "67890", "Lotacao": "FINANCEIRO", "Admissao": "15/05/2018", "Cargo": "Técnico" },
            { "Nome": "MARIA FERNANDA LIMA", "Matricula": "54321", "Lotacao": "GABINETE", "Admissao": "10/01/2023", "Cargo": "Assessor" },
            { "Nome": "JOAO PEDRO SANTOS", "Matricula": "98765", "Lotacao": "SEMCAS", "Admissao": "20/11/2019", "Cargo": "Motorista" },
            { "Nome": "LUCIA HELENA COSTA", "Matricula": "11223", "Lotacao": "RH", "Admissao": "05/08/2021", "Cargo": "Assistente" }
        ];

        // *** AQUI ESTÁ O AJUSTE AUTOMÁTICO DO LINK ***
        // O usuário forneceu um link 'pubhtml', mas precisamos do 'pub?output=csv'
        const DEFAULT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjyCxbgnAsHpVZsAzU_VzGi7D-TXnaPciKUWudnp5thY6N53R8laj-aWB8IF_pQPCTevKdOro8rGAM/pub?output=csv';
        function normalizeSheetUrl(url) {
            if (!url) return DEFAULT_URL;
            let u = url.trim();
            if (u.includes('output=csv')) return u;
            try {
                const x = new URL(u);
                if (x.hostname.includes('docs.google.com') && x.pathname.includes('/spreadsheets')) {
                    if (x.pathname.includes('/pubhtml')) {
                        x.pathname = x.pathname.replace('/pubhtml', '/pub');
                        x.search = '?output=csv';
                        return x.toString();
                    }
                    if (x.pathname.includes('/edit')) {
                        x.pathname = x.pathname.replace('/edit', '/export');
                        x.searchParams.set('format', 'csv');
                        return x.toString();
                    }
                    if (x.pathname.includes('/export')) {
                        x.searchParams.set('format', 'csv');
                        return x.toString();
                    }
                    if (x.pathname.includes('/pub') && !x.search.includes('output=')) {
                        x.search = '?output=csv';
                        return x.toString();
                    }
                }
            } catch(e) {}
            return u;
        }
        let API_URL = normalizeSheetUrl(DEFAULT_URL);

        let app = { 
            data: [], 
            feriasLancadas: JSON.parse(localStorage.getItem('feriasHistorico') || '[]'),
            selectedFerias: new Set(),
            holidayConfig: {
                nacional: true,
                estadual: true,
                municipal: true,
                custom: JSON.parse(localStorage.getItem('customHolidays') || '[]')
            },
            unidadesMap: JSON.parse(localStorage.getItem('unidadesMap') || '{}')
        };
        let feriasState = { page: 1, perPage: 25, filterStatus: 'todos' };

        // --- UTILS ---
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-triangle':'info-circle'}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            requestAnimationFrame(()=>t.classList.add('show'));
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, 3000);
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');

        function router(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            const target = document.getElementById(view === 'home' ? 'home-view' : view === 'ferias' ? 'ferias-view' : view === 'ponto' ? 'ponto-container' : 'processos-view');
            if(target) target.classList.remove('hidden');
            if(view === 'ferias') carregarFerias();
            if(view === 'ponto') carregarPlanilha();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            if(t==='feriados') renderHolidayList();
            if(t==='gestao') renderGestaoPessoas();
        }

        function abrirConfiguracoes() {
            document.getElementById('configUrlInput').value = API_URL;
            document.getElementById('modalConfig').classList.remove('hidden');
        }

        function salvarConfig() {
            const url = normalizeSheetUrl(document.getElementById('configUrlInput').value.trim());
            if(url) {
                API_URL = url;
                localStorage.setItem('sheetCsvUrl', url);
                app.data = []; // Limpa cache
                showToast('Configuração salva! Recarregando...', 'success');
                document.getElementById('modalConfig').classList.add('hidden');
                carregarFerias(); // Tenta recarregar
            }
        }

        function resetarConfig() {
            API_URL = DEFAULT_URL;
            localStorage.setItem('sheetCsvUrl', DEFAULT_URL);
            document.getElementById('configUrlInput').value = DEFAULT_URL;
            showToast('URL restaurada para o padrão.', 'info');
        }

        // --- FETCH ROBUSTO ---
        async function fetchCSV() {
            document.getElementById('status-conexao').innerText = "Conectando ao Google Sheets...";
            document.getElementById('status-conexao').className = "text-sm text-blue-500";
            
            try {
                // Tenta fetch direto
                let res;
                try {
                    res = await fetch(API_URL, {cache:'no-store'});
                } catch(e) {
                    // Se falhar CORS, tenta proxy
                    res = await fetch(`https://cors.isomorphic-git.org/${API_URL}`, {cache:'no-store'});
                }

                if(!res.ok) throw new Error("Status " + res.status);

                const txt = await res.text();
                const { headers, rows } = parseCSV(txt);
                if(headers.length === 0 || rows.length === 0) throw new Error("CSV vazio");
                const data = rows.map(cols => {
                    const row = {};
                    headers.forEach((k,i)=> row[k] = (cols[i]||'').trim());
                    return row;
                });
                
                document.getElementById('status-conexao').innerText = "Conectado. " + data.length + " registros.";
                document.getElementById('status-conexao').className = "text-sm text-green-600 font-bold";
                return data;

            } catch(e) { 
                console.error("Erro planilha:", e);
                showToast("Erro ao carregar planilha. Usando dados de teste.", 'error');
                
                document.getElementById('status-conexao').innerHTML = "<i class='fas fa-exclamation-triangle'></i> Falha na conexão. <br>Modo Offline (Dados fictícios).";
                document.getElementById('status-conexao').className = "text-sm text-red-500 font-bold";
                
                // Retorna Dummy Data normalizado para parecer com o CSV
                return DUMMY_DATA.map(d => ({
                    'Nome': d.Nome, 'Servidor': d.Nome, 'Funcionário': d.Nome,
                    'Matrícula': d.Matricula, 'Matricula': d.Matricula,
                    'Lotação': d.Lotacao, 'Unidade': d.Lotacao,
                    'Admissão': d.Admissao, 'Data Admissão': d.Admissao,
                    'Cargo': d.Cargo
                }));
            }
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.length > 0);
            if(lines.length === 0) return { headers: [], rows: [] };
            const first = lines[0];
            const delimiter = (first.includes(';') && !first.includes(',')) ? ';' : ',';
            const headers = splitRow(first, delimiter).map((x, i) => x.replace(/^\uFEFF/, '').replace(/"/g,'').trim());
            const rows = [];
            for(let i=1;i<lines.length;i++) {
                const cols = splitRow(lines[i], delimiter).map(x => x.replace(/"/g,''));
                rows.push(cols);
            }
            return { headers, rows };
        }

        function splitRow(line, delimiter) {
            const out = [];
            let cur = '';
            let inQuotes = false;
            for(let i=0;i<line.length;i++) {
                const ch = line[i];
                if(ch === '"') {
                    if(inQuotes && i+1 < line.length && line[i+1] === '"') { cur += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if(ch === delimiter && !inQuotes) {
                    out.push(cur); cur = '';
                } else {
                    cur += ch;
                }
            }
            out.push(cur);
            return out;
        }

        function normalizeKeyName(s) {
            return s.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .replace(/[^a-z0-9]/g,'');
        }
        function getField(row, keys) {
            const normalized = Object.keys(row).map(k => ({ k, n: normalizeKeyName(k) }));
            for(const {k, n} of normalized) {
                for(const key of keys) {
                    const kn = normalizeKeyName(key);
                    if(n.includes(kn)) return row[k];
                }
            }
            // Fallback: tenta primeira coluna com valor "nome" (tem espaço e letras)
            const firstVal = row[Object.keys(row)[0]];
            if(keys.includes('nome') && typeof firstVal === 'string' && /[a-zA-ZÀ-ÿ]+\s+[a-zA-ZÀ-ÿ]+/.test(firstVal)) return firstVal;
            return '';
        }

        // --- FÉRIAS ---
        async function carregarFerias() {
            if(!app.data.length) app.data = await fetchCSV();
            feriasState.page = 1;
            renderTabelaFerias();
        }

        function calcularSaldo(nome, admissaoStr) {
            if(!admissaoStr) return { saldo: 0, status: 'indefinido', limite: null };
            const parts = admissaoStr.split('/');
            if(parts.length!==3) return { saldo: 0 };
            const admissao = new Date(parts[2].length===2?'20'+parts[2]:parts[2], parts[1]-1, parts[0]);
            const hoje = new Date();
            let anos = hoje.getFullYear() - admissao.getFullYear();
            const aniv = new Date(hoje.getFullYear(), admissao.getMonth(), admissao.getDate());
            if(hoje < aniv) anos--;
            const fimPeriodo = new Date(admissao); fimPeriodo.setFullYear(fimPeriodo.getFullYear() + anos);
            const limite = new Date(fimPeriodo); limite.setFullYear(limite.getFullYear()+1);
            
            const tiradas = app.feriasLancadas.filter(f => f.nome === nome).reduce((acc, cur) => acc + parseInt(cur.dias), 0);
            const saldo = 30 - (tiradas % 30);
            const diasRestantes = Math.ceil((limite - hoje)/(1000*60*60*24));
            
            let status = 'emdia';
            if(diasRestantes < 0) status = 'vencida';
            else if(diasRestantes < 60) status = 'critico';
            else if(diasRestantes < 90) status = 'atencao';
            return { saldo, status, limite, diasRestantes };
        }

        function renderTabelaFerias() {
            const tbody = document.getElementById('tabela-ferias-body');
            tbody.innerHTML = '';
            const filtroStatus = document.getElementById('filtroStatusFerias').value;
            const filtroNome = document.getElementById('filtroFerias').value.toLowerCase();
            
            let lista = app.data.map(r => {
                const nome = getField(r, ['nome','servidor','funcionar']);
                const admissao = getField(r, ['admiss','data']);
                const lotacao = getField(r, ['lotac','unidade']) || 'SEMCAS';
                const calc = calcularSaldo(nome, admissao);
                return { nome, lotacao, ...calc };
            }).filter(i => i.nome);

            // Atualiza contadores do dashboard
            const counts = { vencida: 0, critico: 0, atencao: 0, emdia: 0 };
            lista.forEach(i => { if(counts[i.status] !== undefined) counts[i.status]++; });
            const setText = (id, v) => { const el = document.getElementById(id); if(el) el.innerText = v; };
            setText('count-vencida', counts.vencida);
            setText('count-critico', counts.critico);
            setText('count-atencao', counts.atencao);
            setText('count-emdia', counts.emdia);

            lista = lista.filter(i => {
                if(filtroNome && !i.nome.toLowerCase().includes(filtroNome)) return false;
                if(filtroStatus !== 'todos' && i.status !== filtroStatus) return false;
                return true;
            });
            lista.sort((a,b) => a.diasRestantes - b.diasRestantes);

            // Paginação
            const total = lista.length;
            const per = feriasState.perPage;
            const pages = Math.max(1, Math.ceil(total / per));
            if(feriasState.page > pages) feriasState.page = pages;
            const start = (feriasState.page - 1) * per;
            const sliced = lista.slice(start, start + per);
            const pageInfo = document.getElementById('feriasPageInfo');
            if(pageInfo) pageInfo.innerText = `Página ${feriasState.page} de ${pages} • ${total} registros`;

            sliced.forEach(item => {
                let badge = '';
                if(item.status==='vencida') badge = '<span class="px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-bold">VENCIDA</span>';
                else if(item.status==='critico') badge = '<span class="px-2 py-1 rounded-full bg-orange-100 text-orange-800 text-xs font-bold">CRÍTICO</span>';
                else if(item.status==='atencao') badge = '<span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">ATENÇÃO</span>';
                else badge = '<span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">EM DIA</span>';

                const checked = app.selectedFerias.has(item.nome) ? 'checked' : '';
                const limiteFmt = item.limite ? item.limite.toLocaleDateString('pt-BR') : '-';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 border-b dark:border-gray-700">
                        <td class="px-4 py-3 text-center"><input type="checkbox" value="${item.nome}" class="accent-blue-600 w-4 h-4 cursor-pointer" onclick="toggleFeriasSelection('${item.nome}')" ${checked}></td>
                        <td class="px-4 py-3 font-medium dark:text-gray-200">${item.nome}</td>
                        <td class="px-4 py-3 text-gray-500 hidden md:table-cell dark:text-gray-400">${item.lotacao}</td>
                        <td class="px-4 py-3 text-gray-700 dark:text-gray-300 font-bold">${limiteFmt}</td>
                        <td class="px-4 py-3 text-center font-bold text-blue-600 dark:text-blue-400">${item.saldo} dias</td>
                        <td class="px-4 py-3 text-center">${badge}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="gerarDocumentoFerias('${item.nome}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 text-xs font-bold border border-blue-200 px-2 py-1 rounded hover:bg-blue-50 dark:hover:bg-gray-700 transition"><i class="fas fa-file-contract"></i> Aviso</button>
                            <button onclick="abrirHistoricoFerias('${item.nome}')" class="text-xs font-bold text-gray-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700 transition ml-1"><i class="fas fa-list"></i> Histórico</button>
                        </td>
                    </tr>`;
            });
            updateBatchUI();
        }

        function filterFerias(status) {
            const sel = document.getElementById('filtroStatusFerias');
            if(sel) sel.value = status;
            feriasState.filterStatus = status;
            feriasState.page = 1;
            renderTabelaFerias();
        }
        function feriasPrev() { if(feriasState.page > 1) { feriasState.page--; renderTabelaFerias(); } }
        function feriasNext() { feriasState.page++; renderTabelaFerias(); }

        // --- BATCH ---
        function toggleAllFerias(master) {
            document.querySelectorAll('#tabela-ferias-body input[type="checkbox"]').forEach(b => {
                b.checked = master.checked;
                master.checked ? app.selectedFerias.add(b.value) : app.selectedFerias.delete(b.value);
            });
            updateBatchUI();
        }
        function toggleFeriasSelection(nome) {
            app.selectedFerias.has(nome) ? app.selectedFerias.delete(nome) : app.selectedFerias.add(nome);
            updateBatchUI();
        }
        function updateBatchUI() {
            const count = app.selectedFerias.size;
            document.getElementById('batch-actions').style.display = count > 0 ? 'flex' : 'none';
            document.getElementById('batch-count').innerText = `${count} selecionado(s)`;
        }
        function limparSelecaoFerias() { app.selectedFerias.clear(); renderTabelaFerias(); }
        
        // --- REGISTRO DE FÉRIAS ---
        let modalMode = 'single';
        function abrirModalRegistroFerias(isBatch = false) {
            modalMode = isBatch ? 'batch' : 'single';
            if(isBatch && app.selectedFerias.size === 0) return showToast('Selecione servidores!', 'error');
            
            document.getElementById('feriasBatchInfo').classList.toggle('hidden', !isBatch);
            document.getElementById('divServidorSingle').classList.toggle('hidden', isBatch);
            if(isBatch) document.getElementById('feriasBatchCount').innerText = app.selectedFerias.size;
            else {
                const sel = document.getElementById('feriasServidorSelect');
                if(sel) {
                    const names = Array.from(new Set(app.data.map(r=>getField(r,['nome','servidor','funcionar','funcion','funcionario']).trim()).filter(Boolean))).sort();
                    sel.innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
                }
            }
            
            document.getElementById('feriasInicio').valueAsDate = new Date();
            calcularFimFerias();
            document.getElementById('modalFerias').classList.remove('hidden');
        }
        function fecharModalFerias() { document.getElementById('modalFerias').classList.add('hidden'); }
        function calcularFimFerias() {
            const inicio = document.getElementById('feriasInicio').value;
            const dias = parseInt(document.getElementById('feriasDuracao').value);
            const useMY = document.getElementById('feriasUseMesAno')?.checked;
            const mmSel = document.getElementById('feriasMes')?.value;
            const aaSel = document.getElementById('feriasAno')?.value;
            let start = inicio;
            if(useMY && mmSel && aaSel) start = `${aaSel}-${mmSel}-01`;
            if(start) {
                const dt = new Date(start); dt.setDate(dt.getDate() + dias - 1);
                document.getElementById('feriasRetornoDisplay').innerText = dt.toLocaleDateString('pt-BR');
            }
        }
        function salvarFerias() {
            let inicio = document.getElementById('feriasInicio').value;
            const dias = parseInt(document.getElementById('feriasDuracao').value);
            const useMY = document.getElementById('feriasUseMesAno')?.checked;
            const mmSel = document.getElementById('feriasMes')?.value;
            const aaSel = document.getElementById('feriasAno')?.value;
            if(useMY && mmSel && aaSel) inicio = `${aaSel}-${mmSel}-01`;
            if(!inicio) return showToast('Selecione data início', 'error');
            const tipo = Array.from(document.getElementsByName('feriasTipo')).find(r=>r.checked)?.value || 'programada';
            const targets = [];
            if(modalMode === 'batch') app.selectedFerias.forEach(n => targets.push(n));
            else {
                const n = document.getElementById('feriasServidorSelect').value;
                if(!n) return showToast('Selecione o servidor', 'error'); targets.push(n);
            }
            const inicioDate = new Date(inicio);
            const fimDate = new Date(inicio); fimDate.setDate(fimDate.getDate() + dias - 1);
            const invalids = [];
            const saved = [];
            targets.forEach(nome => {
                const row = app.data.find(r => getField(r, ['nome','servidor','funcionar','funcion','funcionario']) === nome);
                const adm = row ? getField(row, ['admiss','data']) : '';
                const calc = calcularSaldo(nome, adm);
                const limite = calc.limite;
                if(limite && inicioDate > limite) {
                    const sug = new Date(limite); sug.setDate(sug.getDate() - dias + 1);
                    invalids.push({ nome, motivo: 'fora do limite concessivo', sugestao: sug });
                    return;
                }
                if(hasOverlap(nome, inicioDate, fimDate)) {
                    invalids.push({ nome, motivo: 'conflito com lançamento existente' });
                    return;
                }
                app.feriasLancadas.push({ nome, inicio, dias, tipo, registradoEm: new Date().toISOString() });
                saved.push(nome);
            });
            if(saved.length) {
                localStorage.setItem('feriasHistorico', JSON.stringify(app.feriasLancadas));
                showToast(`${saved.length} férias registradas!`, 'success');
            }
            if(invalids.length) {
                const msg = invalids.map(i=>`${i.nome}: ${i.motivo}${i.sugestao?` • sug.: ${i.sugestao.toLocaleDateString('pt-BR')}`:''}`).join('\n');
                showToast(`Alguns lançamentos inválidos:\n${msg}`, 'error');
                const sug = invalids.find(i=>i.sugestao)?.sugestao;
                if(sug) {
                    const iso = `${sug.getFullYear()}-${String(sug.getMonth()+1).padStart(2,'0')}-${String(sug.getDate()).padStart(2,'0')}`;
                    const inp = document.getElementById('feriasInicio'); if(inp) inp.value = iso;
                }
            }
            fecharModalFerias(); renderTabelaFerias(); limparSelecaoFerias();
        }
        function hasOverlap(nome, start, end) {
            const list = app.feriasLancadas.filter(f => f.nome === nome);
            for(const f of list) {
                const s = new Date(f.inicio);
                const e = new Date(f.inicio); e.setDate(e.getDate() + parseInt(f.dias) - 1);
                if(!(end < s || start > e)) return true;
            }
            return false;
        }

        function abrirHistoricoFerias(nome) {
            const lista = app.feriasLancadas.filter(f => f.nome === nome);
            document.getElementById('historicoNome').innerText = `Servidor: ${nome}`;
            const cont = document.getElementById('historicoLista');
            cont.innerHTML = '';
            if(lista.length === 0) cont.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Sem lançamentos.</div>';
            else {
                lista.forEach((f, idx) => {
                    const di = new Date(f.inicio);
                    cont.innerHTML += `<div class="flex justify-between items-center border-b py-2">
                        <div>
                            <div class="font-bold">${di.toLocaleDateString('pt-BR')} • ${f.dias} dias</div>
                            <div class="text-xs text-gray-500">Registrado em ${new Date(f.registradoEm).toLocaleString('pt-BR')}</div>
                        </div>
                        <button class="text-xs text-red-600 px-2 py-1 border rounded hover:bg-red-50" onclick="removerHistoricoFerias('${nome}', ${idx})">Remover</button>
                    </div>`;
                });
            }
            document.getElementById('modalHistorico').classList.remove('hidden');
        }
        function fecharHistorico() { document.getElementById('modalHistorico').classList.add('hidden'); }
        function removerHistoricoFerias(nome, indexInFiltered) {
            const filtered = app.feriasLancadas.filter(f => f.nome === nome);
            const target = filtered[indexInFiltered];
            if(!target) return;
            const idx = app.feriasLancadas.findIndex(f => f.nome === target.nome && f.inicio === target.inicio && f.dias === target.dias && f.registradoEm === target.registradoEm);
            if(idx >= 0) {
                app.feriasLancadas.splice(idx,1);
                localStorage.setItem('feriasHistorico', JSON.stringify(app.feriasLancadas));
                showToast('Lançamento removido.', 'success');
                renderTabelaFerias();
                const nomeAtual = document.getElementById('historicoNome').innerText.replace('Servidor: ','');
                abrirHistoricoFerias(nomeAtual);
            }
        }
        function abrirHistoricoGeral() {
            const cont = document.getElementById('historicoGeralLista');
            const filtro = document.getElementById('historicoFiltroNome');
            const render = () => {
                const q = (filtro?.value || '').toLowerCase();
                const items = app.feriasLancadas
                    .filter(f => !q || f.nome.toLowerCase().includes(q))
                    .sort((a,b) => new Date(b.inicio) - new Date(a.inicio));
                cont.innerHTML = items.map(f => `<div class="flex justify-between items-center border-b py-2">
                    <div>
                        <div class="font-bold">${f.nome}</div>
                        <div class="text-xs">${new Date(f.inicio).toLocaleDateString('pt-BR')} • ${f.dias} dias • ${f.tipo||'programada'}</div>
                    </div>
                    <button class="text-xs text-red-600 px-2 py-1 border rounded hover:bg-red-50" onclick="removerHistoricoGeral('${f.nome}','${f.inicio}',${f.dias},'${f.registradoEm}')">Remover</button>
                </div>`).join('');
            };
            if(filtro) filtro.oninput = render;
            render();
            document.getElementById('modalHistoricoGeral').classList.remove('hidden');
        }
        function fecharHistoricoGeral() { document.getElementById('modalHistoricoGeral').classList.add('hidden'); }
        function removerHistoricoGeral(nome, inicio, dias, registradoEm) {
            const idx = app.feriasLancadas.findIndex(f => f.nome === nome && f.inicio === inicio && f.dias === dias && f.registradoEm === registradoEm);
            if(idx >= 0) {
                app.feriasLancadas.splice(idx,1);
                localStorage.setItem('feriasHistorico', JSON.stringify(app.feriasLancadas));
                showToast('Lançamento removido.', 'success');
                abrirHistoricoGeral();
                renderTabelaFerias();
            }
        }

        // --- PONTO LOGIC COMPLETA ---
        async function carregarPlanilha() {
             if(!app.data.length) app.data = await fetchCSV();
             const sel = document.getElementById('servidorSelect');
             if(sel) {
                 const names = Array.from(new Set(app.data.map(r=>getField(r,['nome','servidor','funcionar','funcion','funcionario']).trim()).filter(Boolean))).sort();
                 sel.innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
                 if(sel.options.length>0 && sel.selectedIndex<0) sel.selectedIndex = 0;
             }
             const lista = document.getElementById('listaLote');
             const filtro = document.getElementById('filtroLote');
             if(lista) {
                 const names = Array.from(new Set(app.data.map(r=>getField(r,['nome','servidor','funcionar','funcion','funcionario']).trim()).filter(Boolean))).sort();
                 lista.innerHTML = names.map(n=>`<div>${n}</div>`).join('');
                 if(filtro) filtro.oninput = () => {
                     const q = filtro.value.toLowerCase();
                     lista.innerHTML = names.filter(n=>n.toLowerCase().includes(q)).map(n=>`<div>${n}</div>`).join('');
                 };
             }
             document.getElementById('carregarDadosBtn').onclick = preencherPonto;
             document.getElementById('mesSelect').onchange = preencherPonto;
             document.getElementById('anoSelect').onchange = preencherPonto;
        }

        function preencherPonto() {
             const sel = document.getElementById('servidorSelect');
             const nome = sel ? sel.value : document.getElementById('servidorNome').value;
             const row = app.data.find(r => getField(r, ['nome','servidor','funcionar','funcion','funcionario']) === nome);
             const mm = document.getElementById('mesSelect').value;
             const aa = document.getElementById('anoSelect').value;
             
             if(row) {
                 document.getElementById('inpNome').value = getField(row, ['nome','servidor','funcionar','funcion','funcionario']);
                 document.getElementById('inpMatricula').value = getField(row, ['matr']);
                 document.getElementById('inpCargo').value = getField(row, ['cargo']);
                 document.getElementById('inpVinculo').value = getField(row, ['vinc']) || 'Efetivo';
                 const unidadePersist = app.unidadesMap[nome];
                 document.getElementById('inpUnidade').value = unidadePersist || (getField(row, ['lotac','unidade']) || '');
             } else document.getElementById('inpNome').value = nome;
             
             app.currentServidor = nome;
             populateDaysTable(document.getElementById('daysTableBody'), mm, aa);
             showToast('Folha gerada!', 'success');
       }

        function populateDaysTable(tbody, mm, aa) {
            tbody.innerHTML = '';
            const diasNoMes = new Date(aa, Number(mm), 0).getDate();
            document.getElementById('labelMesAno').textContent = `${mm}/${aa}`;
            
            const feriadosSet = new Set(getHolidayISOList(parseInt(aa)).map(h=>h.date));
            
            for(let i=1; i<=31; i++) {
                const tr = document.createElement('tr');
                tr.style.height = "18px";
                let diaTexto = i, estilo = "", texto = "", editavel = `contenteditable="true"`, isSpecial = false;
                
                if (i <= diasNoMes) {
                    const data = new Date(aa, Number(mm)-1, i);
                    const diaSemana = data.getDay();
                    const keyIso = `${aa}-${String(mm).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    
                    const onVacation = isVacationDay(app.currentServidor, keyIso);
                    if(feriadosSet.has(keyIso)) {
                        isSpecial = true; estilo = "background-color: #ffe4e6; color: #991b1b; font-weight: bold; font-size: 9px;"; texto = "FERIADO";
                    } else if (onVacation) {
                        isSpecial = true; estilo = "background-color: #fde68a; color: #7c2d12; font-weight: bold; font-size: 9px;"; texto = "FÉRIAS";
                    } else if (diaSemana === 0 || diaSemana === 6) {
                        isSpecial = true; estilo = "background-color: #e5e7eb; color: #374151; font-weight: bold; font-size: 9px; letter-spacing:1px;";
                        texto = diaSemana === 6 ? "SÁBADO" : "DOMINGO";
                    }
                } else {
                    diaTexto = "—"; estilo = "background-color: #d1d5db;"; editavel = ""; isSpecial = true;
                }

                if (isSpecial) {
                    tr.innerHTML = `<td style="text-align: center; font-weight: bold;">${diaTexto}</td><td colspan="8" style="text-align: center; ${estilo}">${texto}</td>`;
                } else {
                    tr.innerHTML = `<td style="text-align: center; font-weight: bold;">${diaTexto}</td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td>`;
                }
                tbody.appendChild(tr);
            }
        }
        function isVacationDay(nome, iso) {
            if(!nome) return false;
            const list = app.feriasLancadas.filter(f => f.nome === nome);
            if(list.length === 0) return false;
            for(const f of list) {
                const s = new Date(f.inicio);
                const e = new Date(f.inicio); e.setDate(e.getDate() + parseInt(f.dias) - 1);
                const d = new Date(iso);
                if(d >= s && d <= e) return true;
            }
            return false;
        }
        function renderHolidayList() {
            const yearSel = document.getElementById('feriadosAnoSelect');
            const now = new Date();
            if(yearSel && yearSel.options.length===0) {
                for(let i=now.getFullYear()-1;i<=now.getFullYear()+2;i++) yearSel.innerHTML += `<option value="${i}" ${i===now.getFullYear()?'selected':''}>${i}</option>`;
            }
            const year = parseInt((yearSel && yearSel.value) || now.getFullYear());
            const chkN = document.getElementById('chkFerNacional');
            const chkE = document.getElementById('chkFerEstadual');
            const chkM = document.getElementById('chkFerMunicipal');
            if(chkN) chkN.checked = app.holidayConfig.nacional;
            if(chkE) chkE.checked = app.holidayConfig.estadual;
            if(chkM) chkM.checked = app.holidayConfig.municipal;
            const list = getHolidayISOList(year);
            const cont = document.getElementById('holidayListContainer');
            if(cont) cont.innerHTML = list.map(h=>`<div class="flex justify-between border-b py-1"><span>${new Date(h.date).toLocaleDateString('pt-BR')}</span><span class="font-bold">${h.nome}</span><span class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700">${h.tipo}</span></div>`).join('');
            const addBtn = document.getElementById('btnAddFeriado');
            if(addBtn) addBtn.onclick = () => {
                const d = document.getElementById('customFerData').value;
                const n = document.getElementById('customFerNome').value.trim();
                if(d && n) {
                    app.holidayConfig.custom.push({ date: d, nome: n });
                    localStorage.setItem('customHolidays', JSON.stringify(app.holidayConfig.custom));
                    renderHolidayList();
                    const tb = document.getElementById('daysTableBody');
                    const mm = document.getElementById('mesSelect').value;
                    const aa = document.getElementById('anoSelect').value;
                    if(tb && mm && aa) populateDaysTable(tb, mm, aa);
                }
            };
            if(yearSel) yearSel.onchange = () => renderHolidayList();
            if(chkN) chkN.onchange = () => { app.holidayConfig.nacional = chkN.checked; renderHolidayList(); const tb=document.getElementById('daysTableBody'); const mm=document.getElementById('mesSelect').value; const aa=document.getElementById('anoSelect').value; if(tb && mm && aa) populateDaysTable(tb, mm, aa); };
            if(chkE) chkE.onchange = () => { app.holidayConfig.estadual = chkE.checked; renderHolidayList(); const tb=document.getElementById('daysTableBody'); const mm=document.getElementById('mesSelect').value; const aa=document.getElementById('anoSelect').value; if(tb && mm && aa) populateDaysTable(tb, mm, aa); };
            if(chkM) chkM.onchange = () => { app.holidayConfig.municipal = chkM.checked; renderHolidayList(); const tb=document.getElementById('daysTableBody'); const mm=document.getElementById('mesSelect').value; const aa=document.getElementById('anoSelect').value; if(tb && mm && aa) populateDaysTable(tb, mm, aa); };
        }
        function getHolidayISOList(year) {
            const out = [];
            if(app.holidayConfig.nacional) out.push(...nacionalHolidays(year));
            if(app.holidayConfig.estadual) out.push(...maranhaoHolidays(year));
            if(app.holidayConfig.municipal) out.push(...saoLuisHolidays(year));
            if(app.holidayConfig.custom && app.holidayConfig.custom.length) out.push(...app.holidayConfig.custom.map(c=>({ date: c.date, nome: c.nome, tipo: 'Custom' })));
            return out;
        }
        function nacionalHolidays(year) {
            const fixed = [
                ['01-01','Confraternização Universal'],
                ['04-21','Tiradentes'],
                ['05-01','Dia do Trabalhador'],
                ['09-07','Independência do Brasil'],
                ['10-12','Nossa Senhora Aparecida'],
                ['11-02','Finados'],
                ['11-15','Proclamação da República'],
                ['12-25','Natal']
            ].map(([md,n])=>({ date: `${year}-${md}`, nome: n, tipo: 'Nacional' }));
            const easter = easterDate(year);
            const carnaval = addDays(easter, -47);
            const sextaSanta = addDays(easter, -2);
            const corpus = addDays(easter, 60);
            const mov = [
                { date: toISO(carnaval), nome: 'Carnaval', tipo: 'Nacional' },
                { date: toISO(sextaSanta), nome: 'Sexta-feira Santa', tipo: 'Nacional' },
                { date: toISO(easter), nome: 'Páscoa', tipo: 'Nacional' },
                { date: toISO(corpus), nome: 'Corpus Christi', tipo: 'Nacional' }
            ];
            return [...fixed, ...mov];
        }
        function maranhaoHolidays(year) {
            return [
                { date: `${year}-07-28`, nome: 'Adesão do Maranhão à Independência', tipo: 'Estadual' }
            ];
        }
        function saoLuisHolidays(year) {
            return [
                { date: `${year}-09-08`, nome: 'Aniversário de São Luís', tipo: 'Municipal' }
            ];
        }
        function easterDate(Y) {
            const a = Y % 19; const b = Math.floor(Y/100); const c = Y % 100;
            const d = Math.floor(b/4); const e = b % 4; const f = Math.floor((b+8)/25);
            const g = Math.floor((b - f + 1)/3); const h = (19*a + b - d - g + 15) % 30;
            const i = Math.floor(c/4); const k = c % 4; const L = (32 + 2*e + 2*i - h - k) % 7;
            const m = Math.floor((a + 11*h + 22*L)/451);
            const month = Math.floor((h + L - 7*m + 114)/31);
            const day = ((h + L - 7*m + 114) % 31) + 1;
            return new Date(Y, month-1, day);
        }
        function addDays(dt, n) { const d = new Date(dt); d.setDate(d.getDate()+n); return d; }
        function toISO(dt) { return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }
        
        // --- GERAR DOC FERIAS ---
        function gerarDocumentoFerias(nome) {
            const row = app.data.find(r => getField(r, ['nome','servidor']) === nome);
            const calc = calcularSaldo(nome, getField(row, ['admiss']));
            const ultimaFerias = app.feriasLancadas.filter(f => f.nome === nome).pop();
            let inicio = new Date(), dias = 30;
            if(ultimaFerias) { inicio = new Date(ultimaFerias.inicio); dias = ultimaFerias.dias; }
            else showToast('Data simulada (sem registro recente)', 'info');
            
            const fim = new Date(inicio); fim.setDate(fim.getDate() + dias - 1);
            
            document.getElementById('docNome').innerText = nome;
            document.getElementById('docMatricula').innerText = getField(row, ['matr'])||'---';
            document.getElementById('docLotacao').innerText = getField(row, ['lotac'])||'SEMCAS';
            document.getElementById('docPeriodoAquisitivo').innerText = calc.limite ? `${calc.limite.getFullYear()-1}/${calc.limite.getFullYear()}` : '2024/2025';
            document.getElementById('docDataInicio').innerText = inicio.toLocaleDateString('pt-BR');
            document.getElementById('docDataFim').innerText = fim.toLocaleDateString('pt-BR');
            document.getElementById('docDias').innerText = dias;
            
            const pc = document.getElementById('ferias-print-container');
            pc.classList.add('print-active');
            setTimeout(() => { window.print(); pc.classList.remove('print-active'); }, 200);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const selMes = document.getElementById('mesSelect'), selAno = document.getElementById('anoSelect');
            const now = new Date();
            ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m,i)=> selMes.innerHTML+=`<option value="${String(i+1).padStart(2,'0')}" ${i===now.getMonth()?'selected':''}>${m}</option>`);
            for(let i=now.getFullYear()-1; i<=now.getFullYear()+2; i++) selAno.innerHTML+=`<option value="${i}" ${i===now.getFullYear()?'selected':''}>${i}</option>`;
            
            router('home');
            fetchCSV().then(d => { app.data = d; });
        });

        // Simple Lote Print for Point (Short version for demo)
        window.imprimirLote = () => { printPonto(); }
        function printPonto() {
            const pc = document.getElementById('ponto-container');
            pc.classList.add('print-active');
            setTimeout(() => { window.print(); pc.classList.remove('print-active'); }, 200);
        }

    </script>
</body>
</html>
        function renderGestaoPessoas() {
            const allNames = Array.from(new Set(app.data.map(r=>getField(r,['nome','servidor','funcionar','funcion','funcionario']).trim()).filter(Boolean))).sort();
            const pendentes = allNames.filter(n => !app.unidadesMap[n]);
            const pendList = document.getElementById('gpPendentesList');
            const filtro = document.getElementById('gpFiltroNome');
            const unidadeInput = document.getElementById('gpUnidadeInput');
            const btnSalvar = document.getElementById('gpSalvarBtn');
            const renderPend = () => {
                const q = (filtro?.value || '').toLowerCase();
                pendList.innerHTML = pendentes
                    .filter(n => !q || n.toLowerCase().includes(q))
                    .map(n => `<label class="flex items-center gap-2 p-1"><input type="checkbox" class="accent-blue-600" value="${n}"><span>${n}</span></label>`)
                    .join('');
            };
            if(filtro) filtro.oninput = renderPend;
            renderPend();
            if(btnSalvar) btnSalvar.onclick = () => {
                const unidade = unidadeInput.value.trim();
                if(!unidade) return showToast('Informe a unidade', 'error');
                const checks = Array.from(pendList.querySelectorAll('input[type="checkbox"]:checked'));
                if(checks.length===0) return showToast('Selecione servidores', 'error');
                checks.forEach(ch => { app.unidadesMap[ch.value] = unidade; });
                localStorage.setItem('unidadesMap', JSON.stringify(app.unidadesMap));
                showToast(`Vinculados: ${checks.length}`, 'success');
                renderGestaoPessoas();
            };
            const unidadeSel = document.getElementById('gpUnidadeSelect');
            const vincList = document.getElementById('gpVinculadosList');
            const filtroV = document.getElementById('gpFiltroVinculados');
            const units = Array.from(new Set(Object.values(app.unidadesMap))).sort();
            if(unidadeSel) unidadeSel.innerHTML = units.map(u=>`<option value="${u}">${u}</option>`).join('');
            const renderVinc = () => {
                const unit = unidadeSel?.value || '';
                const q = (filtroV?.value || '').toLowerCase();
                const items = Object.entries(app.unidadesMap)
                    .filter(([n,u]) => (!unit || u===unit) && (!q || n.toLowerCase().includes(q)))
                    .sort((a,b) => a[0].localeCompare(b[0]));
                vincList.innerHTML = items.map(([n,u]) => `<div class="flex justify-between items-center border-b py-1"><div><span class="font-bold">${n}</span> <span class="text-xs">• ${u}</span></div><button class="text-xs px-2 py-1 border rounded hover:bg-gray-50" onclick="unlinkUnidade('${n}')">Desvincular</button></div>`).join('');
            };
            if(filtroV) filtroV.oninput = renderVinc;
            if(unidadeSel) unidadeSel.onchange = renderVinc;
            renderVinc();
            const btnGerar = document.getElementById('gpGerarFolhasBtn');
            if(btnGerar) btnGerar.onclick = () => { const unit = unidadeSel?.value || ''; if(unit) printFolhasUnidade(unit); else showToast('Selecione a unidade', 'error'); };
        }
        function unlinkUnidade(nome) {
            delete app.unidadesMap[nome];
            localStorage.setItem('unidadesMap', JSON.stringify(app.unidadesMap));
            renderGestaoPessoas();
        }
        function printFolhasUnidade(unit) {
            const names = Object.entries(app.unidadesMap).filter(([n,u]) => u===unit).map(([n])=>n);
            if(names.length===0) return showToast('Sem servidores na unidade', 'error');
            const mm = document.getElementById('mesSelect').value;
            const aa = document.getElementById('anoSelect').value;
            const container = document.getElementById('printContainer');
            container.innerHTML = '';
            names.forEach(nome => {
                const row = app.data.find(r => getField(r, ['nome','servidor','funcionar','funcion','funcionario']) === nome);
                if(row) {
                    document.getElementById('inpNome').value = nome;
                    document.getElementById('inpMatricula').value = getField(row, ['matr']);
                    document.getElementById('inpCargo').value = getField(row, ['cargo']);
                    document.getElementById('inpVinculo').value = getField(row, ['vinc']) || 'Efetivo';
                    document.getElementById('inpUnidade').value = app.unidadesMap[nome] || (getField(row, ['lotac','unidade']) || '');
                } else {
                    document.getElementById('inpNome').value = nome;
                    document.getElementById('inpMatricula').value = '';
                    document.getElementById('inpCargo').value = '';
                    document.getElementById('inpVinculo').value = '';
                    document.getElementById('inpUnidade').value = app.unidadesMap[nome] || '';
                }
                app.currentServidor = nome;
                populateDaysTable(document.getElementById('daysTableBody'), mm, aa);
                const clone = document.getElementById('mainPaper').cloneNode(true);
                container.appendChild(clone);
            });
            container.classList.add('print-active');
            setTimeout(() => { window.print(); container.classList.remove('print-active'); container.innerHTML=''; }, 200);
        }

<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Portal de Recursos Humanos da SEMCAS - São Luís">
    <title>Portal RH - SEMCAS São Luís</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        semcas: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- ESTILOS GERAIS E ANIMAÇÕES --- */
        body { font-family: 'Inter', sans-serif; }
        
        /* Transições suaves para dark mode */
        body, .bg-white, .bg-gray-50, .text-gray-800 {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* --- FOLHA DE PONTO (A4 - FÍSICO) --- */
        /* Estas variáveis definem o papel. No Dark Mode, o papel CONTINUA branco para simular impressão real */
        :root {
            --bg-paper: #fff;
            --color-text-paper: #000;
            --border-paper: #000;
            --input-focus-paper: #e8f0fe;
            --gray-header-paper: #e5e7eb;
        }

        .page-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px 0;
            overflow-x: auto;
            perspective: 1000px;
        }

        .page {
            width: 210mm;
            min-width: 210mm;
            height: 297mm;
            background: var(--bg-paper);
            color: var(--color-text-paper);
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: 0 auto;
            font-family: Arial, Helvetica, sans-serif; /* Fonte padrão para documentos oficiais */
            position: relative;
            transform-style: preserve-3d;
        }

        /* Tabelas da Folha */
        .folha-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 2px solid var(--border-paper);
            margin-bottom: 0;
        }

        .folha-table td, .folha-table th {
            border: 1px solid var(--border-paper);
            padding: 2px 4px;
            font-size: 11px;
            vertical-align: middle;
            color: var(--color-text-paper);
            overflow: hidden;
            white-space: nowrap;
        }

        /* Inputs Editáveis na Folha */
        .input-linha {
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            font-family: inherit;
            font-size: 11px;
            font-weight: bold;
            width: 100%;
            outline: none;
            color: var(--color-text-paper);
            transition: border-bottom-color 0.2s;
        }
        .input-linha:focus { border-bottom-color: #000; background-color: rgba(59, 130, 246, 0.1); }

        td[contenteditable="true"] { cursor: text; transition: background-color 0.2s; }
        td[contenteditable="true"]:focus { background-color: var(--input-focus-paper); outline: 2px solid #3b82f6; outline-offset: -2px; z-index: 10; position: relative;}
        td[contenteditable="true"]:hover { background-color: #f9fafb; }

        /* Estilos Visuais Internos da Folha */
        .bg-gray-folha { background-color: var(--gray-header-paper) !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .bg-white-header { background-color: #fff !important; font-weight: bold; text-align: center; }
        .bg-white-cell { background-color: #fff !important; }
        .titulo-folha { font-size: 14px; font-weight: bold; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; }
        .label-folha { font-size: 10px; color: #333; text-transform: uppercase; }
        .valor-folha { font-weight: bold; font-size: 11px; padding-left: 5px; }

        /* Assinaturas */
        .footer-table { margin-top: -1px; border-top: none; width: 100%; border-collapse: collapse; }
        .box-assinatura { height: 90px; vertical-align: top; padding: 5px; position: relative; width: 50%; border: 1px solid black; }
        .linha-assinatura { border-bottom: 1px solid black; width: 80%; position: absolute; bottom: 35px; left: 10%; }
        .data-assinatura { position: absolute; bottom: 5px; left: 10px; font-size: 11px; width: 90%; display: flex; align-items: center; gap: 2px; }
        .input-data-short { width: 25px; border: none; border-bottom: 1px solid #000; text-align: center; font-family: inherit; font-size: inherit; background: transparent; }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s ease-out; 
            display: flex; align-items: center; gap: 10px; min-width: 250px;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }

        /* --- PRINT STYLES (CRUCIAL) --- */
        @media print {
            header, .no-print, #ponto-controls, #content, #toast-container, .theme-toggle { display: none !important; }
            body, html { margin: 0; padding: 0; background: #fff !important; color: #000 !important; }
            #ponto-container { display: block !important; }
            .page-wrapper { display: block; width: 100%; padding: 0; margin: 0; overflow: visible; perspective: none; }
            .page { 
                margin: 0; border: none; box-shadow: none; width: 100%; height: 297mm; padding: 10mm; 
                page-break-after: always; transform: none;
            }
            .input-linha { border-bottom: none; }
            td[contenteditable="true"] { outline: none; background-color: transparent !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Reset Dark Mode for Print */
            .dark body { background-color: #fff !important; color: #000 !important; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Hero Image Aspect Ratio Fixes */
        .hero-banner { width: 100%; object-fit: cover; aspect-ratio: 3 / 1; }
        @media (max-width: 640px) { .hero-banner { aspect-ratio: 2 / 1; } }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- CABEÇALHO -->
    <header class="sticky top-0 z-50 bg-semcas-600 dark:bg-gray-800 text-white shadow-lg transition-colors duration-300 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                <!-- Logo -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-building-columns text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold leading-tight tracking-wide">Portal RH</h1>
                            <p class="text-xs text-blue-100 opacity-90">SEMCAS - São Luís</p>
                        </div>
                    </div>
                    <!-- Theme Toggle (Mobile) -->
                    <button onclick="toggleTheme()" class="md:hidden p-2 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline text-yellow-300"></i>
                    </button>
                </div>

                <!-- Menu e Ações -->
                <div class="flex items-center gap-4 mt-3 md:mt-0 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                    <nav class="flex-grow" aria-label="Navegação principal">
                        <ul class="flex space-x-1 sm:space-x-2 text-sm whitespace-nowrap">
                            <li><button onclick="router('home')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="home"><i class="fas fa-home"></i> Início</button></li>
                            <li><button onclick="router('ferias')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="ferias"><i class="fas fa-umbrella-beach"></i> Férias</button></li>
                            <li><button onclick="router('ponto')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2 font-semibold" data-target="ponto"><i class="fas fa-clock"></i> Folha</button></li>
                            <li><button onclick="router('processos')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="processos"><i class="fas fa-folder-open"></i> Processos</button></li>
                            <li><button onclick="router('noticias')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="noticias"><i class="fas fa-newspaper"></i> Notícias</button></li>
                            <li><button onclick="router('sugestoes')" class="nav-btn px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2" data-target="sugestoes"><i class="fas fa-lightbulb"></i> Ideias</button></li>
                        </ul>
                    </nav>
                    
                    <!-- Theme Toggle (Desktop) -->
                    <button onclick="toggleTheme()" class="hidden md:block p-2 rounded-lg hover:bg-white/10 transition ml-2" title="Alternar tema">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline text-yellow-300"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="flex-grow w-full max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
        
        <!-- View: HOME -->
        <div id="home-view" class="view-section hidden animate-fade-in">
            <!-- Banner -->
            <div class="rounded-2xl overflow-hidden shadow-lg mb-6 ring-1 ring-black/5 relative group">
                <img
                  id="bannerPrincipal"
                  src="Gemini_Generated_Image_ufn1hnufn1hnufn1.png"
                  alt="Recursos Humanos - SEMCAS"
                  class="hero-banner transition transform group-hover:scale-[1.01] duration-700"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6 md:p-10">
                    <div class="text-white">
                        <h2 class="text-3xl font-bold mb-2">Bem-vindo ao Portal do Servidor</h2>
                        <p class="opacity-90 max-w-2xl text-sm md:text-base">Centralize suas demandas de RH, emita folhas de ponto e acompanhe seus processos administrativos com agilidade.</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Card 1 -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 p-3 rounded-lg">
                            <i class="fas fa-bullhorn text-xl"></i>
                        </div>
                        <span class="text-xs font-bold bg-blue-50 dark:bg-gray-700 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full">Avisos</span>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Últimos Comunicados</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400" id="home-aviso-texto">Carregando avisos...</p>
                </div>

                <!-- Card 2 -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 p-3 rounded-lg">
                            <i class="fas fa-calendar-check text-xl"></i>
                        </div>
                        <span class="text-xs font-bold bg-green-50 dark:bg-gray-700 text-green-700 dark:text-green-300 px-2 py-1 rounded-full">Agenda</span>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Próximo Feriado</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400" id="home-feriado-texto">Consultando calendário...</p>
                </div>

                <!-- Card 3 -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 p-3 rounded-lg">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <button onclick="router('ponto')" class="text-xs font-bold text-purple-600 hover:underline">Acessar</button>
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white mb-1">Acesso Rápido</h3>
                    <div class="flex gap-2 mt-2">
                        <button onclick="router('ponto')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 rounded-lg transition">Gerar Folha</button>
                        <button onclick="router('ferias')" class="flex-1 border border-purple-200 dark:border-purple-800 text-purple-600 dark:text-purple-400 text-xs font-bold py-2 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition">Férias</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: FÉRIAS ROBUSTAS -->
        <div id="ferias-view" class="view-section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Controle de Férias</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Monitoramento de períodos aquisitivos e prazos legais.</p>
                </div>
                <button onclick="carregarFerias()" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition flex items-center gap-2 shadow-sm">
                    <i class="fas fa-sync-alt" id="icon-refresh-ferias"></i> Atualizar Dados
                </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-100 dark:border-red-800/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider">Vencidas</span>
                            <div class="text-3xl font-bold text-red-700 dark:text-red-400 mt-1" id="count-vencida">0</div>
                        </div>
                        <i class="fas fa-exclamation-circle text-red-200 dark:text-red-800 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-800/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider">Crítico</span>
                            <div class="text-3xl font-bold text-orange-700 dark:text-orange-400 mt-1" id="count-critico">0</div>
                        </div>
                        <i class="fas fa-stopwatch text-orange-200 dark:text-orange-800 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-100 dark:border-yellow-800/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-yellow-600 dark:text-yellow-400 uppercase tracking-wider">Atenção</span>
                            <div class="text-3xl font-bold text-yellow-700 dark:text-yellow-400 mt-1" id="count-atencao">0</div>
                        </div>
                        <i class="fas fa-calendar-day text-yellow-200 dark:text-yellow-800 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider">Regular</span>
                            <div class="text-3xl font-bold text-blue-700 dark:text-blue-400 mt-1" id="count-emdia">0</div>
                        </div>
                        <i class="fas fa-check-circle text-blue-200 dark:text-blue-800 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Filtros e Tabela -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700 flex flex-col lg:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto flex-grow">
                        <div class="relative flex-grow">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            <input id="filtroFerias" oninput="renderTabelaFerias()" placeholder="Buscar servidor..." class="pl-9 w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-gray-700 dark:text-white">
                        </div>
                        <select id="filtroStatusFerias" onchange="renderTabelaFerias()" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="todos">Todos os Status</option>
                            <option value="vencida">Vencidas</option>
                            <option value="critico">Críticas (< 60d)</option>
                            <option value="atencao">Atenção (< 90d)</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2 w-full lg:w-auto">
                         <div class="relative group">
                            <i class="fas fa-cog text-gray-400 cursor-pointer hover:text-gray-600 dark:hover:text-gray-300 transition p-2"></i>
                            <div class="absolute right-0 top-8 bg-white dark:bg-gray-800 p-3 shadow-xl rounded-lg border dark:border-gray-700 w-72 hidden group-hover:block z-20">
                                <label class="text-xs font-bold text-gray-500 mb-1 block">Fonte de Dados (CSV URL)</label>
                                <input id="sheetUrlInput" class="w-full text-xs border rounded p-1 mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <button class="w-full bg-blue-600 text-white text-xs py-1 rounded" onclick="salvarSheetUrl()">Salvar URL</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">Servidor</th>
                                <th class="px-4 py-3 hidden md:table-cell">Lotação</th>
                                <th class="px-4 py-3 hidden sm:table-cell">Admissão</th>
                                <th class="px-4 py-3">Limite</th>
                                <th class="px-4 py-3 text-center">Dias Rest.</th>
                                <th class="px-4 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-ferias-body" class="divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800">
                            <!-- JS preenche -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                <div class="p-3 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                    <div id="feriasPageInfo">Página 1</div>
                    <div class="flex gap-2">
                        <button id="feriasPrevBtn" class="px-3 py-1 rounded border hover:bg-white dark:hover:bg-gray-700 disabled:opacity-50" onclick="feriasPrev()">Ant</button>
                        <button id="feriasNextBtn" class="px-3 py-1 rounded border hover:bg-white dark:hover:bg-gray-700 disabled:opacity-50" onclick="feriasNext()">Próx</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: PROCESSOS (SEI) -->
        <div id="processos-view" class="view-section hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white border-b dark:border-gray-700 pb-2 flex items-center gap-2">
                <i class="fas fa-folder-open text-blue-500"></i> Acompanhamento SEI
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Formulário -->
                <div class="md:col-span-1 bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border dark:border-gray-700 h-fit">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Novo Processo
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Número SEI</label>
                            <input id="procNumero" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="00000.000000/0000-00">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Título/Assunto</label>
                            <input id="procTitulo" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Progressão Funcional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Data de Abertura</label>
                            <input id="procData" type="date" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button id="btnSalvarProc" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md mt-2">
                            Cadastrar
                        </button>
                    </div>
                </div>

                <!-- Lista -->
                <div class="md:col-span-2">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-4">Meus Processos</h3>
                    <div id="listaProcessos" class="space-y-3">
                        <!-- JS Populate -->
                    </div>
                </div>
            </div>
        </div>

        <!-- View: NOTÍCIAS -->
        <div id="noticias-view" class="view-section hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white border-b dark:border-gray-700 pb-2">Mural de Notícias</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border dark:border-blue-800/30">
                        <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-3 text-sm">Publicar Aviso</h3>
                        <input id="newsTitulo" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm mb-2 dark:bg-gray-700 dark:text-white" placeholder="Título">
                        <input id="newsResumo" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm mb-2 dark:bg-gray-700 dark:text-white" placeholder="Resumo curto">
                        <textarea id="newsConteudo" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm mb-2 h-24 dark:bg-gray-700 dark:text-white" placeholder="Conteúdo completo..."></textarea>
                        <div class="flex items-center gap-2 mb-3">
                            <input id="newsPublicado" type="checkbox" class="accent-blue-600 rounded">
                            <label for="newsPublicado" class="text-sm text-gray-700 dark:text-gray-300 select-none">Exibir na Home</label>
                        </div>
                        <button id="btnSalvarNews" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">Salvar Notícia</button>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-4" id="listaNoticias">
                    <!-- JS populate -->
                </div>
            </div>
        </div>

        <!-- View: SUGESTÕES -->
        <div id="sugestoes-view" class="view-section hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
             <div class="max-w-2xl mx-auto text-center py-10">
                <div class="bg-yellow-100 dark:bg-yellow-900/30 inline-flex p-4 rounded-full mb-4 text-yellow-600 dark:text-yellow-400">
                    <i class="fas fa-lightbulb text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Banco de Ideias</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Ajude a modernizar o RH da SEMCAS. Estas são as melhorias já mapeadas para as próximas versões do sistema.</p>
                
                <ul class="text-left bg-gray-50 dark:bg-gray-900/50 p-6 rounded-xl space-y-3 border dark:border-gray-700">
                    <li class="flex items-start gap-3"><i class="fas fa-check text-green-500 mt-1"></i> <span>SSO (Login único) para servidores.</span></li>
                    <li class="flex items-start gap-3"><i class="fas fa-check text-green-500 mt-1"></i> <span>Dashboard de férias com envio automático de e-mail.</span></li>
                    <li class="flex items-start gap-3"><i class="fas fa-check text-green-500 mt-1"></i> <span>Integração via API com o SEI.</span></li>
                    <li class="flex items-start gap-3"><i class="fas fa-check text-green-500 mt-1"></i> <span>Exportação de relatórios em PDF/Excel nativo.</span></li>
                </ul>
            </div>
        </div>

        <!-- View: PONTO (Ferramenta Principal) -->
        <div id="ponto-container" class="view-section hidden pb-20">
            
            <!-- CONTROLES -->
            <div id="ponto-controls" class="no-print bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6 sticky top-20 z-40 transition-colors">
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                            <i class="fas fa-print text-blue-600 dark:text-blue-400"></i> Gerador de Folha de Frequência
                        </h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Configure, preencha e imprima. O layout A4 é mantido na impressão.</p>
                    </div>
                    <button onclick="window.print()" class="bg-gray-800 dark:bg-gray-700 text-white px-5 py-2.5 rounded-lg font-bold hover:bg-gray-900 dark:hover:bg-gray-600 transition shadow flex items-center gap-2 border dark:border-gray-600">
                        <i class="fas fa-print"></i> Imprimir Folha
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4 overflow-x-auto">
                    <button onclick="switchTab('folha')" id="tab-btn-folha" class="tab-btn whitespace-nowrap px-4 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600 dark:text-blue-400">Individual</button>
                    <button onclick="switchTab('lote')" id="tab-btn-lote" class="tab-btn whitespace-nowrap px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 border-b-2 border-transparent">Lote (Múltiplos)</button>
                    <button onclick="switchTab('feriados')" id="tab-btn-feriados" class="tab-btn whitespace-nowrap px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 border-b-2 border-transparent">Configurar Feriados</button>
                </div>
                
                <!-- Tab: Individual -->
                <div id="tab-folha" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg border dark:border-gray-700">
                        <div class="md:col-span-5 relative">
                            <label class="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Buscar Servidor</label>
                            <i class="fas fa-search absolute left-3 top-8 text-gray-400"></i>
                            <input id="servidorNome" list="servidoresList" class="w-full pl-9 border dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:bg-gray-700 dark:text-white" placeholder="Digite o nome...">
                            <datalist id="servidoresList"></datalist>
                        </div>
                        <div class="md:col-span-2">
                            <button id="carregarDadosBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition text-sm shadow-sm">
                                <i class="fas fa-check"></i> Preencher
                            </button>
                        </div>
                        <div class="md:col-span-5 flex gap-2">
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Mês</label>
                                <select id="mesSelect" class="w-full border dark:border-gray-600 rounded-lg px-2 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white"></select>
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Ano</label>
                                <select id="anoSelect" class="w-full border dark:border-gray-600 rounded-lg px-2 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Lote -->
                <div id="tab-lote" class="tab-content hidden">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800/30">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-sm text-blue-800 dark:text-blue-300">Seleção Múltipla para Impressão</h3>
                            <span id="contadorLote" class="text-xs bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full font-bold">0 selecionados</span>
                        </div>
                        <input id="filtroLote" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm mb-3 dark:bg-gray-700 dark:text-white" placeholder="Filtrar lista...">
                        <div id="listaLote" class="h-40 overflow-y-auto bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-2 space-y-1 text-sm">
                            <!-- JS Populates -->
                        </div>
                        <div class="flex gap-3 mt-3 border-t dark:border-gray-600 pt-3">
                            <button onclick="selecionarTodosLote()" class="text-xs font-bold text-blue-600 dark:text-blue-400 hover:underline">Selecionar Todos</button>
                            <button onclick="limparLote()" class="text-xs font-bold text-red-600 dark:text-red-400 hover:underline">Limpar Seleção</button>
                        </div>
                    </div>
                    <button onclick="imprimirLote()" class="w-full mt-3 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition shadow flex justify-center items-center gap-2">
                        <i class="fas fa-layer-group"></i> Gerar e Imprimir Lote
                    </button>
                </div>

                <!-- Tab: Feriados -->
                <div id="tab-feriados" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-lg border dark:border-gray-700 shadow-sm">
                            <div class="flex justify-between items-center mb-2 border-b dark:border-gray-700 pb-2">
                                <h3 class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Calendário Oficial</h3>
                                <select id="feriadosAnoSelect" class="border dark:border-gray-600 rounded px-2 py-1 text-xs dark:bg-gray-700 dark:text-white"></select>
                            </div>
                            <div id="listaFeriadosOficiais" class="h-40 overflow-y-auto space-y-1 text-xs text-gray-600 dark:text-gray-300 scrollbar-thin"></div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-gray-900 p-3 rounded-lg border dark:border-gray-700">
                            <h3 class="font-bold text-xs uppercase text-blue-600 dark:text-blue-400 mb-2">Adicionar Manualmente</h3>
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <input id="dataExtra" type="text" placeholder="DD/MM/AAAA" class="border dark:border-gray-600 rounded px-2 py-1 text-sm w-1/3 dark:bg-gray-700 dark:text-white text-center">
                                    <input id="nomeExtra" type="text" placeholder="Descrição do evento..." class="border dark:border-gray-600 rounded px-2 py-1 text-sm w-2/3 dark:bg-gray-700 dark:text-white">
                                </div>
                                <div class="flex items-center gap-2">
                                    <select id="tipoExtra" class="border dark:border-gray-600 rounded px-2 py-1 text-sm w-full dark:bg-gray-700 dark:text-white">
                                        <option value="feriado">Feriado (Vermelho)</option>
                                        <option value="facultativo">Ponto Facultativo (Amarelo)</option>
                                    </select>
                                    <button onclick="addFeriadoManual()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="listaExtras" class="mt-2 space-y-1 max-h-24 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- PAPEL A4 (VISUALIZAÇÃO) -->
            <div class="page-wrapper no-print:mt-4">
                <div class="page" id="mainPaper">
                    
                    <!-- 1. DADOS CADASTRAIS -->
                    <table class="folha-table">
                        <tr>
                            <td class="bg-gray-folha titulo-folha" style="width: 70%;">REGISTRO INDIVIDUAL DE FREQUÊNCIA</td>
                            <td class="bg-white-cell" style="width: 30%;">
                                <span class="label-folha">Mês / Ano:</span> 
                                <span id="labelMesAno" class="valor-folha" style="font-size: 13px;">NOVEMBRO/2025</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="bg-white-cell text-center">
                                <span class="label-folha">Órgão Municipal:</span> 
                                <span style="font-weight: bold; font-size: 11px;">Secretaria Municipal da Criança e Assistência Social/ SEMCAS</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg-white-cell" style="border-right: none;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Nome:</span> 
                                    <input type="text" id="inpNome" class="input-linha" placeholder="...">
                                </div>
                            </td>
                            <td class="bg-white-cell" style="width: 25%; border-left: 1px solid #000;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="margin-right: 5px;">Matrícula:</span> 
                                    <input type="text" id="inpMatricula" class="input-linha" style="width: 80px;">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg-white-cell" style="border-right: none;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Cargo/Função:</span> 
                                    <input type="text" id="inpCargo" class="input-linha" placeholder="...">
                                </div>
                            </td>
                            <td class="bg-white-cell" style="border-left: 1px solid #000;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="margin-right: 5px;">Vínculo:</span> 
                                    <input type="text" id="inpVinculo" class="input-linha" style="width: 90px;">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="bg-white-cell">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Unidade Administrativa:</span> 
                                    <input type="text" id="inpUnidade" class="input-linha" value="SEMCAS">
                                </div>
                            </td>
                        </tr>
                    </table>
        
                    <!-- 2. TABELA DE PONTO -->
                    <table class="folha-table" style="margin-top: -1px;">
                        <colgroup>
                            <col class="col-dia">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                        </colgroup>
                        <thead>
                            <tr class="bg-white-header">
                                <th rowspan="3">Dia</th>
                                <th colspan="8">Horário de Trabalho</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="4">Manhã</th>
                                <th colspan="4">Tarde</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>08:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>12:00</th>
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>14:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>18:00</th>
                            </tr>
                            <tr class="bg-gray-folha">
                                <th></th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                            </tr>
                        </thead>
                        <tbody id="daysTableBody"></tbody>
                    </table>
        
                    <!-- 3. RODAPÉ ASSINATURAS -->
                    <table class="footer-table">
                        <tr>
                            <td class="box-assinatura">
                                <div style="font-weight: bold; font-size: 11px;">Chefia Imediata:</div>
                                <div class="linha-assinatura"></div>
                                <div class="data-assinatura">
                                    São Luís, 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short">
                                </div>
                            </td>
                            <td class="box-assinatura">
                                <div style="font-weight: bold; font-size: 11px;">Visto (Área de Recursos Humanos):</div>
                                <div class="linha-assinatura"></div>
                                <div class="data-assinatura">
                                    São Luís, 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Hidden Container for Batch Print -->
            <div id="printContainer" class="hidden"></div>
        </div>

        <!-- MODAL DETALHE PROCESSO -->
        <div id="procDetalheModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-2xl p-6 shadow-2xl border dark:border-gray-700 animate-scale-in">
                <div class="flex justify-between items-center mb-4 border-b dark:border-gray-700 pb-3">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">Detalhes do Processo</h3>
                    <button onclick="fecharProcDetalhe()" class="text-gray-400 hover:text-red-500 transition text-xl"><i class="fas fa-times"></i></button>
                </div>
                <div id="procDetalheConteudo" class="text-sm dark:text-gray-300"></div>
            </div>
        </div>
    </main>

    <script>
        // ====================================================================
        // UTILITÁRIOS E UI
        // ====================================================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            
            toast.innerHTML = `<i class="fas fa-${icon} text-lg"></i> <span>${message}</span>`;
            container.appendChild(toast);
            
            // Trigger animation
            requestAnimationFrame(() => toast.classList.add('show'));
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Theme Manager
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Initialize Theme
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // ====================================================================
        // DADOS E ESTADO
        // ====================================================================
        let SHEET_CSV_URL = localStorage.getItem('sheetCsvUrl') || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSETVY6MUfwwl_TWax9qyqLXYzY3yZSuhPIQj16hHu-EhhdVYpyYnp81NOcM3akDQ/pub?output=csv';

        // ... (Logic for EasterDate/Holidays kept same, just organized) ...
        function easterDate(year) {
            const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), month = Math.floor((h + l - 7 * m + 114) / 31), day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
        }
        function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
        function keyISO(d) { return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function pad2(n) { return String(n).padStart(2, '0'); }

        function getHolidayMap(year) {
            const map = new Map();
            const push = (y,m,d,nome,tipo='feriado') => map.set(`${y}-${pad2(m)}-${pad2(d)}`, { nome, tipo });
            push(year,1,1,'Confraternização Universal');
            push(year,4,21,'Tiradentes');
            push(year,5,1,'Dia do Trabalho');
            push(year,9,7,'Independência do Brasil');
            push(year,10,12,'N. Sra. Aparecida');
            push(year,11,2,'Finados');
            push(year,11,15,'Proclamação da República');
            push(year,12,25,'Natal');
            push(year,11,20,'Consciência Negra');
            
            const easter = easterDate(year);
            map.set(keyISO(addDays(easter,-2)), { nome: 'Sexta-feira da Paixão', tipo: 'feriado' });
            map.set(keyISO(addDays(easter,60)), { nome: 'Corpus Christi', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-48)), { nome: 'Carnaval (Segunda)', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-47)), { nome: 'Carnaval (Terça)', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-46)), { nome: 'Quarta-feira de Cinzas', tipo: 'facultativo' });
            
            push(year,7,28,'Adesão do Maranhão (MA)');
            push(year,6,29,'Dia de São Pedro (SLZ)');
            push(year,9,8,'Aniversário de São Luís (SLZ)');
            push(year,12,8,'N. Sra. da Conceição (SLZ)');
            return map;
        }

        let appState = {
            registros: [],
            extrasMap: new Map(),
            loteSelecionados: new Set(),
            listaNomesCache: [],
            feriasDados: [],
            processos: [],
            noticias: []
        };

        // ====================================================================
        // NAVEGAÇÃO
        // ====================================================================
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => { 
                el.classList.remove('bg-white/20', 'font-bold', 'shadow-inner'); 
                el.classList.add('opacity-70');
            });
            
            const target = document.getElementById(view === 'home' ? 'home-view' : 
                                                 view === 'ferias' ? 'ferias-view' :
                                                 view === 'processos' ? 'processos-view' :
                                                 view === 'noticias' ? 'noticias-view' : 
                                                 view === 'sugestoes' ? 'sugestoes-view' : 'ponto-container');
            if(target) {
                target.classList.remove('hidden');
                window.scrollTo(0,0);
            }

            const btn = document.querySelector(`button[data-target="${view}"]`);
            if(btn) { 
                btn.classList.add('bg-white/20', 'font-bold', 'shadow-inner'); 
                btn.classList.remove('opacity-70');
            }

            if(view === 'ponto') carregarPlanilha();
            if(view === 'ferias') carregarFerias();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                el.classList.add('border-transparent', 'text-gray-500');
            });

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tab}`);
            btn.classList.remove('border-transparent', 'text-gray-500');
            btn.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
            if(tab === 'feriados') renderFeriadosTab();
        }

        // ====================================================================
        // LÓGICA DE DADOS (CSV)
        // ====================================================================
        function parseCSV(text) {
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            const lines = text.split(/\r?\n/).filter(l => l.trim().length);
            if (!lines.length) return [];
            const headerLine = lines[0];
            const delim = (headerLine.match(/;/g)||[]).length > (headerLine.match(/,/g)||[]).length ? ';' : ',';

            function splitLine(line) {
                const res = []; let cur = ''; let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
                        else { inQuotes = !inQuotes; }
                    } else if (ch === delim && !inQuotes) { res.push(cur); cur = ''; } 
                    else { cur += ch; }
                }
                res.push(cur);
                return res.map(c => c.trim().replace(/^"|"$/g, ''));
            }

            const headers = splitLine(lines[0]).map(h => h.trim());
            return lines.slice(1).map(line => {
                const cols = splitLine(line);
                const obj = {}; headers.forEach((h, i) => obj[h] = (cols[i]||'').trim());
                return obj;
            });
        }

        function getField(row, patterns) {
            const keys = Object.keys(row||{});
            const norm = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
            for (const key of keys) {
                const nk = norm(key);
                for (const p of patterns) {
                    if ((typeof p === 'string' && nk.includes(norm(p))) || (p instanceof RegExp && p.test(nk))) return row[key];
                }
            }
            return '';
        }

        async function carregarPlanilha() {
            if(appState.registros.length > 0) return;
            
            // UI Feedback
            const btn = document.getElementById('carregarDadosBtn');
            const originalText = btn ? btn.innerHTML : '';
            if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';

            try {
                let resp;
                try { resp = await fetch(SHEET_CSV_URL, { cache: 'no-store' }); } 
                catch (e) { resp = await fetch(`https://cors.isomorphic-git.org/${SHEET_CSV_URL}`, { cache: 'no-store' }); }
                
                const csv = await resp.text();
                appState.registros = parseCSV(csv);
                
                const unicos = new Set();
                appState.listaNomesCache = [];
                appState.registros.forEach(r => {
                    const nome = getField(r, [/funcion[aá]rio/, /servidor/, /nome/]);
                    if(nome && !unicos.has(nome)) { unicos.add(nome); appState.listaNomesCache.push(nome); }
                });
                appState.listaNomesCache.sort();

                const dl = document.getElementById('servidoresList');
                if(dl) { dl.innerHTML = ''; appState.listaNomesCache.forEach(n => { const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); }); }
                renderListaLote();
                
                showToast(`${appState.listaNomesCache.length} servidores carregados com sucesso!`, 'success');

            } catch(e) { 
                console.error(e); 
                showToast('Erro ao carregar planilha. Verifique a URL CSV.', 'error'); 
            } finally {
                if(btn) btn.innerHTML = originalText;
            }
        }

        // ====================================================================
        // LÓGICA DE FÉRIAS
        // ====================================================================
        async function carregarFerias() {
            const refreshIcon = document.getElementById('icon-refresh-ferias');
            if(refreshIcon) refreshIcon.classList.add('fa-spin');
            
            await carregarPlanilha();
            
            const hoje = new Date();
            appState.feriasDados = [];
            let stats = { vencida: 0, critico: 0, atencao: 0, emdia: 0 };

            appState.registros.forEach(r => {
                const nome = getField(r, [/funcion[aá]rio/, /servidor/, /nome/]);
                const lotacao = getField(r, [/lota[cç][aã]o/, /unidade/]) || 'SEMCAS';
                const admissaoStr = getField(r, [/admiss[aã]o/, /data.*admiss/]);
                
                if(!nome || !admissaoStr) return;

                const parts = admissaoStr.split('/');
                if (parts.length !== 3) return;
                let y = parseInt(parts[2]); if(y < 100) y += 2000;
                const admissaoData = new Date(y, parseInt(parts[1]) - 1, parseInt(parts[0]));

                if (isNaN(admissaoData.getTime())) return;

                let anosTrabalhados = hoje.getFullYear() - admissaoData.getFullYear();
                const aniversarioEsteAno = new Date(hoje.getFullYear(), admissaoData.getMonth(), admissaoData.getDate());
                if (hoje < aniversarioEsteAno) anosTrabalhados--;

                const fimPeriodo = new Date(admissaoData);
                fimPeriodo.setFullYear(fimPeriodo.getFullYear() + anosTrabalhados);
                const limite = new Date(fimPeriodo);
                limite.setFullYear(limite.getFullYear() + 1);

                const diasRestantes = Math.ceil((limite - hoje) / (1000 * 60 * 60 * 24)); 
                let status = 'emdia';
                if (diasRestantes < 0) status = 'vencida';
                else if (diasRestantes < 60) status = 'critico';
                else if (diasRestantes < 90) status = 'atencao';

                stats[status]++;
                appState.feriasDados.push({ nome, lotacao, admissao: admissaoStr, limite: limite.toLocaleDateString('pt-BR'), diasRestantes, status });
            });

            ['vencida', 'critico', 'atencao', 'emdia'].forEach(k => document.getElementById(`count-${k}`).textContent = stats[k]);
            renderTabelaFerias();
            
            if(refreshIcon) refreshIcon.classList.remove('fa-spin');
        }

        function renderTabelaFerias() {
            const tbody = document.getElementById('tabela-ferias-body');
            tbody.innerHTML = '';
            const filtroNome = document.getElementById('filtroFerias').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatusFerias').value;
            const dados = [...appState.feriasDados].sort((a, b) => a.diasRestantes - b.diasRestantes);
            
            const filtrados = dados.filter(i => (filtroStatus === 'todos' || i.status === filtroStatus) && (!filtroNome || i.nome.toLowerCase().includes(filtroNome)));
            
            const PAGE_SIZE = 50;
            if(!appState.feriasPage) appState.feriasPage = 1;
            const totalPages = Math.max(1, Math.ceil(filtrados.length / PAGE_SIZE));
            if(appState.feriasPage > totalPages) appState.feriasPage = totalPages;
            
            const pageItems = filtrados.slice((appState.feriasPage - 1) * PAGE_SIZE, appState.feriasPage * PAGE_SIZE);

            pageItems.forEach(item => {
                let badgeClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
                let label = 'EM DIA';
                if(item.status === 'vencida') { badgeClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'; label = 'VENCIDA'; }
                else if(item.status === 'critico') { badgeClass = 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300'; label = 'CRÍTICO'; }
                else if(item.status === 'atencao') { badgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'; label = 'ATENÇÃO'; }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-gray-100">${item.nome}</td>
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400 hidden md:table-cell">${item.lotacao}</td>
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400 hidden sm:table-cell">${item.admissao}</td>
                        <td class="px-4 py-3 text-gray-700 dark:text-gray-300 font-bold">${item.limite}</td>
                        <td class="px-4 py-3 font-bold ${item.diasRestantes < 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'} text-center">${item.diasRestantes}</td>
                        <td class="px-4 py-3 text-center"><span class="${badgeClass} text-xs px-2 py-1 rounded-full font-bold">${label}</span></td>
                    </tr>`;
            });
            document.getElementById('feriasPageInfo').textContent = `Página ${appState.feriasPage} de ${totalPages}`;
            document.getElementById('feriasPrevBtn').disabled = appState.feriasPage <= 1;
            document.getElementById('feriasNextBtn').disabled = appState.feriasPage >= totalPages;
        }

        window.feriasPrev = () => { if(appState.feriasPage>1){ appState.feriasPage--; renderTabelaFerias(); } };
        window.feriasNext = () => { appState.feriasPage++; renderTabelaFerias(); };
        window.salvarSheetUrl = () => {
            const url = document.getElementById('sheetUrlInput').value.trim();
            if(url) { localStorage.setItem('sheetCsvUrl', url); SHEET_CSV_URL = url; appState.registros=[]; carregarFerias(); showToast('URL salva!', 'success'); }
        };

        // ====================================================================
        // PONTO & IMPRESSÃO
        // ====================================================================
        function populateDaysTable(tbody, mm, aa) {
            tbody.innerHTML = '';
            const diasNoMes = new Date(aa, Number(mm), 0).getDate();
            const nomeMes = ['JANEIRO','FEVEREIRO','MARÇO','ABRIL','MAIO','JUNHO','JULHO','AGOSTO','SETEMBRO','OUTUBRO','NOVEMBRO','DEZEMBRO'][Number(mm)-1];
            document.getElementById('labelMesAno').textContent = `${nomeMes}/${aa}`;

            const map = getHolidayMap(Number(aa));
            
            for(let i=1; i<=31; i++) {
                const tr = document.createElement('tr');
                tr.style.height = "18px";
                let diaTexto = i, estilo = "", texto = "", editavel = `contenteditable="true"`, isSpecial = false;

                if (i <= diasNoMes) {
                    const data = new Date(aa, Number(mm)-1, i);
                    const diaSemana = data.getDay();
                    const keyIso = keyISO(data);
                    
                    let feriado = map.get(keyIso) || appState.extrasMap.get(keyIso);
                    
                    if (feriado) {
                        isSpecial = true;
                        const isRed = feriado.tipo === 'feriado';
                        estilo = isRed ? "background-color: #ffe4e6; color: #991b1b;" : "background-color: #fef9c3; color: #854d0e;";
                        texto = `${feriado.tipo.toUpperCase()}: ${feriado.nome.toUpperCase()}`;
                    } else if (diaSemana === 0 || diaSemana === 6) {
                        isSpecial = true;
                        estilo = "background-color: #e5e7eb; color: #374151; letter-spacing: 1px;";
                        texto = diaSemana === 6 ? "SÁBADO" : "DOMINGO";
                    }
                } else {
                    diaTexto = "—"; estilo = "background-color: #d1d5db;"; editavel = ""; isSpecial = true;
                }

                if (isSpecial) {
                    tr.innerHTML = `<td style="text-align: center; font-weight: bold;">${diaTexto}</td><td colspan="8" style="text-align: center; font-weight: bold; font-size: 9px; ${estilo}">${texto}</td>`;
                } else {
                    tr.innerHTML = `<td style="text-align: center; font-weight: bold;">${diaTexto}</td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td>`;
                }
                tbody.appendChild(tr);
            }
        }

        function preencherIndividual() {
            const nome = document.getElementById('servidorNome').value;
            if(!nome) return showToast('Selecione um servidor.', 'error');
            
            const mm = document.getElementById('mesSelect').value;
            const aa = document.getElementById('anoSelect').value;
            const row = appState.registros.find(r => getField(r, [/nome/, /funcion/]) === nome);
            
            const root = document.getElementById('mainPaper');
            if(row) {
                root.querySelector('#inpNome').value = getField(row, [/nome/, /funcion/]);
                root.querySelector('#inpMatricula').value = getField(row, [/matr/]);
                root.querySelector('#inpCargo').value = getField(row, [/cargo/]);
                root.querySelector('#inpUnidade').value = getField(row, [/lota/]) || 'SEMCAS';
                root.querySelector('#inpVinculo').value = getField(row, [/vinc/]) || 'Efetivo';
            } else {
                root.querySelector('#inpNome').value = nome;
            }
            populateDaysTable(root.querySelector('#daysTableBody'), mm, aa);
            showToast('Folha gerada com sucesso!', 'success');
        }

        // Lote Logic
        function renderListaLote() {
            const div = document.getElementById('listaLote');
            if(!div) return;
            const filtro = (document.getElementById('filtroLote').value || '').toLowerCase();
            let html = '';
            appState.listaNomesCache.filter(n => n.toLowerCase().includes(filtro)).forEach(nome => {
                const checked = appState.loteSelecionados.has(nome) ? 'checked' : '';
                html += `<div class="flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded"><input type="checkbox" id="chk-${nome}" value="${nome}" ${checked} onchange="toggleLote(this)" class="accent-blue-600"><label for="chk-${nome}" class="truncate cursor-pointer text-gray-700 dark:text-gray-300 select-none">${nome}</label></div>`;
            });
            div.innerHTML = html;
            document.getElementById('contadorLote').textContent = `${appState.loteSelecionados.size} selecionados`;
        }
        window.toggleLote = (chk) => { appState.loteSelecionados[chk.checked ? 'add':'delete'](chk.value); document.getElementById('contadorLote').textContent = `${appState.loteSelecionados.size} selecionados`; };
        window.selecionarTodosLote = () => { const f = document.getElementById('filtroLote').value.toLowerCase(); appState.listaNomesCache.filter(n=>n.toLowerCase().includes(f)).forEach(n=>appState.loteSelecionados.add(n)); renderListaLote(); };
        window.limparLote = () => { appState.loteSelecionados.clear(); renderListaLote(); };
        window.imprimirLote = () => {
            if(!appState.loteSelecionados.size) return showToast('Selecione ao menos um servidor!', 'error');
            const container = document.getElementById('printContainer');
            container.innerHTML = '';
            const mm = document.getElementById('mesSelect').value, aa = document.getElementById('anoSelect').value;
            
            showToast(`Gerando ${appState.loteSelecionados.size} folhas...`, 'info');
            
            appState.loteSelecionados.forEach(nome => {
                const clone = document.getElementById('mainPaper').cloneNode(true);
                clone.id = ''; clone.style.pageBreakAfter = 'always';
                const row = appState.registros.find(r => getField(r, [/nome/]) === nome);
                if(row) {
                    clone.querySelector('#inpNome').value = nome;
                    clone.querySelector('#inpMatricula').value = getField(row, [/matr/]);
                    clone.querySelector('#inpCargo').value = getField(row, [/cargo/]);
                    clone.querySelector('#inpUnidade').value = getField(row, [/lota/]) || 'SEMCAS';
                    clone.querySelector('#inpVinculo').value = getField(row, [/vinc/]) || 'Efetivo';
                } else clone.querySelector('#inpNome').value = nome;
                populateDaysTable(clone.querySelector('#daysTableBody'), mm, aa);
                container.appendChild(clone);
            });
            
            document.getElementById('mainPaper').parentElement.classList.add('hidden');
            container.classList.remove('hidden');
            setTimeout(() => { window.print(); document.getElementById('mainPaper').parentElement.classList.remove('hidden'); container.classList.add('hidden'); container.innerHTML = ''; }, 500);
        };

        // Feriados Tab
        function renderFeriadosTab() {
            const y = Number(document.getElementById('feriadosAnoSelect').value);
            const map = getHolidayMap(y);
            let html = '';
            Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0])).forEach(([k,v]) => {
                const [_,m,d] = k.split('-');
                const cor = v.tipo === 'feriado' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50';
                html += `<div class="flex justify-between border-b dark:border-gray-700 py-1"><span>${d}/${m} - ${v.nome}</span> <span class="text-[10px] uppercase font-bold px-1 rounded ${cor}">${v.tipo}</span></div>`;
            });
            document.getElementById('listaFeriadosOficiais').innerHTML = html;
        }
        window.addFeriadoManual = () => {
            const data = document.getElementById('dataExtra').value, nome = document.getElementById('nomeExtra').value, tipo = document.getElementById('tipoExtra').value;
            if(!data || !nome) return;
            const [d,m,y] = data.split('/');
            appState.extrasMap.set(`${y}-${m}-${d}`, {nome, tipo});
            localStorage.setItem('extrasMap', JSON.stringify(Object.fromEntries(appState.extrasMap)));
            renderListaExtras(); showToast('Feriado adicionado!', 'success');
        };
        function renderListaExtras() {
            const div = document.getElementById('listaExtras'); div.innerHTML = '';
            appState.extrasMap.forEach((v,k) => {
                const [y,m,d] = k.split('-');
                div.innerHTML += `<div class="text-xs p-1 border rounded flex justify-between items-center ${v.tipo==='feriado'?'bg-red-50 text-red-700':'bg-yellow-50 text-yellow-700'}"><span>${d}/${m} - ${v.nome}</span> <button onclick="rmExtra('${k}')" class="font-bold hover:text-black">x</button></div>`;
            });
        }
        window.rmExtra = (k) => { appState.extrasMap.delete(k); localStorage.setItem('extrasMap', JSON.stringify(Object.fromEntries(appState.extrasMap))); renderListaExtras(); };

        // ====================================================================
        // CRUD SIMPLIFICADO (Processos/Noticias)
        // ====================================================================
        function initCrud() {
            // Processos
            const savedProc = localStorage.getItem('processos');
            if(savedProc) appState.processos = JSON.parse(savedProc);
            renderProcessos();
            document.getElementById('btnSalvarProc').onclick = () => {
                const numero = document.getElementById('procNumero').value;
                const titulo = document.getElementById('procTitulo').value;
                const data = document.getElementById('procData').value;
                if(!numero || !titulo) return showToast('Preencha os campos obrigatórios', 'error');
                appState.processos.push({numero, titulo, data, notas:[]});
                localStorage.setItem('processos', JSON.stringify(appState.processos));
                renderProcessos(); showToast('Processo salvo!', 'success');
                document.getElementById('procNumero').value = ''; document.getElementById('procTitulo').value = '';
            };

            // Notícias
            const savedNews = localStorage.getItem('noticias');
            if(savedNews) appState.noticias = JSON.parse(savedNews);
            renderNoticias();
            document.getElementById('btnSalvarNews').onclick = () => {
                const titulo = document.getElementById('newsTitulo').value;
                const resumo = document.getElementById('newsResumo').value;
                const conteudo = document.getElementById('newsConteudo').value;
                if(!titulo) return showToast('Preencha o título', 'error');
                appState.noticias.push({titulo, resumo, conteudo, publicado: document.getElementById('newsPublicado').checked, data: new Date().toISOString()});
                localStorage.setItem('noticias', JSON.stringify(appState.noticias));
                renderNoticias(); showToast('Notícia publicada!', 'success');
            };
        }

        function renderProcessos() {
            const div = document.getElementById('listaProcessos'); div.innerHTML = '';
            if(!appState.processos.length) div.innerHTML = '<div class="text-center text-gray-400 py-4">Nenhum processo.</div>';
            appState.processos.forEach((p, i) => {
                div.innerHTML += `<div class="bg-white dark:bg-gray-700 p-3 rounded-lg border dark:border-gray-600 shadow-sm flex justify-between items-center"><div><div class="font-bold text-gray-800 dark:text-white">${p.titulo}</div><div class="text-xs text-gray-500 dark:text-gray-400">${p.numero}</div></div><button onclick="delProc(${i})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
            });
        }
        window.delProc = (i) => { if(confirm('Excluir?')) { appState.processos.splice(i,1); localStorage.setItem('processos', JSON.stringify(appState.processos)); renderProcessos(); } };

        function renderNoticias() {
            const div = document.getElementById('listaNoticias'); div.innerHTML = '';
            appState.noticias.forEach((n, i) => {
                div.innerHTML += `<div class="bg-gray-50 dark:bg-gray-700 p-3 rounded border dark:border-gray-600"><div class="font-bold text-gray-800 dark:text-white">${n.titulo}</div><div class="text-sm text-gray-600 dark:text-gray-300">${n.resumo}</div><div class="text-right mt-2"><button onclick="delNews(${i})" class="text-xs text-red-500 underline">Remover</button></div></div>`;
            });
            
            // Home updates
            const ult = appState.noticias.filter(n=>n.publicado).pop();
            if(ult) document.getElementById('home-aviso-texto').textContent = ult.titulo + ' - ' + ult.resumo;
            else document.getElementById('home-aviso-texto').textContent = "Sem avisos recentes.";
        }
        window.delNews = (i) => { if(confirm('Excluir?')) { appState.noticias.splice(i,1); localStorage.setItem('noticias', JSON.stringify(appState.noticias)); renderNoticias(); } };

        // ====================================================================
        // INIT
        // ====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Dates
            const selMes = document.getElementById('mesSelect'), selAno = document.getElementById('anoSelect'), selFer = document.getElementById('feriadosAnoSelect');
            const now = new Date();
            ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m,i) => selMes.innerHTML+=`<option value="${pad2(i+1)}" ${i===now.getMonth()?'selected':''}>${m}</option>`);
            for(let i=now.getFullYear()-1; i<=now.getFullYear()+2; i++) {
                const opt = `<option value="${i}" ${i===now.getFullYear()?'selected':''}>${i}</option>`;
                selAno.innerHTML += opt; selFer.innerHTML += opt;
            }
            
            document.getElementById('carregarDadosBtn').onclick = preencherIndividual;
            document.getElementById('mesSelect').onchange = preencherIndividual;
            document.getElementById('anoSelect').onchange = preencherIndividual;
            document.getElementById('feriadosAnoSelect').onchange = renderFeriadosTab;
            
            // Extra Data
            try { const map = JSON.parse(localStorage.getItem('extrasMap')); if(map) Object.entries(map).forEach(([k,v]) => appState.extrasMap.set(k,v)); renderListaExtras(); } catch {}
            
            // Home Holiday
            const nextH = Array.from(getHolidayMap(now.getFullYear()).entries()).find(([k]) => k >= keyISO(now));
            if(nextH) { const [y,m,d] = nextH[0].split('-'); document.getElementById('home-feriado-texto').textContent = `${d}/${m} - ${nextH[1].nome}`; }

            initCrud();
            router('home');
        });
    </script>
</body>
</html>

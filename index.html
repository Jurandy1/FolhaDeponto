<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal RH - SEMCAS S√£o Lu√≠s</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* Estilos base do portal */
        body { font-family: 'Inter', sans-serif; background-color: #f8f8f8; }
        .bg-semcas { background-color: #007bff; } /* Cor prim√°ria: Azul */

        /* --- Estilos do Gerador de Ponto (Importados do arquivo base) --- */
        @page { size: A4; margin: 0; }
        .paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 20px auto;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .paper table { width: 100%; border-collapse: collapse !important; border-spacing: 0; }
        .paper th, .paper td { border: 1px solid #000 !important; padding: 2px 4px; font-size: 11px; vertical-align: middle; }
        .paper input { width: 100%; border: none; background: transparent; font-family: inherit; font-size: inherit; outline: none; }
        .section-header { background-color: #e5e5e5 !important; font-weight: 700; text-align: center; padding: 4px; font-size: 12px; border-bottom: 1px solid #000 !important; border-top: 1px solid #000 !important; }
        .borda-fixa { border: 1px solid #000 !important; }
        .borda-b { border-bottom: 1px solid #000 !important; }
        .borda-r { border-right: 1px solid #000 !important; }

        @media print {
            .no-print { display: none !important; }
            body { margin: 0; padding: 0; background: #ffffff !important; }
            .paper { margin: 0; width: 210mm !important; height: 297mm !important; padding: 10mm !important; box-shadow: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .paper th, .paper td { border: 0.6pt solid #000 !important; background: #ffffff !important; }
        }
        /* Fim dos estilos do Gerador de Ponto */
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Cabe√ßalho e Navega√ß√£o -->
        <header class="sticky top-0 z-50 shadow-lg bg-semcas text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-col md:flex-row justify-between items-center">
                
                <!-- Logo e T√≠tulo -->
                <div class="flex items-center space-x-3">
                    <img src="https://placehold.co/40x40/ffffff/007bff?text=SLZ" 
                         alt="Logo da Prefeitura de S√£o Lu√≠s"
                         class="h-10 w-10 rounded-full border border-white p-1"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/333333?text=SLZ'"
                    >
                    <h1 class="text-xl font-bold">Portal RH | SEMCAS - S√£o Lu√≠s</h1>
                </div>
                
                <!-- Menu Principal -->
                <nav class="mt-3 md:mt-0">
                    <ul class="flex space-x-2 sm:space-x-6 text-sm md:text-base">
                        <li><a href="#home" class="nav-link p-2 rounded-md hover:bg-blue-600 transition" data-view="home">In√≠cio</a></li>
                        <li class="group relative">
                            <a href="#funcionarios" class="nav-link p-2 rounded-md hover:bg-blue-600 transition" data-view="funcionarios">Funcion√°rios <i class="fas fa-caret-down text-xs ml-1"></i></a>
                            <ul class="absolute hidden group-hover:block bg-white text-gray-800 shadow-xl rounded-lg w-48 mt-1 z-10 transition duration-300 overflow-hidden border">
                                <li><a href="#ferias" class="nav-link block px-4 py-2 hover:bg-gray-100" data-view="ferias">F√©rias (Pr√≥ximos)</a></li>
                                <li><a href="#ponto" class="nav-link block px-4 py-2 hover:bg-gray-100" data-view="ponto">Gerar Ponto</a></li>
                            </ul>
                        </li>
                        <li><a href="#processos" class="nav-link p-2 rounded-md hover:bg-blue-600 transition" data-view="processos">Processos (SEI)</a></li>
                        <li><a href="#documentacao" class="nav-link p-2 rounded-md hover:bg-blue-600 transition" data-view="documentacao">Documenta√ß√£o</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- √Årea de Conte√∫do Principal -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <div id="content" class="bg-white p-6 rounded-lg shadow-xl min-h-[60vh]">
                <!-- O conte√∫do da view atual ser√° renderizado aqui -->
            </div>
        </main>

        <!-- RODAP√â (Opcional) -->
        <footer class="bg-gray-100 text-center py-4 text-xs text-gray-500 mt-auto">
            ¬© 2025 SEMCAS - Secretaria Municipal da Crian√ßa e Assist√™ncia Social. Desenvolvido para RH.
        </footer>

        <!-- VISTAS / TEMPLATES ESPEC√çFICOS -->

        <!-- 1. Conte√∫do da view 'ponto' (Gerador de Ponto - Componente Complexo) -->
        <div id="ponto-container" class="hidden">
            <!-- Barra de controle (no-print) do Gerador de Ponto -->
            <div id="ponto-controls" class="no-print fixed top-16 left-0 w-full bg-blue-100 text-gray-800 p-4 shadow-md z-40 border-b">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-lg font-bold">üõ†Ô∏è Ferramenta Geradora de Folha de Ponto</h2>
                    <button id="imprimirBtnPonto" onclick="window.print()" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 transition shadow">
                        <i class="fas fa-print"></i> Imprimir P√°gina
                    </button>
                </div>
                <div class="mt-3 flex gap-2">
                    <button id="btnTabFolha" class="tab-button-ponto px-3 py-1 rounded bg-white text-blue-600 font-bold shadow hover:bg-gray-100">Folha</button>
                    <button id="btnTabFeriados" class="tab-button-ponto px-3 py-1 rounded bg-blue-500 text-white font-bold shadow hover:bg-blue-400">Feriados</button>
                    <button id="btnTabLote" class="tab-button-ponto px-3 py-1 rounded bg-blue-500 text-white font-bold shadow hover:bg-blue-400">Impress√£o em Lote</button>
                </div>
                <div class="mt-3">
                    <!-- Aba Folha -->
                    <div id="tabFolha" class="space-y-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <input id="servidorNome" list="servidoresList" class="text-black text-sm px-2 py-1 rounded border border-gray-300 w-full sm:w-64" placeholder="Digite o nome do servidor e pressione Enter">
                            <datalist id="servidoresList"></datalist>
                            <button id="carregarDadosBtn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded hover:bg-blue-700 transition shadow">Gerar folha</button>
                            <div class="flex items-center gap-2">
                                <label class="text-xs opacity-80 text-gray-700">M√™s da folha:</label>
                                <select id="mesFolhaMesSelect" class="text-black text-sm px-2 py-1 rounded border">
                                    <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option><option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option><option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                                </select>
                                <select id="mesFolhaAnoSelect" class="text-black text-sm px-2 py-1 rounded border"></select>
                                <input id="mesFolhaInput" type="hidden">
                            </div>
                        </div>
                    </div>
                    <!-- Aba Feriados (conte√∫do oculto por padr√£o) -->
                    <div id="tabFeriados" class="space-y-3 hidden mt-3 bg-white p-3 rounded-lg shadow-inner max-h-[80vh] overflow-y-auto">
                        <div class="font-bold text-sm text-gray-800">Gerenciamento de Feriados para <span id="calHeader" class="text-blue-600"></span></div>
                        <!-- Filtros e Catalogo -->
                        <div class="bg-gray-50 border rounded-lg shadow-sm p-3 space-y-3">
                            <div class="flex items-center gap-2 flex-wrap text-xs">
                                <button id="buscarFeriadosBtn" class="bg-green-600 text-white font-bold py-1 px-3 rounded hover:bg-green-700 transition">Carregar cat√°logo (nacionais + SLZ)</button>
                                <label class="flex items-center gap-1 text-gray-700"><input id="toggleNat" type="checkbox" checked> Nacionais</label>
                                <label class="flex items-center gap-1 text-gray-700"><input id="toggleEstMa" type="checkbox" checked> Estaduais (MA)</label>
                                <label class="flex items-center gap-1 text-gray-700"><input id="toggleMunSlz" type="checkbox" checked> Municipais (S√£o Lu√≠s)</label>
                            </div>
                            <div id="catalogoFeriadosMes" class="space-y-1 text-gray-700 max-h-32 overflow-y-auto"></div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <label class="text-xs opacity-80 text-gray-700">Adicionar PF:</label>
                                <select id="pfDiaSelect" class="text-black text-sm px-2 py-1 rounded border"></select>
                                <input id="pfNomeInput" type="text" class="text-black text-sm px-2 py-1 rounded border w-64" value="Ponto Facultativo">
                                <button id="adicionarPFBtn" class="bg-purple-600 text-white font-bold py-1 px-3 rounded hover:bg-purple-700 transition">Adicionar PF</button>
                            </div>
                        </div>
                        <!-- Feriados Manuais -->
                        <div class="bg-gray-50 border rounded-lg shadow-sm p-3 space-y-3">
                            <div class="font-bold text-sm text-gray-800">Feriados Manuais e Importa√ß√£o</div>
                            <div class="flex items-center flex-wrap gap-2">
                                <input id="feriadoDataInput" type="text" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}" placeholder="dd/mm/aaaa" class="text-black text-sm px-2 py-1 rounded border w-32">
                                <input id="feriadoNomeInput" type="text" class="text-black text-sm px-2 py-1 rounded border w-48" placeholder="Nome do feriado">
                                <button id="adicionarFeriadoBtn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded hover:bg-blue-700 transition">Adicionar Manual</button>
                            </div>
                            <textarea id="feriadosInput" rows="4" class="text-black text-sm px-2 py-1 rounded border w-full" placeholder="Importar (opcional): cada linha no formato 'dd/mm/aaaa - Nome'"></textarea>
                            <div class="flex justify-between items-center">
                                <button id="aplicarFeriadosBtn" class="bg-green-600 text-white font-bold py-1 px-3 rounded hover:bg-green-700 transition">Aplicar Feriados (Manuais/Importados)</button>
                            </div>
                            <div id="listaFeriados" class="space-y-1 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div id="calendarioFeriados" class="grid grid-cols-7 gap-1 text-xs sm:text-sm p-3 border rounded-lg bg-white"></div>
                    </div>
                    <!-- Aba Lote (conte√∫do oculto por padr√£o) -->
                    <div id="tabLote" class="space-y-2 hidden mt-3 bg-white p-3 rounded-lg shadow-inner">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <input id="multiSearch" class="border px-2 py-1 text-sm w-96 text-black rounded" placeholder="Filtrar nomes">
                            <button id="selecionarTodosBtn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded hover:bg-blue-700 transition shadow">Selecionar todos</button>
                            <button id="limparSelecaoBtn" class="bg-red-600 text-white font-bold py-1 px-3 rounded hover:bg-red-700 transition shadow">Limpar sele√ß√£o</button>
                            <span id="multiCount" class="text-xs opacity-90 text-gray-700">Selecionados: 0</span>
                            <button id="imprimirLoteBtn" class="bg-green-600 text-white font-bold py-1 px-3 rounded hover:bg-green-700 transition shadow">Gerar e Imprimir Lote</button>
                        </div>
                        <div id="multiSelectList" class="bg-gray-50 text-black rounded shadow max-h-64 overflow-auto p-3 space-y-1 border"></div>
                    </div>
                </div>
            </div>

            <!-- Formul√°rio/Folha de Ponto A4 (Vis√≠vel na tela, mas escondido ao exibir outras views) -->
            <div id="ponto-paper-view" class="mt-28">
                <div class="paper" id="mainPaper">
                    <!-- T√≠tulo -->
                    <div class="flex justify-center items-end mb-2 font-bold text-lg uppercase">
                        <span class="mr-2">FOLHA DE PONTO | M√äS/ANO:</span>
                        <input type="text" class="border-b border-black w-48 text-center font-bold"
                               placeholder="EX: 01/2024"
                               style="border-bottom: 1px solid #000 !important;">
                    </div>

                    <!-- Conte√∫do principal -->
                    <div class="borda-fixa">

                        <!-- DADOS DO SERVIDOR -->
                        <div class="section-header borda-b">DADOS DO SERVIDOR</div>

                        <div class="text-xs">
                            <div class="flex borda-b">
                                <div class="w-1/5 flex p-1 borda-r items-center"><span class="font-bold mr-1">Lota√ß√£o:</span><input type="text" name="lotacao"></div>
                                <div class="w-1/5 flex p-1 borda-r items-center"><span class="font-bold mr-1">Matricula:</span><input type="text" name="matricula"></div>
                                <div class="w-3/5 flex p-1 items-center"><span class="font-bold mr-1">Funcion√°rio:</span><input type="text" name="funcionario" style="width: 100%;"></div>
                            </div>
                            <div class="flex borda-b">
                                <div class="w-1/5 flex p-1 borda-r items-center"><span class="font-bold mr-1">Ano:</span><input type="text" name="ano"></div>
                                <div class="w-1/5 flex p-1 borda-r items-center"><span class="font-bold mr-1">M√™s:</span><input type="text" name="mes"></div>
                                <div class="w-2/5 flex p-1 borda-r items-center"><span class="font-bold mr-1">Cargo Origem:</span><input type="text" name="cargo_origem"></div>
                                <div class="w-1/5 flex p-1 items-center"><span class="font-bold mr-1">Horas Semanais:</span><input type="text" name="horas_semanais"></div>
                            </div>
                            <div class="flex borda-b">
                                <div class="w-1/2 flex p-1 borda-r items-center"><span class="font-bold mr-1">CPF:</span><input type="text" name="cpf"></div>
                                <div class="w-1/2 flex p-1 items-center"><span class="font-bold mr-1">Admiss√£o:</span><input type="text" name="admissao" placeholder="dd/mm/aaaa"></div>
                            </div>
                        </div>

                        <!-- Hor√°rio Contratado -->
                        <div class="flex borda-b text-xs">
                            <div class="w-1/5 p-1 font-bold borda-r flex items-center bg-gray-100">Hor√°rio de trabalho contratado</div>
                            <div class="w-4/5 flex">
                                <div class="w-1/4 p-1 borda-r"><span class="block text-center mb-1 font-bold">Entrada:</span><input type="text" class="text-center" value="08:00"></div>
                                <div class="w-1/4 p-1 borda-r"><span class="block text-center mb-1 font-bold">Sa√≠da/almo√ßo:</span><input type="text" class="text-center" value="12:00"></div>
                                <div class="w-1/4 p-1 borda-r"><span class="block text-center mb-1 font-bold">Retorno/almo√ßo:</span><input type="text" class="text-center" value="13:00"></div>
                                <div class="w-1/4 p-1"><span class="block text-center mb-1 font-bold">Sa√≠da:</span><input type="text" class="text-center" value="17:00"></div>
                            </div>
                        </div>

                        <!-- Tabela de Dias -->
                        <table class="text-center w-full">
                            <thead>
                                <tr class="bg-gray-100 font-bold text-[10px] uppercase">
                                    <th class="w-8">Dia<br>M√™s</th>
                                    <th class="w-16">Entrada</th><th class="w-16">In√≠cio<br>Intervalo</th><th class="w-16">Fim<br>Intervalo</th><th class="w-16">Sa√≠da</th>
                                    <th class="w-24">Rubrica</th><th class="w-16">Hora<br>Extra</th><th class="w-10">Visto</th>
                                </tr>
                            </thead>
                            <tbody id="daysTableBody"></tbody>
                        </table>
                    </div>
                    <!-- Assinatura -->
                    <div class="mt-4 text-xs">
                        <div class="flex items-end">
                            <span class="mr-2">Assinatura do empregado:</span>
                            <div class="flex-grow h-4" style="border-bottom: 1px solid #000;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container tempor√°rio para impress√£o em lote -->
            <div id="printContainer" class="hidden"></div>
        </div>
    </div>

    <script>
        // ====================================================================
        // VARI√ÅVEIS GLOBAIS, CONSTANTES E SETUP
        // ====================================================================
        let appState = {
            // Inicializa com 'home' para evitar erros de leitura de hash em ambientes restritos (como iframe/blob)
            currentView: 'home', 
            registros: [],
            registroPorNome: new Map(),
            selectedNames: new Set(),
            feriadosMap: new Map(), // feriados do texto importado
            feriadosMapUI: new Map(), // feriados adicionados pela UI
            mockProcesses: [],
        };

        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjyCxbgnAsHpVZsAzU_VzGi7D-TXnaPciKUWudnp5thY6N53R8laj-aWB8IF_pQPCTevKdOro8rGAM/pub?output=csv';
        const PONTO_DOM_IDS = {
            servidorNome: 'servidorNome', carregarDadosBtn: 'carregarDadosBtn', mesFolhaInput: 'mesFolhaInput',
            mesFolhaMesSelect: 'mesFolhaMesSelect', mesFolhaAnoSelect: 'mesFolhaAnoSelect', daysTableBody: 'daysTableBody',
            tabFolha: 'tabFolha', tabFeriados: 'tabFeriados', tabLote: 'tabLote',
            btnTabFolha: 'btnTabFolha', btnTabFeriados: 'btnTabFeriados', btnTabLote: 'btnTabLote',
            multiSearch: 'multiSearch', selecionarTodosBtn: 'selecionarTodosBtn', limparSelecaoBtn: 'limparSelecaoBtn',
            multiCount: 'multiCount', imprimirLoteBtn: 'imprimirLoteBtn', multiList: 'multiSelectList',
            feriadosInput: 'feriadosInput', aplicarFeriadosBtn: 'aplicarFeriadosBtn', buscarFeriadosBtn: 'buscarFeriadosBtn',
            calendarioFeriados: 'calendarioFeriados', calHeader: 'calHeader', feriadoDataInput: 'feriadoDataInput',
            feriadoNomeInput: 'feriadoNomeInput', adicionarFeriadoBtn: 'adicionarFeriadoBtn', listaFeriados: 'listaFeriados',
            toggleNat: 'toggleNat', toggleEstMa: 'toggleEstMa', toggleMunSlz: 'toggleMunSlz',
            catalogoFeriadosMes: 'catalogoFeriadosMes', pfDiaSelect: 'pfDiaSelect', pfNomeInput: 'pfNomeInput',
            adicionarPFBtn: 'adicionarPFBtn',
        };

        // ====================================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // ====================================================================
        function pad2(n) { return String(n).padStart(2, '0'); }
        function parseCSVLine(line) {
            const out = [];
            let cur = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
                } else if (ch === ',' && !inQuotes) { out.push(cur); cur = ''; } else { cur += ch; }
            }
            out.push(cur);
            return out.map(s => s.trim().replace(/^"|"$/g, '').trim());
        }
        function parseCSV(text) {
            const raw = text.replace(/^\uFEFF/, '');
            const lines = raw.split(/\r?\n/).filter(l => l.trim().length);
            if (!lines.length) return [];
            const headers = parseCSVLine(lines[0]).map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                const obj = {};
                headers.forEach((h, idx) => obj[h] = cols[idx] || '');
                rows.push(obj);
            }
            return rows;
        }
        function excelSerialToDate(serialNumber) {
            const base = new Date(Date.UTC(1899, 11, 30));
            const days = Math.floor(serialNumber);
            const ms = days * 24 * 60 * 60 * 1000;
            return new Date(base.getTime() + ms);
        }
        function formatDateToBR(val) {
            const s = String(val || '').trim();
            if (!s) return '';
            let serialCandidate = null;
            // Tenta serial de Excel (n√∫meros com ou sem pontua√ß√£o/v√≠rgula)
            if (/^\d{1,3}(\.\d{3})+(,\d+)?$|^\d+(?:[\.,]\d+)$|^\d+$/.test(s)) {
                const cleaned = s.replace(/\./g, '').replace(',', '.');
                serialCandidate = parseFloat(cleaned);
            }
            if (serialCandidate !== null && !isNaN(serialCandidate) && serialCandidate > 10000) { // Assume que um n√∫mero > 10000 √© um serial de data
                const d = excelSerialToDate(serialCandidate);
                if (!isNaN(d.getTime())) {
                    return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
                }
            }
            // Tenta dd/mm/aaaa ou yyyy-mm-dd
            const parts = s.split(/[^0-9]/).filter(Boolean);
            if (parts.length >= 3) {
                const [p1, p2, p3] = parts.slice(0, 3);
                if (p1.length === 4) { // yyyy, mm, dd
                    return `${pad2(Number(p3))}/${pad2(Number(p2))}/${Number(p1)}`;
                } else { // Assume padr√£o BR dd/mm/aa(aa)
                    const aa = p3.length === 2 ? 2000 + Number(p3) : Number(p3);
                    return `${pad2(Number(p1))}/${pad2(Number(p2))}/${aa}`;
                }
            }
            return s; // Retorna string original como fallback
        }
        function normaliza(s) { return String(s || '').trim().toLowerCase(); }
        function nomeMesPT(m) {
            const nomes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            return nomes[m-1] || '';
        }

        // ====================================================================
        // L√ìGICA DE DADOS - SERVIDORES (GOOGLE SHEETS)
        // ====================================================================
        async function carregarPlanilha() {
            try {
                const resp = await fetch(SHEET_CSV_URL);
                const csv = await resp.text();
                appState.registros = parseCSV(csv);

                const nomes = appState.registros
                    .map(r => (r['Funcion√°rio'] || r['Funcionario'] || '').trim())
                    .filter(Boolean);

                // Mapa de nome -> registro e lista de nomes √∫nicos
                appState.registroPorNome.clear();
                const unicos = [];
                const seen = new Set();
                appState.registros.forEach(r => {
                    const nome = (r['Funcion√°rio'] || r['Funcionario'] || '').trim();
                    const nomeKey = nome.toLowerCase();
                    if (nomeKey) {
                        appState.registroPorNome.set(nomeKey, r);
                        if (!seen.has(nomeKey)) { seen.add(nomeKey); unicos.push(nome); }
                    }
                });
                unicos.sort((a, b) => a.localeCompare(b, 'pt', { sensitivity: 'base' }));

                const servidoresList = document.getElementById('servidoresList');
                if (servidoresList) {
                    servidoresList.innerHTML = '';
                    unicos.forEach(nome => {
                        const opt = document.createElement('option');
                        opt.value = nome;
                        servidoresList.appendChild(opt);
                    });
                }
                if (appState.currentView === 'ferias') renderFeriasView();
                if (appState.currentView === 'ponto') {
                    // Atualiza a multi-sele√ß√£o no Gerar Ponto
                    ponto_popularMultiSelect(unicos.slice());
                }

                console.log(`[RH] ${unicos.length} servidores carregados.`);
            } catch (e) {
                console.error('[RH] Falha ao carregar planilha do Google Sheets.', e);
                const content = document.getElementById('content');
                if (content && appState.currentView !== 'ponto') {
                    content.innerHTML = `<div class="p-6 text-red-600 bg-red-50 rounded-lg">Erro ao carregar dados dos funcion√°rios. Verifique o link e se a planilha est√° p√∫blica.</div>`;
                }
            }
        }

        // ====================================================================
        // L√ìGICA DE DADOS - PROCESSOS (LOCALSTORAGE)
        // ====================================================================
        function loadSeiProcesses() {
            try {
                const stored = localStorage.getItem('semcas_sei_processes');
                if (stored) {
                    appState.mockProcesses = JSON.parse(stored);
                } else {
                    appState.mockProcesses = [
                        { id: 1, number: '00195/2024', title: 'Solicita√ß√£o de F√©rias Servidor Jo√£o Silva', update: '2025-11-28', urgency: 'M√©dia', notes: 'Aguardando parecer da Coordenadoria de Lota√ß√£o.' },
                        { id: 2, number: '00010/2025', title: 'Admiss√£o de novo servidor - Maria Souza', update: '2025-12-01', urgency: 'Alta', notes: 'Documenta√ß√£o OK. Encaminhar para assinatura do Secret√°rio.' },
                        { id: 3, number: '00100/2024', title: 'Processo Disciplinar - Ajuste de conduta', update: '2025-11-15', urgency: 'Baixa', notes: 'Em an√°lise pelo jur√≠dico. Pr√≥xima reuni√£o dia 10/12.' },
                    ];
                }
            } catch(e) {
                console.error('Erro ao carregar processos do localStorage:', e);
                appState.mockProcesses = [];
            }
        }

        function saveSeiProcesses() {
            try {
                localStorage.setItem('semcas_sei_processes', JSON.stringify(appState.mockProcesses));
            } catch(e) {
                console.error('Erro ao salvar processos no localStorage:', e);
            }
        }

        // ====================================================================
        // L√ìGICA DE VISUALIZA√á√ÉO (ROTEAMENTO SPA)
        // ====================================================================

        function showView(viewName) {
            const content = document.getElementById('content');
            const pontoContainer = document.getElementById('ponto-container');
            const navLinks = document.querySelectorAll('.nav-link');

            // 1. Atualiza o estado da view, mas N√ÉO TENTA ATUALIZAR window.location.hash
            appState.currentView = viewName;
            // COMENTADO para evitar TypeError: Location.hash setter: Access... denied no ambiente iframe/blob:
            // window.location.hash = viewName; 

            // 2. Atualiza o destaque da navega√ß√£o
            navLinks.forEach(link => {
                // Usa o dataset.view para mapear links e sub-links
                const targetView = link.dataset.view;
                const isCurrent = targetView === viewName;
                const isParent = targetView === 'funcionarios' && (viewName === 'ferias' || viewName === 'ponto');

                if (isCurrent || isParent) {
                    link.classList.add('bg-blue-600');
                } else {
                    link.classList.remove('bg-blue-600');
                }
            });

            // 3. Gerencia a visibilidade do Gerador de Ponto (que tem layout fixo)
            if (viewName === 'ponto') {
                content.classList.add('hidden');
                pontoContainer.classList.remove('hidden');
                // HACK: For√ßa o re-c√°lculo de feriados e renderiza√ß√£o inicial do ponto
                ponto_aplicarPorSelect();
            } else {
                content.classList.remove('hidden');
                pontoContainer.classList.add('hidden');
                // Adiciona um espa√ßo de preenchimento para que o conte√∫do n√£o fique embaixo da barra de controle
                content.style.marginTop = '0';
            }

            // 4. Renderiza o conte√∫do da view
            content.innerHTML = '';
            switch (viewName) {
                case 'home':
                    renderHomeView(content);
                    break;
                case 'ferias':
                    renderFeriasView(content);
                    break;
                case 'processos':
                    renderProcessosView(content);
                    break;
                case 'documentacao':
                    renderDocumentacaoView(content);
                    break;
                // 'ponto' √© tratado acima
                default:
                    renderHomeView(content);
            }
        }

        // ====================================================================
        // FUN√á√ïES DE RENDERIZA√á√ÉO DE VISTAS
        // ====================================================================

        function renderHomeView(container) {
            container.innerHTML = `
                <div class="text-center py-16 bg-blue-50 rounded-xl shadow-inner">
                    <h2 class="text-4xl font-extrabold text-blue-800">Bem-vindo(a) ao Portal RH SEMCAS</h2>
                    <p class="mt-4 text-lg text-gray-600">Seu centro de gest√£o de pessoas e processos.</p>
                    <div class="mt-8 flex justify-center space-x-4">
                        <a href="#ferias" class="bg-semcas text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-blue-600 transition" data-view="ferias" onclick="showView('ferias')">
                            <i class="fas fa-umbrella-beach mr-2"></i> Ver F√©rias
                        </a>
                        <a href="#ponto" class="bg-green-600 text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-green-700 transition" data-view="ponto" onclick="showView('ponto')">
                            <i class="fas fa-clock mr-2"></i> Gerar Folha de Ponto
                        </a>
                    </div>
                </div>
            `;
        }

        function renderFeriasView(container) {
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Funcion√°rios Pr√≥ximos de Entrar de F√©rias</h2>`;
            if (!appState.registros.length) {
                container.innerHTML += `<p class="text-gray-500">Carregando dados dos servidores...</p>`;
                return;
            }

            const today = new Date();
            const feriasList = appState.registros.map(r => {
                const admissaoRaw = r['Admiss√£o'] || r['Admissao'];
                const admissaoBR = formatDateToBR(admissaoRaw);
                const [dd, mm, yyyy] = admissaoBR.split('/').map(Number);
                
                if (isNaN(dd) || isNaN(mm) || isNaN(yyyy)) {
                    return null;
                }
                
                // Per√≠odo aquisitivo (12 meses a partir da admiss√£o)
                const acquisitiveStart = new Date(yyyy, mm - 1, dd);
                const acquisitiveEnd = new Date(acquisitiveStart.getFullYear() + 1, acquisitiveStart.getMonth(), acquisitiveStart.getDate());
                
                // Calcula a diferen√ßa em dias
                const diffTime = acquisitiveEnd - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return {
                    nome: r['Funcion√°rio'] || r['Funcionario'] || 'N/A',
                    matricula: r['Matr√≠cula'] || r['Matricula'] || 'N/A',
                    lotacao: r['Lota√ß√£o'] || r['Lotacao'] || 'N/A',
                    admissao: admissaoBR,
                    elegivelEm: acquisitiveEnd.toLocaleDateString('pt-BR'),
                    diasFaltantes: diffDays,
                };
            }).filter(item => item && item.diasFaltantes >= -30 && item.diasFaltantes <= 120) // Filtra para 30 dias passados at√© 120 dias futuros
              .sort((a, b) => a.diasFaltantes - b.diasFaltantes);

            if (feriasList.length === 0) {
                container.innerHTML += `<div class="p-4 text-green-700 bg-green-50 rounded-lg">Nenhum servidor est√° pr√≥ximo do seu per√≠odo aquisitivo de f√©rias nos pr√≥ximos 4 meses.</div>`;
                return;
            }

            let html = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funcion√°rio</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lota√ß√£o</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admiss√£o</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Eleg√≠vel em</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            feriasList.forEach(item => {
                let status = '';
                let statusClass = 'bg-yellow-100 text-yellow-800';

                if (item.diasFaltantes <= 0) {
                    status = 'Eleg√≠vel (Per√≠odo vencido)';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (item.diasFaltantes <= 30) {
                    status = `${item.diasFaltantes} dias (URGENTE)`;
                    statusClass = 'bg-orange-100 text-orange-800 font-bold';
                } else {
                    status = `${item.diasFaltantes} dias restantes`;
                }

                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.lotacao}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.admissao}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.elegivelEm}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML += html;
        }

        function renderProcessosView(container) {
            loadSeiProcesses();
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Gest√£o de Processos SEI (Mock)</h2>`;

            const processListHTML = appState.mockProcesses.map(p => {
                let urgencyClass = '';
                if (p.urgency === 'Alta') urgencyClass = 'bg-red-100 text-red-800';
                else if (p.urgency === 'M√©dia') urgencyClass = 'bg-yellow-100 text-yellow-800';
                else urgencyClass = 'bg-green-100 text-green-800';

                return `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center border border-gray-200" data-id="${p.id}">
                        <div class="flex-grow">
                            <div class="text-lg font-semibold text-blue-700">${p.title}</div>
                            <div class="text-sm text-gray-600">N¬∞ SEI: <span class="font-mono">${p.number}</span> | √öltima Atualiza√ß√£o: ${p.update}</div>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full ${urgencyClass}">
                                    Urg√™ncia: ${p.urgency}
                                </span>
                            </div>
                        </div>
                        <button class="view-process-detail mt-3 md:mt-0 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition" data-id="${p.id}">
                            <i class="fas fa-search"></i> Detalhes
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML += `<div id="process-list" class="space-y-4">${processListHTML}</div>`;

            container.querySelectorAll('.view-process-detail').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = Number(e.currentTarget.dataset.id);
                    renderProcessoDetail(container, id);
                });
            });
        }

        function renderProcessoDetail(container, id) {
            const process = appState.mockProcesses.find(p => p.id === id);
            if (!process) { showView('processos'); return; }

            let urgencyOptions = ['Alta', 'M√©dia', 'Baixa'].map(u => 
                `<option value="${u}" ${process.urgency === u ? 'selected' : ''}>${u}</option>`
            ).join('');

            container.innerHTML = `
                <button id="back-to-processes" class="text-blue-600 hover:underline mb-4">
                    <i class="fas fa-arrow-left mr-2"></i> Voltar para a lista de Processos
                </button>
                <div class="bg-white p-6 rounded-lg shadow-lg border border-blue-200">
                    <h2 class="text-3xl font-bold text-blue-800 mb-2">${process.title}</h2>
                    <p class="text-lg font-mono text-gray-600 mb-6">N¬∞ SEI: ${process.number} | √öltima: ${process.update}</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Urg√™ncia e Status -->
                        <div class="md:col-span-1 bg-gray-50 p-4 rounded-lg border">
                            <label for="urgency-select-${id}" class="block text-sm font-medium text-gray-700 mb-2">Definir Urg√™ncia de An√°lise</label>
                            <select id="urgency-select-${id}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                ${urgencyOptions}
                            </select>
                        </div>
                        
                        <!-- Bloco de Notas -->
                        <div class="md:col-span-2 bg-white p-4 rounded-lg border shadow-inner">
                            <label for="notes-block-${id}" class="block text-sm font-medium text-gray-700 mb-2">Bloco de Notas / Resumo de Atualiza√ß√£o</label>
                            <textarea id="notes-block-${id}" rows="8" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md p-2" placeholder="Resumo do que foi feito, recados, ou pr√≥ximas a√ß√µes...">${process.notes}</textarea>
                            <button id="save-notes-${id}" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i> Salvar Notas e Urg√™ncia
                            </button>
                            <span id="save-status-${id}" class="ml-3 text-sm text-gray-500"></span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('back-to-processes').addEventListener('click', () => showView('processos'));
            document.getElementById(`save-notes-${id}`).addEventListener('click', () => {
                const notes = document.getElementById(`notes-block-${id}`).value;
                const urgency = document.getElementById(`urgency-select-${id}`).value;

                process.notes = notes;
                process.urgency = urgency;
                process.update = new Date().toLocaleDateString('pt-BR'); // Atualiza data
                saveSeiProcesses();

                const statusEl = document.getElementById(`save-status-${id}`);
                statusEl.textContent = 'Salvo com sucesso!';
                setTimeout(() => statusEl.textContent = '', 3000);
            });
        }

        function renderDocumentacaoView(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Documenta√ß√£o e Normativos</h2>
                <div class="p-6 text-gray-500 bg-gray-100 rounded-lg border border-gray-200">
                    <p class="font-semibold">Esta √°rea est√° vazia, conforme solicitado.</p>
                    <p class="mt-2 text-sm">Poderia conter: Legisla√ß√µes do servidor (Estatuto, Portarias), Manuais de RH, Modelos de Formul√°rios (F√©rias, Licen√ßas).</p>
                </div>
            `;
        }


        // ====================================================================
        // L√ìGICA DO GERADOR DE PONTO (ADAPTADA DO ARQUIVO ORIGINAL)
        // ====================================================================

        let nomesCache = []; // Cache de nomes para filtro
        let registroPorNome = new Map(); // Mapa de nome normalizado para dados do servidor
        const paperElement = document.getElementById('mainPaper'); // Elemento principal do A4

        // Fun√ß√£o para setar valor em um input com base no atributo 'name'
        function setValue(name, value) {
            const el = document.querySelector(`input[name="${name}"]`);
            if (el) el.value = value || '';
        }
        function setValueScoped(root, name, value) {
            const el = root.querySelector(`input[name="${name}"]`);
            if (el) el.value = value || '';
        }

        function ponto_populateDaysTable(root, mes, ano) {
            const tbodyEl = root.querySelector('#daysTableBody');
            if (!tbodyEl) return;
            const mm = Number(mes);
            const aa = Number(ano);
            if (!mm || !aa) return;
            const diasNoMes = new Date(aa, mm, 0).getDate();
            tbodyEl.innerHTML = '';
            for (let d = 1; d <= diasNoMes; d++) {
                const data = new Date(aa, mm - 1, d);
                const dow = data.getDay(); // 0=Domingo, 6=S√°bado
                const day = String(d).padStart(2, '0');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-bold bg-gray-50">${day}</td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                    <td><input type="text" class="text-center"></td>
                `;
                tbodyEl.appendChild(row);
                
                // Mescla para S√°bados e Domingos
                if (dow === 0 || dow === 6) {
                    const label = dow === 0 ? 'DOMINGO' : 'S√ÅBADO';
                    const infoTd = document.createElement('td');
                    infoTd.setAttribute('colspan', '7');
                    infoTd.className = 'text-center font-bold text-red-600 bg-red-50';
                    infoTd.textContent = label;
                    const cels = Array.from(row.querySelectorAll('td'));
                    for (let i = cels.length - 1; i >= 1; i--) { row.removeChild(cels[i]); }
                    row.appendChild(infoTd);
                    row.setAttribute('data-weekend-aplicado', '1');
                }
            }
        }

        // --- L√≥gica de Feriados (Replicada e Integrada) ---
        function computusPascoaAno(ano) {
            // Algoritmo de Meeus/Jones/Butcher
            const a = ano % 19; const b = Math.floor(ano / 100); const c = ano % 100; const d = Math.floor(b / 4); const e = b % 4;
            const f = Math.floor((b + 8) / 25); const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30; const i = Math.floor(c / 4); const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7; const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31); const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(ano, month - 1, day);
        }
        function addDays(date, days) {
            const d = new Date(date.getTime());
            d.setDate(d.getDate() + days);
            return d;
        }
        function fmtKey(d) {
            const aa = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0'); return `${aa}-${mm}-${dd}`;
        }
        function gerarFeriadosNacionaisLocal(ano) {
            const pascoa = computusPascoaAno(ano);
            const sextaPaixao = addDays(pascoa, -2);
            const corpusChristi = addDays(pascoa, 60);
            return [
                { key: `${ano}-01-01`, nome: 'Confraterniza√ß√£o Universal (Nacional)' },
                { key: fmtKey(addDays(pascoa, -47)), nome: 'Carnaval (Ter√ßa) (Nacional - P. Facultativo)' },
                { key: fmtKey(sextaPaixao), nome: 'Sexta-feira da Paix√£o (Nacional)' },
                { key: `${ano}-04-21`, nome: 'Tiradentes (Nacional)' },
                { key: `${ano}-05-01`, nome: 'Dia do Trabalho (Nacional)' },
                { key: fmtKey(corpusChristi), nome: 'Corpus Christi (Nacional)' },
                { key: `${ano}-09-07`, nome: 'Independ√™ncia do Brasil (Nacional)' },
                { key: `${ano}-10-12`, nome: 'Nossa Senhora Aparecida (Nacional)' },
                { key: `${ano}-11-02`, nome: 'Finados (Nacional)' },
                { key: `${ano}-11-15`, nome: 'Proclama√ß√£o da Rep√∫blica (Nacional)' },
                { key: `${ano}-11-20`, nome: 'Dia da Consci√™ncia Negra (Nacional)' },
                { key: `${ano}-12-25`, nome: 'Natal (Nacional)' },
            ];
        }
        function getEstaduaisMA(ano) {
            return [ { key: `${ano}-07-28`, nome: 'Ades√£o do Maranh√£o √† Independ√™ncia (Estadual)' }, ];
        }
        function getMunicipaisSaoLuis(ano) {
            return [
                { key: `${ano}-06-29`, nome: 'Dia de S√£o Pedro (Municipal - S√£o Lu√≠s)' },
                { key: `${ano}-09-08`, nome: 'Anivers√°rio/Funda√ß√£o de S√£o Lu√≠s (Municipal)' },
                { key: `${ano}-12-08`, nome: 'Nossa Senhora da Concei√ß√£o (Municipal - S√£o Lu√≠s)' },
            ];
        }
        function buildAutoFeriadosMap(mm, aa) {
            const y = Number(aa), m = Number(mm);
            const map = {};
            const natOn = document.getElementById(PONTO_DOM_IDS.toggleNat)?.checked ?? true;
            const estOn = document.getElementById(PONTO_DOM_IDS.toggleEstMa)?.checked ?? true;
            const munOn = document.getElementById(PONTO_DOM_IDS.toggleMunSlz)?.checked ?? true;

            const addList = (list, enabled) => {
                if (!enabled) return;
                list.forEach(item => {
                    const iso = item.key.length === 10 ? item.key : String(item.key).slice(0,10);
                    const [y, m2, d] = iso.split('-');
                    if (Number(y) === y && Number(m2) === m) {
                        map[iso] = item.nome || 'FERIADO';
                    }
                });
            };

            addList(gerarFeriadosNacionaisLocal(y), natOn);
            addList(getEstaduaisMA(y), estOn);
            addList(getMunicipaisSaoLuis(y), munOn);
            return map;
        }

        function parseTextareaFeriadosToMap(ta) {
            const text = ta ? ta.value.trim() : '';
            if (!text) return {};
            const map = {};
            text.split(/\r?\n/).forEach(line => {
                const m = line.match(/(\d{1,2})\D(\d{1,2})\D(\d{2,4})(?:\s*[-: ]\s*(.+))?/);
                if (m) {
                    const dd = Number(m[1]); const mm = Number(m[2]);
                    const yy = m[3].length === 2 ? 2000 + Number(m[3]) : Number(m[3]);
                    const iso = `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
                    const nm = (m[4] || 'FERIADO').trim();
                    map[iso] = nm;
                }
            });
            return map;
        }

        function collectFeriadosFromUIList() {
            const container = document.getElementById(PONTO_DOM_IDS.listaFeriados);
            const map = {};
            if (!container) return map;
            container.querySelectorAll('[data-date]').forEach(el => {
                const iso = el.getAttribute('data-date');
                const nm = el.getAttribute('data-name') || 'FERIADO';
                map[iso] = nm;
            });
            return map;
        }

        function ponto_aplicarFeriadosNaPagina(root, mm, aa) {
            const autoMap = buildAutoFeriadosMap(mm, aa);
            const manualMap = parseTextareaFeriadosToMap(document.getElementById(PONTO_DOM_IDS.feriadosInput));
            const uiMap = collectFeriadosFromUIList();

            // Combina: Manual/UI > Autom√°tico
            const combinedMap = { ...autoMap, ...manualMap, ...uiMap };
            appState.feriadosMap = new Map(Object.entries(combinedMap));

            const rows = root.querySelectorAll('#daysTableBody tr');
            rows.forEach((tr) => {
                // Remove feriados/fins de semana aplicados anteriormente
                if (tr.hasAttribute('data-feriado-aplicado')) {
                    const dayCell = tr.querySelector('td:first-child');
                    if (!dayCell) return;
                    // Recria as c√©lulas de dados e remove a c√©lula mesclada
                    const existingInfoTd = tr.querySelector('td[colspan="7"]');
                    if (existingInfoTd) tr.removeChild(existingInfoTd);
                    for (let i = 0; i < 7; i++) {
                        const newTd = document.createElement('td');
                        newTd.innerHTML = `<input type="text" class="text-center">`;
                        tr.appendChild(newTd);
                    }
                    tr.removeAttribute('data-feriado-aplicado');
                    tr.classList.remove('bg-gray-100');
                    ponto_populateDaysTable(root, mm, aa); // Rerenderiza os dias para fins de semana
                }

                const dayCell = tr.querySelector('td:first-child');
                const dd = dayCell ? dayCell.textContent.trim().padStart(2, '0') : null;
                if (!dd) return;
                const key = `${String(aa).padStart(4, '0')}-${String(mm).padStart(2, '0')}-${dd}`;

                if (appState.feriadosMap.has(key)) {
                    const nomeFeriado = appState.feriadosMap.get(key);
                    tr.classList.add('bg-gray-100');
                    // Mescla as c√©lulas de dados em uma √∫nica c√©lula com o nome do feriado
                    const infoTd = document.createElement('td');
                    infoTd.setAttribute('colspan', '7');
                    infoTd.className = 'text-center font-bold text-red-600 bg-red-50';
                    infoTd.textContent = `FERIADO: ${nomeFeriado}`;
                    // Remove todas as c√©lulas exceto a primeira (dia)
                    const cels = Array.from(tr.querySelectorAll('td'));
                    for (let i = cels.length - 1; i >= 1; i--) { tr.removeChild(cels[i]); }
                    tr.appendChild(infoTd);
                    tr.setAttribute('data-feriado-aplicado', '1');
                    tr.removeAttribute('data-weekend-aplicado'); // Remove classe de FDS
                }
            });
            ponto_renderCalendario(mm, aa);
            ponto_renderCatalogoFeriadosMes(mm, aa);
        }

        // --- Fun√ß√µes de Ponto (Integra√ß√£o) ---
        function ponto_abreviarNomeSeNecessario(nome, maxLen = 40) {
            const limpo = String(nome || '').trim().replace(/\s+/g, ' ');
            if (limpo.length <= maxLen) return limpo;
            const palavras = limpo.split(' ');
            if (palavras.length <= 2) {
                return limpo.length > maxLen ? limpo.slice(0, maxLen) : limpo;
            }
            const ignorar = new Set(['de', 'da', 'do', 'das', 'dos', 'e']);
            const primeiro = palavras[0];
            const ultimo = palavras[palavras.length - 1];
            const meio = palavras.slice(1, -1).map(p => ignorar.has(p.toLowerCase()) ? '' : p.charAt(0).toUpperCase() + '.').filter(Boolean);
            let resultado = [primeiro, ...meio, ultimo].join(' ');
            if (resultado.length > maxLen) {
                while (resultado.length > maxLen && meio.length) {
                    meio.pop();
                    resultado = [primeiro, ...meio, ultimo].join(' ');
                }
            }
            return resultado.length > maxLen ? limpo.slice(0, maxLen) : resultado;
        }

        function ponto_preencherPorNome(nome) {
            if (!appState.registros.length) { console.warn('Dados n√£o carregados.'); return; }
            const alvo = normaliza(nome);
            let row = appState.registros.find(r => normaliza(r['Funcion√°rio'] || r['Funcionario']) === alvo);
            if (!row) {
                row = appState.registros.find(r => normaliza(r['Funcion√°rio'] || r['Funcionario']).includes(alvo));
            }
            if (!row) { alert('Servidor n√£o encontrado.'); return; }

            const nomeCompleto = row['Funcion√°rio'] || row['Funcionario'] || '';
            const nomeParaCampo = ponto_abreviarNomeSeNecessario(nomeCompleto, 55);

            setValue('funcionario', nomeParaCampo);
            setValue('matricula', row['Matricula'] || row['Matr√≠cula']);
            setValue('lotacao', row['Lota√ß√£o'] || row['Lotacao']);

            let aaEscolhido = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect)?.value || new Date().getFullYear();
            let mmEscolhido = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect)?.value || String(new Date().getMonth() + 1).padStart(2, '0');

            setValue('ano', aaEscolhido);
            setValue('mes', mmEscolhido);
            setValue('cargo_origem', row['Cargo Origem']);
            setValue('horas_semanais', row['Horas Semanais']);
            setValue('cpf', row['Cpf'] || row['CPF']);
            const adm = row['Admiss√£o'] || row['Admissao'];
            setValue('admissao', formatDateToBR(adm));

            // Preenche t√≠tulo M√äS/ANO
            const tituloInput = paperElement.querySelector('div.flex input[placeholder="EX: 01/2024"]');
            if (tituloInput) { tituloInput.value = `${String(mmEscolhido).padStart(2, '0')}/${String(aaEscolhido)}`; }

            ponto_populateDaysTable(paperElement, mmEscolhido, aaEscolhido);
            ponto_aplicarFeriadosNaPagina(paperElement, mmEscolhido, aaEscolhido);
        }

        // --- Abas e UI do Gerador de Ponto ---
        function ponto_showTab(tab) {
            const tabs = { folha: 'tabFolha', feriados: 'tabFeriados', lote: 'tabLote' };
            const buttons = { folha: 'btnTabFolha', feriados: 'btnTabFeriados', lote: 'btnTabLote' };
            const active = 'bg-white text-blue-600';
            const inactive = 'bg-blue-500 text-white';

            Object.keys(tabs).forEach(key => {
                const el = document.getElementById(tabs[key]);
                const btn = document.getElementById(buttons[key]);
                if (el) el.classList.toggle('hidden', key !== tab);
                if (btn) btn.className = `tab-button-ponto px-3 py-1 rounded font-bold shadow transition ${key === tab ? active : inactive}`;
            });
            // HACK: for√ßar re-render do calend√°rio ao abrir aba de feriados
            if (tab === 'feriados') {
                const mm = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect)?.value;
                const aa = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect)?.value;
                if(mm && aa) {
                    ponto_renderCalendario(Number(mm), Number(aa));
                    ponto_renderCatalogoFeriadosMes(mm, aa);
                    ponto_populatePFDiaSelect(mm, aa);
                }
            }
        }

        function ponto_popularMultiSelect(nomes) {
            nomesCache = nomes.slice();
            const list = document.getElementById(PONTO_DOM_IDS.multiList);
            if (!list) return;
            list.innerHTML = '';
            nomes.forEach((n, idx) => {
                const id = `multi_${idx}`;
                const div = document.createElement('div');
                const reg = appState.registroPorNome.get((n || '').toLowerCase());
                const infoLot = reg ? (reg['Lota√ß√£o'] || reg['Lotacao'] || '') : '';
                const infoMat = reg ? (reg['Matr√≠cula'] || reg['Matricula'] || '') : '';
                const infoText = [infoLot, infoMat ? `Mat: ${infoMat}` : ''].filter(Boolean).join(' ‚Ä¢ ');
                const checked = appState.selectedNames.has((n || '').toLowerCase()) ? 'checked' : '';
                div.innerHTML = `
                    <label class="flex items-center justify-between gap-2 text-sm">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" value="${n}" id="${id}" ${checked}>
                            <span class="font-medium text-gray-800">${n}</span>
                        </div>
                        <div class="text-xs opacity-70 text-gray-500">${infoText}</div>
                    </label>`;
                list.appendChild(div);
                const cb = div.querySelector('input[type="checkbox"]');
                cb.addEventListener('change', () => {
                    const key = (n || '').toLowerCase();
                    if (cb.checked) appState.selectedNames.add(key); else appState.selectedNames.delete(key);
                    ponto_updateMultiCount();
                });
            });
            ponto_updateMultiCount();
        }

        function ponto_updateMultiCount() {
            const countEl = document.getElementById(PONTO_DOM_IDS.multiCount);
            if (countEl) countEl.textContent = `Selecionados: ${appState.selectedNames.size}`;
        }

        function ponto_adicionarFeriadoUI() {
            const dateRaw = document.getElementById(PONTO_DOM_IDS.feriadoDataInput)?.value;
            const nome = (document.getElementById(PONTO_DOM_IDS.feriadoNomeInput)?.value || '').trim() || 'FERIADO MANUAL';
            if (!dateRaw || !nome) { alert('Informe data (dd/mm/aaaa) e nome do feriado.'); return; }
            const m = dateRaw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!m) { alert('Data inv√°lida. Use dd/mm/aaaa.'); return; }
            const [_, dd, mm, yy] = m;
            const key = `${yy}-${mm}-${dd}`;
            
            ponto_adicionarFeriadoLista(key, nome, `${dd}/${mm}/${yy}`);
            ponto_aplicarPorSelect();
        }
        
        function ponto_adicionarFeriadoLista(key, nome, dataBR) {
            const listaFeriados = document.getElementById(PONTO_DOM_IDS.listaFeriados);
            if (!listaFeriados) return;

            const existing = listaFeriados.querySelector(`[data-date="${key}"]`);
            if (existing) existing.remove(); // Remove duplicatas

            const item = document.createElement('div');
            item.className = 'flex items-center justify-between bg-white text-black border rounded px-2 py-1';
            item.setAttribute('data-date', key);
            item.setAttribute('data-name', nome);
            item.innerHTML = `<span class="text-sm"><strong>${dataBR}</strong> ‚Äî ${nome}</span><button class="text-red-600 text-xs font-bold hover:underline ml-2">Remover</button>`;
            item.querySelector('button').addEventListener('click', () => {
                item.remove();
                ponto_aplicarPorSelect(); // Reaplica para remover o feriado da folha
            });
            listaFeriados.appendChild(item);
        }

        function ponto_renderCalendario(mes, ano) {
            const cont = document.getElementById(PONTO_DOM_IDS.calendarioFeriados);
            const header = document.getElementById(PONTO_DOM_IDS.calHeader);
            if (!cont || !header) return;
            const mm = Number(mes); const aa = Number(ano);
            cont.innerHTML = '';
            header.textContent = `${nomeMesPT(mm)} de ${aa}`;
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            diasSemana.forEach(d => {
                const h = document.createElement('div');
                h.className = 'text-center font-bold opacity-80 text-xs text-gray-700';
                h.textContent = d;
                cont.appendChild(h);
            });
            const primeiroDia = new Date(aa, mm - 1, 1);
            const offset = primeiroDia.getDay(); 
            for (let i = 0; i < offset; i++) {
                const empty = document.createElement('div');
                empty.className = 'border min-h-[36px] bg-gray-100/50';
                cont.appendChild(empty);
            }
            const diasNoMes = new Date(aa, mm, 0).getDate();
            const combinedMap = {
                ...buildAutoFeriadosMap(mm, aa), 
                ...parseTextareaFeriadosToMap(document.getElementById(PONTO_DOM_IDS.feriadosInput)),
                ...collectFeriadosFromUIList()
            };

            for (let d = 1; d <= diasNoMes; d++) {
                const dd = String(d).padStart(2, '0');
                const key = `${aa}-${String(mm).padStart(2, '0')}-${dd}`;
                const nome = combinedMap[key];
                const cell = document.createElement('div');
                cell.className = 'border rounded px-1 py-1 text-left hover:bg-blue-50 transition min-h-[50px]';
                cell.classList.add(nome ? 'bg-red-50 border-red-200' : 'bg-white');
                cell.innerHTML = `<div class="font-bold text-xs">${dd}</div>${nome ? `<div class="text-[10px] text-red-700">${nome}</div>` : ''}`;
                cell.title = nome || '';
                cont.appendChild(cell);
            }
        }

        function ponto_renderCatalogoFeriadosMes(mm, aa) {
            const cont = document.getElementById(PONTO_DOM_IDS.catalogoFeriadosMes);
            if (!cont) return;
            const map = buildAutoFeriadosMap(mm, aa);
            const entries = Object.entries(map).sort((a,b) => a[0].localeCompare(b[0]));
            cont.innerHTML = '';
            if (!entries.length) { cont.innerHTML = '<div class="text-xs opacity-70">Nenhum feriado oficial encontrado com os filtros.</div>'; return; }
            entries.forEach(([iso, nome]) => {
                const [yyyy, m2, dd] = iso.split('-');
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between gap-2 border rounded px-2 py-1 text-xs bg-white';
                item.textContent = `${dd}/${m2}/${yyyy} ‚Äî ${nome}`;
                cont.appendChild(item);
            });
        }
        
        function ponto_populatePFDiaSelect(mm, aa) {
            const sel = document.getElementById(PONTO_DOM_IDS.pfDiaSelect);
            if (!sel) return;
            sel.innerHTML = '';
            const total = new Date(Number(aa), Number(mm), 0).getDate();
            for (let d = 1; d <= total; d++) {
                const opt = document.createElement('option');
                opt.value = String(d).padStart(2,'0');
                opt.textContent = String(d).padStart(2,'0');
                sel.appendChild(opt);
            }
        }

        // --- Aplicador Geral (Sincroniza Tela e Folha) ---
        function ponto_aplicarPorSelect() {
            const yy = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect)?.value;
            const mm = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect)?.value;
            if (!yy || !mm) return;
            const mmNum = Number(mm);
            const yyNum = Number(yy);
            document.getElementById(PONTO_DOM_IDS.mesFolhaInput).value = `${yy}-${mm}`;
            
            // Re-renderiza a tabela de dias e aplica feriados
            ponto_populateDaysTable(paperElement, mmNum, yyNum);
            ponto_aplicarFeriadosNaPagina(paperElement, mmNum, yyNum);

            // Sincroniza UI de Feriados
            ponto_renderCalendario(mmNum, yyNum);
            ponto_renderCatalogoFeriadosMes(mmNum, yyNum);
            ponto_populatePFDiaSelect(mmNum, yyNum);
        }

        function ponto_bindEvents() {
            // Abas
            document.getElementById(PONTO_DOM_IDS.btnTabFolha)?.addEventListener('click', () => ponto_showTab('folha'));
            document.getElementById(PONTO_DOM_IDS.btnTabFeriados)?.addEventListener('click', () => ponto_showTab('feriados'));
            document.getElementById(PONTO_DOM_IDS.btnTabLote)?.addEventListener('click', () => ponto_showTab('lote'));
            ponto_showTab('folha');

            // Selects de M√™s/Ano
            const now = new Date();
            const mesSel = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect);
            const anoSel = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect);
            if (mesSel && anoSel) {
                const yStart = now.getFullYear() - 3;
                const yEnd = now.getFullYear() + 3;
                for (let y = yStart; y <= yEnd; y++) {
                    const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
                    anoSel.appendChild(opt);
                }
                mesSel.value = String(now.getMonth() + 1).padStart(2, '0');
                anoSel.value = String(now.getFullYear());
                mesSel.addEventListener('change', ponto_aplicarPorSelect);
                anoSel.addEventListener('change', ponto_aplicarPorSelect);
            }

            // Gera√ß√£o de Folha
            document.getElementById(PONTO_DOM_IDS.carregarDadosBtn)?.addEventListener('click', () => {
                const nome = document.getElementById(PONTO_DOM_IDS.servidorNome)?.value;
                if (nome) ponto_preencherPorNome(nome);
            });
            document.getElementById(PONTO_DOM_IDS.servidorNome)?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); document.getElementById(PONTO_DOM_IDS.carregarDadosBtn)?.click(); }
            });

            // Feriados
            document.getElementById(PONTO_DOM_IDS.aplicarFeriadosBtn)?.addEventListener('click', ponto_aplicarPorSelect);
            document.getElementById(PONTO_DOM_IDS.adicionarFeriadoBtn)?.addEventListener('click', ponto_adicionarFeriadoUI);
            document.getElementById(PONTO_DOM_IDS.buscarFeriadosBtn)?.addEventListener('click', () => {
                ponto_aplicarPorSelect();
                alert('Cat√°logo de feriados (Nacionais, Estaduais e Municipais de S√£o Lu√≠s) aplicado.');
            });
            document.getElementById(PONTO_DOM_IDS.adicionarPFBtn)?.addEventListener('click', () => {
                const dia = document.getElementById(PONTO_DOM_IDS.pfDiaSelect)?.value;
                const nome = document.getElementById(PONTO_DOM_IDS.pfNomeInput)?.value?.trim() || 'Ponto Facultativo';
                const yy = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect)?.value;
                const mm = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect)?.value;
                if (dia && yy && mm) {
                    const key = `${yy}-${mm}-${dia}`;
                    ponto_adicionarFeriadoLista(key, nome, `${dia}/${mm}/${yy}`);
                    ponto_aplicarPorSelect();
                } else {
                    alert('Selecione o dia e verifique o m√™s/ano.');
                }
            });
            [PONTO_DOM_IDS.toggleNat, PONTO_DOM_IDS.toggleEstMa, PONTO_DOM_IDS.toggleMunSlz].forEach(id => {
                document.getElementById(id)?.addEventListener('change', ponto_aplicarPorSelect);
            });


            // Lote
            document.getElementById(PONTO_DOM_IDS.multiSearch)?.addEventListener('input', (e) => {
                const q = e.target.value.trim().toLowerCase();
                const filtrados = nomesCache.filter(n => n.toLowerCase().includes(q));
                ponto_popularMultiSelect(filtrados);
            });
            document.getElementById(PONTO_DOM_IDS.selecionarTodosBtn)?.addEventListener('click', () => {
                nomesCache.forEach(n => appState.selectedNames.add((n || '').toLowerCase()));
                ponto_popularMultiSelect(nomesCache);
            });
            document.getElementById(PONTO_DOM_IDS.limparSelecaoBtn)?.addEventListener('click', () => {
                appState.selectedNames.clear();
                ponto_popularMultiSelect(nomesCache);
            });
            document.getElementById(PONTO_DOM_IDS.imprimirLoteBtn)?.addEventListener('click', ponto_imprimirLote);

            // Disparo inicial
            ponto_aplicarPorSelect();
        }

        function ponto_imprimirLote() {
            const printContainer = document.getElementById('printContainer');
            if (!printContainer) return;
            if (!appState.selectedNames.size) { alert('Selecione ao menos um servidor para impress√£o em lote.'); return; }

            const selecionados = Array.from(appState.selectedNames).map(k => {
                const reg = appState.registroPorNome.get(k);
                return reg ? (reg['Funcion√°rio'] || reg['Funcionario'] || k) : k;
            }).sort((a,b) => a.localeCompare(b, 'pt', { sensitivity: 'base' }));

            printContainer.innerHTML = '';
            selecionados.forEach(nome => {
                const alvo = normaliza(nome);
                let row = appState.registros.find(r => normaliza(r['Funcion√°rio'] || r['Funcionario']) === alvo);
                if (!row) row = appState.registros.find(r => normaliza(r['Funcion√°rio'] || r['Funcionario']).includes(alvo));
                if (row) {
                    const original = document.getElementById('mainPaper');
                    const clone = original.cloneNode(true);
                    clone.id = `paper-${row['Matricula'] || 'temp'}`;
                    clone.classList.remove('hidden'); // Certifica que o clone est√° vis√≠vel no container de impress√£o
                    
                    // Preenche dados no clone
                    const nomeCompleto = row['Funcion√°rio'] || row['Funcionario'] || '';
                    const nomeParaCampo = ponto_abreviarNomeSeNecessario(nomeCompleto, 55);
                    setValueScoped(clone, 'funcionario', nomeParaCampo);
                    setValueScoped(clone, 'matricula', row['Matricula'] || row['Matr√≠cula']);
                    setValueScoped(clone, 'lotacao', row['Lota√ß√£o'] || row['Lotacao']);
                    
                    let aaEscolhido = document.getElementById(PONTO_DOM_IDS.mesFolhaAnoSelect)?.value || new Date().getFullYear();
                    let mmEscolhido = document.getElementById(PONTO_DOM_IDS.mesFolhaMesSelect)?.value || String(new Date().getMonth() + 1).padStart(2, '0');
                    setValueScoped(clone, 'ano', aaEscolhido);
                    setValueScoped(clone, 'mes', mmEscolhido);
                    setValueScoped(clone, 'cargo_origem', row['Cargo Origem']);
                    setValueScoped(clone, 'horas_semanais', row['Horas Semanais']);
                    setValueScoped(clone, 'cpf', row['Cpf'] || row['CPF']);
                    const adm = row['Admiss√£o'] || row['Admissao'];
                    setValueScoped(clone, 'admissao', formatDateToBR(adm));

                    const tituloInput = clone.querySelector('div.flex input[placeholder="EX: 01/2024"]');
                    if (tituloInput) { tituloInput.value = `${String(mmEscolhido).padStart(2, '0')}/${String(aaEscolhido)}`; }

                    ponto_populateDaysTable(clone, mmEscolhido, aaEscolhido);
                    ponto_aplicarFeriadosNaPagina(clone, mmEscolhido, aaEscolhido);

                    printContainer.appendChild(clone);
                }
            });

            if (!printContainer.children.length) { alert('N√£o foi poss√≠vel preparar p√°ginas para os selecionados.'); return; }
            
            // Oculta p√°gina original e mostra container
            document.getElementById('mainPaper')?.classList.add('hidden');
            printContainer.classList.remove('hidden');

            // Imprime e limpa
            window.print();
            window.addEventListener('afterprint', () => {
                printContainer.classList.add('hidden');
                printContainer.innerHTML = '';
                document.getElementById('mainPaper')?.classList.remove('hidden');
            }, { once: true });
        }


        // ====================================================================
        // INICIALIZA√á√ÉO E ROTAS
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Roteamento baseado em hash
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Obt√©m a view do data-attribute, que √© o que precisamos
                    const view = e.currentTarget.dataset.view;
                    // Chamamos showView com a view alvo
                    showView(view);
                });
            });
            // O evento hashchange no final do arquivo tamb√©m foi removido,
            // pois estava causando o mesmo erro. A navega√ß√£o agora √© puramente
            // baseada em eventos de clique (SPA).

            // Carrega dados e inicia o app
            carregarPlanilha();
            loadSeiProcesses();
            ponto_bindEvents();
            showView(appState.currentView);
        });
        
        // window.addEventListener('hashchange', () => { ... } REMOVIDO PARA EVITAR O ERRO

    </script>
</body>
</html>

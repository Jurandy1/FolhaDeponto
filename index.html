<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <title>Portal RH - SEMCAS São Luís</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Import removido: fonte externa causava erro de carregamento */

        /* --- CONFIGURAÇÕES GERAIS --- */
        body { font-family: 'Inter', Arial, Helvetica, sans-serif; background-color: #f3f4f6; }
        .bg-semcas { background-color: #007bff; }
        .text-semcas { color: #007bff; }

        /* --- FOLHA DE PONTO (A4) --- */
        :root {
            --bg-paper: #fff;
            --color-text: #000;
            --border-color: #000;
            --input-focus: #e8f0fe;
            --gray-header: #ccc;
        }

        .page-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px 0;
            overflow-x: auto;
        }

        .page {
            width: 210mm;
            min-width: 210mm;
            height: 297mm; /* Altura fixa A4 */
            background: var(--bg-paper);
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0 auto;
            font-family: Arial, Helvetica, sans-serif;
            position: relative;
        }

        /* Tabelas da Folha */
        .folha-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 2px solid var(--border-color);
            margin-bottom: 0;
        }

        .folha-table td, .folha-table th {
            border: 1px solid var(--border-color);
            padding: 2px 4px; /* Padding reduzido para caber melhor */
            font-size: 11px;
            vertical-align: middle;
            color: var(--color-text);
            overflow: hidden;
            white-space: nowrap;
        }

        /* Inputs Editáveis */
        .input-linha {
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            font-family: inherit;
            font-size: 11px;
            font-weight: bold;
            width: 100%;
            outline: none;
            color: var(--color-text);
        }
        .input-linha:focus { background-color: var(--input-focus); border-bottom-color: #000; }

        td[contenteditable="true"] { cursor: text; }
        td[contenteditable="true"]:focus { background-color: var(--input-focus); outline: 2px solid #2196F3; outline-offset: -2px; }

        /* Estilos Visuais Folha */
        .bg-gray-folha { background-color: var(--gray-header) !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .bg-white-header { background-color: #fff !important; font-weight: bold; text-align: center; }
        .bg-white { background-color: #fff !important; }
        .titulo-folha { font-size: 14px; font-weight: bold; text-align: center; text-transform: uppercase; }
        .label-folha { font-size: 10px; color: #333; }
        .valor-folha { font-weight: bold; font-size: 11px; padding-left: 5px; }

        /* Rodapé Assinaturas */
        .footer-table { margin-top: -1px; border-top: none; width: 100%; border-collapse: collapse; }
        .box-assinatura { height: 90px; vertical-align: top; padding: 5px; position: relative; width: 50%; border: 1px solid black; }
        .linha-assinatura { border-bottom: 1px solid black; width: 80%; position: absolute; bottom: 35px; left: 10%; }
        .data-assinatura { position: absolute; bottom: 5px; left: 10px; font-size: 11px; width: 90%; display: flex; align-items: center; gap: 2px; }
        .input-data-short { width: 25px; border: none; border-bottom: 1px solid #000; text-align: center; font-family: inherit; font-size: inherit; background: transparent; }

        /* --- PRINT STYLES --- */
        @media print {
            header, .no-print, #ponto-controls, #content { display: none !important; }
            body { margin: 0; padding: 0; background: #fff !important; }
            #ponto-container { display: block !important; }
            .page-wrapper { display: block; width: 100%; padding: 0; margin: 0; overflow: visible; }
            .page { 
                margin: 0; border: none; box-shadow: none; width: 100%; height: 297mm; padding: 10mm; 
                page-break-after: always; /* Força quebra de página para o Lote */
            }
            .input-linha { border-bottom: none; }
            td[contenteditable="true"] { outline: none; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* --- ACESSIBILIDADE E RESPONSIVIDADE --- */
        .nav-btn:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }
        .hero-banner { width: 100%; object-fit: cover; aspect-ratio: 3 / 1; }
        @media (max-width: 640px) { /* Mobile */
            .hero-banner { aspect-ratio: 2.5 / 1; }
        }
        @media (min-width: 1024px) { /* Desktop grande */
            .hero-banner { aspect-ratio: 3 / 1; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <!-- CABEÇALHO / NAVEGAÇÃO -->
    <header class="sticky top-0 z-50 shadow-md bg-semcas text-white no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <i class="fas fa-building-columns text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold leading-tight">Portal RH</h1>
                        <p class="text-xs text-blue-100">SEMCAS - São Luís</p>
                    </div>
                </div>

                <!-- Menu -->
                <nav class="mt-3 md:mt-0 w-full md:w-auto overflow-x-auto" aria-label="Navegação principal">
                    <ul class="flex space-x-1 sm:space-x-2 text-sm">
                        <li><button onclick="router('home')" class="nav-btn px-3 py-2 rounded hover:bg-white/10 transition flex items-center gap-2" data-target="home"><i class="fas fa-home"></i> Início</button></li>
                        <li><button onclick="router('ferias')" class="nav-btn px-3 py-2 rounded hover:bg-white/10 transition flex items-center gap-2" data-target="ferias"><i class="fas fa-umbrella-beach"></i> Férias</button></li>
                        <li><button onclick="router('ponto')" class="nav-btn px-3 py-2 rounded bg-white/20 font-bold transition flex items-center gap-2" data-target="ponto"><i class="fas fa-clock"></i> Folha de Ponto</button></li>
                        <li><button onclick="router('processos')" class="nav-btn px-3 py-2 rounded hover:bg-white/10 transition flex items-center gap-2" data-target="processos"><i class="fas fa-folder-open"></i> Processos</button></li>
                        <li><button onclick="router('noticias')" class="nav-btn px-3 py-2 rounded hover:bg-white/10 transition flex items-center gap-2" data-target="noticias"><i class="fas fa-newspaper"></i> Notícias</button></li>
                        <li><button onclick="router('sugestoes')" class="nav-btn px-3 py-2 rounded hover:bg-white/10 transition flex items-center gap-2" data-target="sugestoes"><i class="fas fa-lightbulb"></i> Sugestões</button></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="flex-grow w-full max-w-7xl mx-auto p-4 sm:p-6">
        
        <!-- View: HOME -->
        <div id="home-view" class="view-section hidden">
            <!-- Banner principal (3:1) -->
            <div class="rounded-2xl overflow-hidden mb-6">
                <img
                  id="bannerPrincipal"
                  src="Gemini_Generated_Image_ufn1hnufn1hnufn1.png"
                  alt="Recursos Humanos - SEMCAS"
                  class="hero-banner"
                />
            </div>
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white shadow-lg mb-8">
                <h2 class="text-3xl font-bold mb-2">Bem-vindo, Servidor!</h2>
                <p class="opacity-90">Acesse seus serviços de RH de forma rápida e segura.</p>
                <div class="mt-6 flex gap-3">
                    <button onclick="router('ponto')" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition shadow">Gerar Folha Agora</button>
                    <button onclick="router('ferias')" class="bg-blue-900/50 text-white px-4 py-2 rounded-lg hover:bg-blue-900/70 transition">Consultar Férias</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-blue-500 mb-2"><i class="fas fa-bullhorn text-2xl"></i></div>
                    <h3 class="font-bold text-gray-800">Últimos Avisos</h3>
                    <p class="text-sm text-gray-500 mt-1">O prazo para entrega da folha de novembro encerra dia 20.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-green-500 mb-2"><i class="fas fa-calendar-check text-2xl"></i></div>
                    <h3 class="font-bold text-gray-800">Calendário</h3>
                    <p class="text-sm text-gray-500 mt-1">Confira os feriados e pontos facultativos de 2025 já atualizados.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-purple-500 mb-2"><i class="fas fa-file-signature text-2xl"></i></div>
                    <h3 class="font-bold text-gray-800">Processos</h3>
                    <p class="text-sm text-gray-500 mt-1">Você tem 2 processos pendentes de assinatura no SEI.</p>
                </div>
            </div>
        </div>

        <!-- View: FÉRIAS ROBUSTAS -->
        <div id="ferias-view" class="view-section hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Controle de Vencimento de Férias</h2>
                <button onclick="carregarFerias()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync"></i> Atualizar Dados</button>
            </div>

            <!-- Dashboard Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <span class="text-xs font-bold text-red-600 uppercase">Vencidas</span>
                    <div class="text-2xl font-bold text-red-800" id="count-vencida">0</div>
                    <div class="text-xs text-red-600">Ação Imediata</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <span class="text-xs font-bold text-orange-600 uppercase">Crítico (< 60 dias)</span>
                    <div class="text-2xl font-bold text-orange-800" id="count-critico">0</div>
                    <div class="text-xs text-orange-600">Agendar Urgente</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                    <span class="text-xs font-bold text-yellow-600 uppercase">Atenção (< 90 dias)</span>
                    <div class="text-2xl font-bold text-yellow-800" id="count-atencao">0</div>
                    <div class="text-xs text-yellow-600">Planejar</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <span class="text-xs font-bold text-blue-600 uppercase">Em Dia</span>
                    <div class="text-2xl font-bold text-blue-800" id="count-emdia">0</div>
                    <div class="text-xs text-blue-600">Sem pendências</div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex flex-col md:flex-row gap-2 md:gap-4 md:items-center">
                    <input id="filtroFerias" oninput="renderTabelaFerias()" placeholder="Filtrar por nome..." class="border rounded px-3 py-1 text-sm w-full md:w-1/3">
                    <select id="filtroStatusFerias" onchange="renderTabelaFerias()" class="border rounded px-3 py-1 text-sm w-full md:w-48">
                        <option value="todos">Todos os Status</option>
                        <option value="vencida">Vencidas</option>
                        <option value="critico">Críticas</option>
                        <option value="atencao">Atenção</option>
                    </select>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <input id="sheetUrlInput" class="border rounded px-3 py-1 text-sm w-full md:w-96" placeholder="URL CSV público da planilha de RH (Google Sheets)">
                        <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="salvarSheetUrl()">Salvar</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">Servidor</th>
                                <th class="px-4 py-3">Lotação</th>
                                <th class="px-4 py-3">Admissão</th>
                                <th class="px-4 py-3">Limite Concessivo</th>
                                <th class="px-4 py-3">Dias Restantes</th>
                                <th class="px-4 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-ferias-body" class="divide-y divide-gray-100">
                            <!-- JS popula aqui -->
                        </tbody>
                    </table>
                </div>
                <div class="p-3 bg-gray-50 flex justify-between items-center">
                    <div class="text-xs text-gray-500">* Cálculo baseado na data de admissão. Considera apenas o período aquisitivo atual não prescrito.</div>
                    <div class="flex items-center gap-2 text-xs">
                        <button id="feriasPrevBtn" class="px-2 py-1 rounded border border-gray-300 hover:bg-gray-100" onclick="feriasPrev()">Anterior</button>
                        <span id="feriasPageInfo" class="text-gray-700">Página 1</span>
                        <button id="feriasNextBtn" class="px-2 py-1 rounded border border-gray-300 hover:bg-gray-100" onclick="feriasNext()">Próxima</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="processos-view" class="view-section hidden bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Acompanhamento de Processos (SEI)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <h3 class="font-bold text-gray-700 mb-2">Cadastrar Processo</h3>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-gray-600">Número SEI</label>
                        <input id="procNumero" class="w-full border rounded px-3 py-2 text-sm" placeholder="Ex.: 00000.000000/0000-00">
                        <label class="block text-xs font-bold text-gray-600">Título</label>
                        <input id="procTitulo" class="w-full border rounded px-3 py-2 text-sm" placeholder="Descreva o assunto">
                        <label class="block text-xs font-bold text-gray-600">Data</label>
                        <input id="procData" type="date" class="w-full border rounded px-3 py-2 text-sm">
                        <button id="btnSalvarProc" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-2">Meus Processos</h3>
                    <div id="listaProcessos" class="space-y-2"></div>
                </div>
            </div>
            <div id="procDetalheModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl w-full max-w-2xl p-4 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-800">Detalhes do Processo</h3>
                        <button onclick="fecharProcDetalhe()" class="text-gray-600 hover:text-gray-900"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="procDetalheConteudo" class="text-sm"></div>
                </div>
            </div>
        </div>
        <div id="noticias-view" class="view-section hidden bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Mural de Notícias</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <h3 class="font-bold text-gray-700 mb-2">Nova notícia/aviso</h3>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-gray-600">Título</label>
                        <input id="newsTitulo" class="w-full border rounded px-3 py-2 text-sm">
                        <label class="block text-xs font-bold text-gray-600">Resumo</label>
                        <input id="newsResumo" class="w-full border rounded px-3 py-2 text-sm" placeholder="Breve descrição">
                        <label class="block text-xs font-bold text-gray-600">Conteúdo</label>
                        <textarea id="newsConteudo" class="w-full border rounded px-3 py-2 text-sm h-24"></textarea>
                        <div class="flex items-center gap-2">
                            <input id="newsPublicado" type="checkbox">
                            <label for="newsPublicado" class="text-sm text-gray-700">Publicar na página inicial</label>
                        </div>
                        <button id="btnSalvarNews" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Salvar notícia</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-2">Notícias</h3>
                    <div id="listaNoticias" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- View: SUGESTÕES RH SEMCAS -->
        <div id="sugestoes-view" class="view-section hidden bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Sugestões de Melhorias (RH SEMCAS)</h2>
            <ul class="list-disc ml-6 text-gray-700 space-y-2">
                <li>Unificar autenticação de servidores com acesso único (SSO) e perfis.</li>
                <li>Dashboard de férias com alertas por e‑mail antes do vencimento.</li>
                <li>Integração direta com SEI para leitura de status e movimentações.</li>
                <li>Calendário institucional com feriados oficiais e pontos facultativos configuráveis.</li>
                <li>Workflow de publicação de notícias com revisão e agendamento.</li>
                <li>Relatórios de frequência e ausências com exportação para CSV/PDF.</li>
                <li>Central de documentos (modelos atualizados e busca avançada).</li>
                <li>Auditoria de alterações (quem alterou, quando e o que foi alterado).</li>
            </ul>
        </div>

        <!-- View: PONTO (Ferramenta Principal) -->
        <div id="ponto-container" class="view-section hidden">
            
            <!-- Barra de Controle Fixa (Mobile Friendly) -->
            <div id="ponto-controls" class="no-print bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6 sticky top-20 z-40">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-print text-blue-600"></i> Gerador de Folha
                        </h2>
                        <p class="text-xs text-gray-500">Gere folhas individuais ou em lote automaticamente.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-900 transition shadow flex items-center gap-2">
                            <i class="fas fa-print"></i> <span class="hidden sm:inline">Imprimir Atual</span>
                        </button>
                    </div>
                </div>

                <!-- Abas -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button onclick="switchTab('folha')" id="tab-btn-folha" class="tab-btn px-4 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600">Individual</button>
                    <button onclick="switchTab('lote')" id="tab-btn-lote" class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">Impressão em Lote</button>
                    <button onclick="switchTab('feriados')" id="tab-btn-feriados" class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">Feriados (2025)</button>
                </div>

                <!-- Conteúdo das Abas -->
                
                <!-- 1. ABA INDIVIDUAL -->
                <div id="tab-folha" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                        <div class="md:col-span-5">
                            <label class="block text-xs font-bold text-gray-600 mb-1">Servidor</label>
                            <input id="servidorNome" list="servidoresList" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Digite o nome...">
                            <datalist id="servidoresList"></datalist>
                        </div>
                        <div class="md:col-span-2">
                            <button id="carregarDadosBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition text-sm">
                                Preencher
                            </button>
                        </div>
                        <div class="md:col-span-5 flex gap-2">
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Mês</label>
                                <select id="mesSelect" class="w-full border rounded-lg px-2 py-2 text-sm bg-white"></select>
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Ano</label>
                                <select id="anoSelect" class="w-full border rounded-lg px-2 py-2 text-sm bg-white"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ABA LOTE (BATCH PRINT) -->
                <div id="tab-lote" class="tab-content hidden">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-sm text-blue-800">Seleção Múltipla</h3>
                            <span id="contadorLote" class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-bold">0 selecionados</span>
                        </div>
                        <input id="filtroLote" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="Filtrar nomes na lista...">
                        <div id="listaLote" class="h-32 overflow-y-auto bg-white border rounded p-2 space-y-1 text-sm">
                            <!-- Checkboxes gerados via JS -->
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="selecionarTodosLote()" class="text-xs text-blue-600 hover:underline">Selecionar Todos</button>
                            <button onclick="limparLote()" class="text-xs text-red-600 hover:underline">Limpar Seleção</button>
                        </div>
                    </div>
                    <button onclick="imprimirLote()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-sm flex justify-center items-center gap-2">
                        <i class="fas fa-layer-group"></i> Gerar e Imprimir Selecionados
                    </button>
                </div>

                <!-- 3. ABA FERIADOS (ROBUSTA) -->
                <div id="tab-feriados" class="tab-content hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-sm text-gray-800">Feriados Oficiais</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-600">Ano</label>
                            <select id="feriadosAnoSelect" class="border rounded px-2 py-1 text-xs">
                                <option>2024</option>
                                <option selected>2025</option>
                                <option>2026</option>
                                <option>2027</option>
                                <option>2028</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Lista Oficial -->
                        <div class="bg-gray-50 p-3 rounded-lg border">
                            <h3 class="font-bold text-xs uppercase text-gray-500 mb-2">Feriados Oficiais (Detectados)</h3>
                            <div id="listaFeriadosOficiais" class="h-32 overflow-y-auto space-y-1 text-xs text-gray-600"></div>
                        </div>
                        
                        <!-- Adicionar Manual -->
                        <div class="bg-white p-3 rounded-lg border shadow-sm">
                            <h3 class="font-bold text-xs uppercase text-blue-600 mb-2">Adicionar Data Extra</h3>
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <input id="dataExtra" type="text" placeholder="dd/mm/aaaa" class="border rounded px-2 py-1 text-sm w-1/3">
                                    <input id="nomeExtra" type="text" placeholder="Nome do evento..." class="border rounded px-2 py-1 text-sm w-2/3">
                                </div>
                                <div class="flex items-center gap-2">
                                    <select id="tipoExtra" class="border rounded px-2 py-1 text-sm w-full">
                                        <option value="feriado">Feriado (Vermelho)</option>
                                        <option value="facultativo">Ponto Facultativo (Amarelo)</option>
                                    </select>
                                    <button onclick="addFeriadoManual()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">+</button>
                                </div>
                                <div id="listaExtras" class="mt-2 space-y-1 max-h-20 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ÁREA DE IMPRESSÃO (PÁGINA A4) -->
            <div class="page-wrapper no-print:mt-0">
                <div class="page" id="mainPaper">
                    
                    <!-- 1. DADOS CADASTRAIS -->
                    <table class="folha-table">
                        <tr>
                            <td class="bg-gray-folha titulo-folha" style="width: 70%;">REGISTRO INDIVIDUAL DE FREQUÊNCIA</td>
                            <td class="bg-white" style="width: 30%;">
                                <span class="label-folha">Mês / Ano:</span> 
                                <span id="labelMesAno" class="valor-folha" style="font-size: 13px;">NOVEMBRO/2025</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="bg-white text-center">
                                <span class="label-folha">Órgão Municipal:</span> 
                                <span style="font-weight: bold; font-size: 11px;">Secretaria Municipal da Criança e Assistência Social/ SEMCAS</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg-white" style="border-right: none;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Nome:</span> 
                                    <input type="text" id="inpNome" class="input-linha" placeholder="...">
                                </div>
                            </td>
                            <td class="bg-white" style="width: 25%; border-left: 1px solid #000;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="margin-right: 5px;">Matrícula:</span> 
                                    <input type="text" id="inpMatricula" class="input-linha" style="width: 80px;">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg-white" style="border-right: none;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Cargo/Função:</span> 
                                    <input type="text" id="inpCargo" class="input-linha" placeholder="...">
                                </div>
                            </td>
                            <td class="bg-white" style="border-left: 1px solid #000;">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="margin-right: 5px;">Vínculo:</span> 
                                    <input type="text" id="inpVinculo" class="input-linha" style="width: 90px;">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="bg-white">
                                <div style="display: flex; align-items: center;">
                                    <span class="label-folha" style="white-space: nowrap; margin-right: 5px;">Unidade Administrativa:</span> 
                                    <input type="text" id="inpUnidade" class="input-linha" value="SEMCAS">
                                </div>
                            </td>
                        </tr>
                    </table>
        
                    <!-- 2. TABELA DE PONTO -->
                    <table class="folha-table" style="margin-top: -1px;">
                        <colgroup>
                            <col class="col-dia">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                            <col class="col-hora"><col class="col-rubrica">
                        </colgroup>
                        <thead>
                            <tr class="bg-white-header">
                                <th rowspan="3">Dia</th>
                                <th colspan="8">Horário de Trabalho</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="4">Manhã</th>
                                <th colspan="4">Tarde</th>
                            </tr>
                            <tr class="bg-white-header">
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>08:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>12:00</th>
                                <th colspan="2" style="font-size: 10px;">Entrada:<br>14:00</th>
                                <th colspan="2" style="font-size: 10px;">Saída:<br>18:00</th>
                            </tr>
                            <tr class="bg-gray-folha">
                                <th></th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                                <th style="font-size: 9px;">Hora</th> <th style="font-size: 9px;">Rubrica</th>
                            </tr>
                        </thead>
                        <tbody id="daysTableBody"></tbody>
                    </table>
        
                    <!-- 3. RODAPÉ ASSINATURAS -->
                    <table class="footer-table">
                        <tr>
                            <td class="box-assinatura">
                                <div style="font-weight: bold; font-size: 11px;">Chefia Imediata:</div>
                                <div class="linha-assinatura"></div>
                                <div class="data-assinatura">
                                    São Luís, 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short">
                                </div>
                            </td>
                            <td class="box-assinatura">
                                <div style="font-weight: bold; font-size: 11px;">Visto (Área de Recursos Humanos):</div>
                                <div class="linha-assinatura"></div>
                                <div class="data-assinatura">
                                    São Luís, 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short"> / 
                                    <input type="text" class="input-data-short">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Container Invisível para Impressão em Lote -->
            <div id="printContainer" class="hidden"></div>
        </div>
    </main>

    <script>
        // ====================================================================
        // DADOS E ESTADO
        // ====================================================================
        // URL da planilha (configurável)
        let SHEET_CSV_URL = localStorage.getItem('sheetCsvUrl') || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSETVY6MUfwwl_TWax9qyqLXYzY3yZSuhPIQj16hHu-EhhdVYpyYnp81NOcM3akDQ/pub?output=csv';

        // Banco de feriados dinâmico: Brasil, Maranhão, São Luís
        function easterDate(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
        }
        function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
        function keyISO(d) { return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function getHolidayMap(year) {
            const map = new Map();
            const push = (y,m,d,nome,tipo='feriado') => map.set(`${y}-${pad2(m)}-${pad2(d)}`, { nome, tipo });
            // Nacionais fixos
            push(year,1,1,'Confraternização Universal');
            push(year,4,21,'Tiradentes');
            push(year,5,1,'Dia do Trabalho');
            push(year,9,7,'Independência do Brasil');
            push(year,10,12,'N. Sra. Aparecida');
            push(year,11,2,'Finados');
            push(year,11,15,'Proclamação da República');
            push(year,12,25,'Natal');
            push(year,11,20,'Consciência Negra');
            // Móveis
            const easter = easterDate(year);
            map.set(keyISO(addDays(easter,-2)), { nome: 'Sexta-feira da Paixão', tipo: 'feriado' });
            map.set(keyISO(addDays(easter,60)), { nome: 'Corpus Christi', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-48)), { nome: 'Carnaval (Segunda)', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-47)), { nome: 'Carnaval (Terça)', tipo: 'facultativo' });
            map.set(keyISO(addDays(easter,-46)), { nome: 'Quarta-feira de Cinzas', tipo: 'facultativo' });
            // Estaduais MA
            push(year,7,28,'Adesão do Maranhão (Estadual)');
            // Municipais São Luís
            push(year,6,29,'Dia de São Pedro (Municipal)');
            push(year,9,8,'Aniversário de São Luís (Municipal)');
            push(year,12,8,'N. Sra. da Conceição (Municipal)');
            return map;
        }

        let appState = {
            registros: [],
            extrasMap: new Map(), // Para feriados manuais
            loteSelecionados: new Set(),
            listaNomesCache: [],
            feriasDados: [] // Dados processados de férias
        };

        // ====================================================================
        // NAVEGAÇÃO
        // ====================================================================
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('bg-white/20', 'font-bold'); el.removeAttribute('aria-current'); });
            
            const target = document.getElementById(view === 'home' ? 'home-view' : 
                                                 view === 'ferias' ? 'ferias-view' :
                                                 view === 'processos' ? 'processos-view' :
                                                 view === 'noticias' ? 'noticias-view' : 'ponto-container');
            if(target) target.classList.remove('hidden');

            const btn = document.querySelector(`button[data-target="${view}"]`);
            if(btn) { btn.classList.add('bg-white/20', 'font-bold'); btn.setAttribute('aria-current', 'page'); }

            if(view === 'ponto') carregarPlanilha();
            if(view === 'ferias') carregarFerias();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tab}`);
            btn.classList.remove('border-transparent', 'text-gray-500');
            btn.classList.add('border-blue-600', 'text-blue-600');
            if(tab === 'feriados') renderFeriadosTab();
        }

        // ====================================================================
        // LÓGICA DE DADOS (CSV)
        // ====================================================================
        function pad2(n) { return String(n).padStart(2, '0'); }
        function nomeMesPT(m) { return ['JANEIRO','FEVEREIRO','MARÇO','ABRIL','MAIO','JUNHO','JULHO','AGOSTO','SETEMBRO','OUTUBRO','NOVEMBRO','DEZEMBRO'][m-1] || ''; }
        function parseCSV(text) {
            // Remove BOM se existir
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            const lines = text.split(/\r?\n/).filter(l => l.trim().length);
            if (!lines.length) return [];

            // Detecta delimitador: vírgula (CSV) ou ponto e vírgula (locale PT)
            const headerLine = lines[0];
            const countComma = (headerLine.match(/,/g)||[]).length;
            const countSemi = (headerLine.match(/;/g)||[]).length;
            const delim = countSemi > countComma ? ';' : ',';

            // Parser robusto com suporte a aspas e delimitadores no conteúdo
            function splitLine(line) {
                const res = []; let cur = ''; let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
                        else { inQuotes = !inQuotes; }
                    } else if (ch === delim && !inQuotes) {
                        res.push(cur); cur = '';
                    } else { cur += ch; }
                }
                res.push(cur);
                return res.map(c => c.trim().replace(/^"|"$/g, ''));
            }

            const headers = splitLine(lines[0]).map(h => h.trim());
            return lines.slice(1).map(line => {
                const cols = splitLine(line);
                const obj = {}; headers.forEach((h, i) => obj[h] = (cols[i]||'').trim());
                return obj;
            });
        }

        function norm(str) { return (str||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
        function getField(row, patterns) {
            const keys = Object.keys(row||{});
            for (const key of keys) {
                const nk = norm(key);
                for (const p of patterns) {
                    if (typeof p === 'string') { if (nk.includes(norm(p))) return row[key]; }
                    else if (p instanceof RegExp) { if (p.test(nk)) return row[key]; }
                }
            }
            return '';
        }
        function debounce(fn, wait=250) {
            let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
        }
        function getHolidayMapCached(ano) {
            if(!appState.holidayCache) appState.holidayCache = new Map();
            if(!appState.holidayCache.has(ano)) appState.holidayCache.set(ano, getHolidayMap(ano));
            return appState.holidayCache.get(ano);
        }

        async function carregarPlanilha() {
            if(appState.registros.length > 0) return;
            try {
                let resp;
                try {
                    resp = await fetch(SHEET_CSV_URL, { cache: 'no-store' });
                } catch (e) {
                    // Fallback CORS proxy se necessário
                    resp = await fetch(`https://cors.isomorphic-git.org/${SHEET_CSV_URL}`, { cache: 'no-store' });
                }
                const csv = await resp.text();
                appState.registros = parseCSV(csv);
                
                const unicos = new Set();
                appState.listaNomesCache = [];
                // Busca flexível de nome
                appState.registros.forEach(r => {
                    const nome = (getField(r, [/funcion[aá]rio/, /servidor/, /nome/, /colaborador/])||'').trim();
                    if(nome && !unicos.has(nome)) {
                        unicos.add(nome);
                        appState.listaNomesCache.push(nome);
                    }
                });
                appState.listaNomesCache.sort();

                // Popula UI Ponto
                const dl = document.getElementById('servidoresList');
                if(dl) {
                    dl.innerHTML = '';
                    appState.listaNomesCache.forEach(n => {
                        const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt);
                    });
                }
                renderListaLote();

            } catch(e) { console.error("Erro planilha", e); alert('Não foi possível carregar a planilha. Verifique a URL pública CSV ou tente novamente.'); }
        }

        // ====================================================================
        // LÓGICA DE FÉRIAS (ROBUSTA)
        // ====================================================================
        async function carregarFerias() {
            await carregarPlanilha();
            
            const hoje = new Date();
            appState.feriasDados = [];

            // Contadores
            let stats = { vencida: 0, critico: 0, atencao: 0, emdia: 0 };

            appState.registros.forEach(r => {
                const nome = getField(r, [/funcion[aá]rio/, /servidor/, /nome/, /colaborador/]) || '';
                const lotacao = getField(r, [/lota[cç][aã]o/, /unidade/, /setor/, /org[aã]o/]) || 'SEMCAS';
                const admissaoStr = getField(r, [/admiss[aã]o/, /data.*admiss/, /dt.*admiss/]);
                
                if(!nome || !admissaoStr) return;

                // Parse da Data DD/MM/AAAA ou DD/MM/AA
                let admissaoData;
                const parts = admissaoStr.split('/');
                if (parts.length === 3) {
                    let y = parseInt(parts[2]);
                    if(y < 100) y += 2000; // Assume século 21 para yy
                    admissaoData = new Date(y, parseInt(parts[1]) - 1, parseInt(parts[0]));
                } else { return; }

                if (isNaN(admissaoData.getTime())) return;

                // Lógica de Vencimento
                let anosTrabalhados = hoje.getFullYear() - admissaoData.getFullYear();
                
                const aniversarioEsteAno = new Date(hoje.getFullYear(), admissaoData.getMonth(), admissaoData.getDate());
                if (hoje < aniversarioEsteAno) anosTrabalhados--;

                const fimPeriodoAquisitivo = new Date(admissaoData);
                fimPeriodoAquisitivo.setFullYear(fimPeriodoAquisitivo.getFullYear() + anosTrabalhados);

                const limiteConcessivo = new Date(fimPeriodoAquisitivo);
                limiteConcessivo.setFullYear(limiteConcessivo.getFullYear() + 1);

                const diffTime = limiteConcessivo - hoje;
                const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                let status = 'emdia';
                if (diasRestantes < 0) status = 'vencida';
                else if (diasRestantes < 60) status = 'critico';
                else if (diasRestantes < 90) status = 'atencao';

                stats[status]++;

                appState.feriasDados.push({
                    nome,
                    lotacao,
                    admissao: admissaoStr,
                    limite: limiteConcessivo.toLocaleDateString('pt-BR'),
                    diasRestantes,
                    status
                });
            });

            // Atualiza Dashboard
            document.getElementById('count-vencida').textContent = stats.vencida;
            document.getElementById('count-critico').textContent = stats.critico;
            document.getElementById('count-atencao').textContent = stats.atencao;
            document.getElementById('count-emdia').textContent = stats.emdia;

            renderTabelaFerias();
        }

        function salvarSheetUrl() {
            const inp = document.getElementById('sheetUrlInput');
            const url = (inp?.value||'').trim();
            if(!url) { alert('Informe a URL pública CSV da planilha.'); return; }
            try {
                localStorage.setItem('sheetCsvUrl', url);
                SHEET_CSV_URL = url;
                appState.registros = [];
                carregarFerias();
            } catch(e) { alert('Falha ao salvar URL da planilha.'); }
        }

        const FERIAS_PAGE_SIZE = 50;
        function renderTabelaFerias() {
            const tbody = document.getElementById('tabela-ferias-body');
            tbody.innerHTML = '';

            const filtroNome = document.getElementById('filtroFerias').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatusFerias').value;
            const dadosOrdenados = [...appState.feriasDados].sort((a, b) => a.diasRestantes - b.diasRestantes);
            const filtrados = dadosOrdenados.filter(item => (filtroStatus === 'todos' || item.status === filtroStatus) && (!filtroNome || item.nome.toLowerCase().includes(filtroNome)));

            if(!appState.feriasPage) appState.feriasPage = 1;
            const totalPages = Math.max(1, Math.ceil(filtrados.length / FERIAS_PAGE_SIZE));
            if(appState.feriasPage > totalPages) appState.feriasPage = totalPages;
            const start = (appState.feriasPage - 1) * FERIAS_PAGE_SIZE;
            const pageItems = filtrados.slice(start, start + FERIAS_PAGE_SIZE);

            let html = '';
            pageItems.forEach(item => {
                let badge = '';
                if(item.status === 'vencida') badge = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">VENCIDA</span>`;
                else if(item.status === 'critico') badge = `<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full font-bold">CRÍTICO</span>`;
                else if(item.status === 'atencao') badge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">ATENÇÃO</span>`;
                else badge = `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">EM DIA</span>`;
                html += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="px-4 py-3 font-medium text-gray-900">${item.nome}</td>
                        <td class="px-4 py-3 text-gray-500 text-xs">${item.lotacao}</td>
                        <td class="px-4 py-3 text-gray-500">${item.admissao}</td>
                        <td class="px-4 py-3 text-gray-700 font-bold">${item.limite}</td>
                        <td class="px-4 py-3 ${item.diasRestantes < 0 ? 'text-red-600 font-bold' : ''}">${item.diasRestantes} dias</td>
                        <td class="px-4 py-3 text-center">${badge}</td>
                    </tr>`;
            });
            tbody.innerHTML = html;

            const info = document.getElementById('feriasPageInfo'); if(info) info.textContent = `Página ${appState.feriasPage} de ${totalPages} (${filtrados.length} registros)`;
            const prevBtn = document.getElementById('feriasPrevBtn'); if(prevBtn) prevBtn.disabled = appState.feriasPage <= 1;
            const nextBtn = document.getElementById('feriasNextBtn'); if(nextBtn) nextBtn.disabled = appState.feriasPage >= totalPages;
        }
        window.feriasPrev = function(){ if(appState.feriasPage>1){ appState.feriasPage--; renderTabelaFerias(); } }
        window.feriasNext = function(){ appState.feriasPage++; renderTabelaFerias(); }


        // ====================================================================
        // LÓGICA DE PONTO (Visualização A4)
        // ====================================================================
        function populateDaysTable(tbody, mm, aa) {
            tbody.innerHTML = '';
            const diasNoMes = new Date(aa, Number(mm), 0).getDate();
            document.getElementById('labelMesAno').textContent = `${nomeMesPT(Number(mm))}/${aa}`;

            const divOficiais = document.getElementById('listaFeriadosOficiais');
            if(divOficiais) divOficiais.innerHTML = ''; // Limpa lista visual
            const holidayMap = getHolidayMap(Number(aa));
            
            for(let i=1; i<=31; i++) {
                const tr = document.createElement('tr');
                tr.style.height = "18px";
                
                let diaTexto = i;
                let estilo = "";
                let texto = "";
                let editavel = `contenteditable="true"`;
                let isSpecial = false;

                if (i <= diasNoMes) {
                    const data = new Date(aa, Number(mm)-1, i);
                    const diaSemana = data.getDay(); // 0=Dom
                    const keyIso = `${aa}-${pad2(mm)}-${pad2(i)}`;

                    // Checa Feriado Oficial (dinâmico)
                    let feriado = holidayMap.get(keyIso);
                    if (feriado) {
                        isSpecial = true;
                        if(feriado.tipo === 'feriado') {
                            estilo = "background-color: #ffe4e6; color: #991b1b; font-weight: bold; font-size: 9px; letter-spacing: 0.5px;";
                            texto = `FERIADO: ${feriado.nome.toUpperCase()}`;
                        } else {
                            estilo = "background-color: #fef9c3; color: #854d0e; font-weight: bold; font-size: 9px; letter-spacing: 0.5px;";
                            texto = `PONTO FACULTATIVO: ${feriado.nome.toUpperCase()}`;
                        }
                        if(divOficiais) divOficiais.innerHTML += `<div class="flex justify-between border-b py-1"><span>${i}/${mm} - ${feriado.nome}</span> <span class="text-[10px] uppercase font-bold ${feriado.tipo==='feriado'?'text-red-500':'text-yellow-600'}">${feriado.tipo}</span></div>`;
                    }

                    // Checa Manual
                    if(appState.extrasMap.has(keyIso)) {
                        const extra = appState.extrasMap.get(keyIso);
                        isSpecial = true;
                        if(extra.tipo === 'feriado') {
                            estilo = "background-color: #ffe4e6; color: #991b1b; font-weight: bold; font-size: 9px;";
                            texto = `FERIADO: ${extra.nome.toUpperCase()}`;
                        } else {
                            estilo = "background-color: #fef9c3; color: #854d0e; font-weight: bold; font-size: 9px;";
                            texto = `PONTO FACULTATIVO: ${extra.nome.toUpperCase()}`;
                        }
                    }

                    if(!isSpecial && (diaSemana === 0 || diaSemana === 6)) {
                        isSpecial = true;
                        estilo = "background-color: #e5e7eb; font-weight: bold; font-size: 9px; letter-spacing: 1px; color: #374151;";
                        texto = (diaSemana === 6) ? "SÁBADO" : "DOMINGO";
                    }

                } else {
                    diaTexto = "—"; estilo = "background-color: #d1d5db;"; editavel = ""; isSpecial = true;
                }

                if (isSpecial && i <= diasNoMes) {
                    tr.innerHTML = `<td style="text-align: center; font-weight: bold;">${diaTexto}</td><td colspan="8" style="text-align: center; ${estilo}">${texto}</td>`;
                } else if (diaTexto === "—") {
                    tr.innerHTML = `<td style="text-align: center; background-color:#ccc;">—</td><td colspan="8" style="background-color:#eee;"></td>`;
                } else {
                    tr.innerHTML = `
                        <td style="text-align: center; font-weight: bold;">${diaTexto}</td>
                        <td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td>
                        <td ${editavel}></td><td ${editavel}></td><td ${editavel}></td><td ${editavel}></td>
                    `;
                }
                tbody.appendChild(tr);
            }
        }

        // ====================================================================
        // LISTA DE FERIADOS (ABA DEDICADA)
        // ====================================================================
        function renderFeriadosTab() {
            const sel = document.getElementById('feriadosAnoSelect');
            const ano = Number(sel?.value || new Date().getFullYear());
            const div = document.getElementById('listaFeriadosOficiais');
            if(!div) return;
            const map = getHolidayMap(ano);
            const items = Array.from(map.entries()).map(([iso, info]) => {
                const [y,m,d] = iso.split('-');
                const dt = new Date(Number(y), Number(m)-1, Number(d));
                return { dt, label: `${pad2(Number(d))}/${pad2(Number(m))} - ${info.nome}`, tipo: info.tipo };
            }).sort((a,b)=> a.dt - b.dt);
            let html = '';
            items.forEach(it => {
                html += `<div class="flex justify-between border-b py-1"><span>${it.label}</span> <span class="text-[10px] uppercase font-bold ${it.tipo==='feriado'?'text-red-500':'text-yellow-600'}">${it.tipo}</span></div>`;
            });
            div.innerHTML = html || '<div class="text-xs text-gray-500">Nenhum feriado listado para o ano selecionado.</div>';
            if(sel && !sel.onchange) sel.onchange = renderFeriadosTab;
        }

        // ====================================================================
        // FUNÇÕES DE AÇÃO (PONTO)
        // ====================================================================
        function preencherIndividual() {
            const nome = document.getElementById('servidorNome').value;
            const mm = document.getElementById('mesSelect').value;
            const aa = document.getElementById('anoSelect').value;
            
            // Busca ajustada para 'Funcionário'
            const row = appState.registros.find(r => (r['Funcionário'] || r['Funcionario'] || '').toLowerCase().includes(nome.toLowerCase()));
            
            const root = document.getElementById('mainPaper');
            if(row) {
                // Mapeamento ajustado para os novos cabeçalhos
                root.querySelector('#inpNome').value = row['Funcionário'] || row['Funcionario'];
                root.querySelector('#inpMatricula').value = row['Matricula'] || row['Matrícula'];
                root.querySelector('#inpCargo').value = row['Cargo Origem'] || row['Cargo'];
                root.querySelector('#inpUnidade').value = row['Lotação'] || row['Lotacao'] || 'SEMCAS';
                
                // Se não houver 'Vínculo', tenta usar 'Cargo Comissionado' para inferir ou mantém 'Efetivo'
                // O código anterior usava 'Efetivo' como fallback
                root.querySelector('#inpVinculo').value = row['Vínculo'] || 'Efetivo';
            }
            populateDaysTable(root.querySelector('#daysTableBody'), mm, aa);
        }

        function addFeriadoManual() {
            const data = document.getElementById('dataExtra').value;
            const nome = document.getElementById('nomeExtra').value;
            const tipo = document.getElementById('tipoExtra').value;
            if(!data || !nome) return;

            const p = data.split('/');
            const iso = `${p[2]}-${p[1]}-${p[0]}`;
            appState.extrasMap.set(iso, { nome, tipo });

            renderListaExtras();
            preencherIndividual();
        }

        function renderListaExtras() {
            const div = document.getElementById('listaExtras');
            div.innerHTML = '';
            appState.extrasMap.forEach((val, key) => {
                const el = document.createElement('div');
                el.className = `text-xs p-1 border rounded flex justify-between ${val.tipo==='feriado'?'bg-red-50 text-red-700':'bg-yellow-50 text-yellow-700'}`;
                el.innerHTML = `<span>${key.split('-').reverse().join('/')} - ${val.nome}</span> <button onclick="rmExtra('${key}')" class="font-bold">x</button>`;
                div.appendChild(el);
            });
        }
        window.rmExtra = (k) => { appState.extrasMap.delete(k); renderListaExtras(); preencherIndividual(); }

        // --- Lote ---
        function renderListaLote() {
            const div = document.getElementById('listaLote');
            if(!div) return;
            const filtro = document.getElementById('filtroLote').value.toLowerCase();
            let html = '';
            appState.listaNomesCache.filter(n => n.toLowerCase().includes(filtro)).forEach(nome => {
                const checked = appState.loteSelecionados.has(nome) ? 'checked' : '';
                const id = `chk-${nome.replace(/\s/g,'')}`;
                html += `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="${id}" value="${nome}" ${checked} onchange="toggleLote(this)">
                        <label for="${id}" class="truncate cursor-pointer">${nome}</label>
                    </div>`;
            });
            div.innerHTML = html;
            document.getElementById('contadorLote').innerText = `${appState.loteSelecionados.size} selecionados`;
        }

        window.toggleLote = (chk) => {
            if(chk.checked) appState.loteSelecionados.add(chk.value);
            else appState.loteSelecionados.delete(chk.value);
            document.getElementById('contadorLote').innerText = `${appState.loteSelecionados.size} selecionados`;
        };

        window.selecionarTodosLote = () => {
            const filtro = document.getElementById('filtroLote').value.toLowerCase();
            appState.listaNomesCache.filter(n => n.toLowerCase().includes(filtro)).forEach(n => appState.loteSelecionados.add(n));
            renderListaLote();
        };

        window.limparLote = () => {
            appState.loteSelecionados.clear();
            renderListaLote();
        };

        window.imprimirLote = () => {
            const container = document.getElementById('printContainer');
            container.innerHTML = '';
            const mm = document.getElementById('mesSelect').value;
            const aa = document.getElementById('anoSelect').value;

            if(appState.loteSelecionados.size === 0) return alert("Selecione alguém!");

            const template = document.getElementById('mainPaper');
            
            appState.loteSelecionados.forEach(nome => {
                const clone = template.cloneNode(true);
                clone.id = '';
                clone.classList.remove('hidden');
                clone.style.pageBreakAfter = 'always'; // Garantir quebra
                
                const row = appState.registros.find(r => (r['Funcionário'] || r['Funcionario'] || '') === nome);
                if(row) {
                    clone.querySelector('#inpNome').value = row['Funcionário'] || row['Funcionario'];
                    clone.querySelector('#inpMatricula').value = row['Matricula'] || row['Matrícula'];
                    clone.querySelector('#inpCargo').value = row['Cargo Origem'] || row['Cargo'];
                    clone.querySelector('#inpUnidade').value = row['Lotação'] || row['Lotacao'] || 'SEMCAS';
                    clone.querySelector('#inpVinculo').value = row['Vínculo'] || 'Efetivo';
                } else {
                    clone.querySelector('#inpNome').value = nome;
                }
                
                populateDaysTable(clone.querySelector('#daysTableBody'), mm, aa);
                container.appendChild(clone);
            });

            document.getElementById('mainPaper').parentElement.classList.add('hidden');
            container.classList.remove('hidden');
            window.print();
            setTimeout(() => {
                container.classList.add('hidden');
                container.innerHTML = '';
                document.getElementById('mainPaper').parentElement.classList.remove('hidden');
            }, 1000);
        };

        // ====================================================================
        // MÓDULO: PROCESSOS
        // ====================================================================
        function loadProcessos() {
            try { appState.processos = JSON.parse(localStorage.getItem('processos') || '[]'); }
            catch { appState.processos = []; }
        }
        function saveProcessos() { localStorage.setItem('processos', JSON.stringify(appState.processos)); }
        function renderListaProcessos() {
            const div = document.getElementById('listaProcessos');
            if(!div) return;
            div.innerHTML = '';
            if(appState.processos.length === 0) { div.innerHTML = '<div class="text-sm text-gray-500">Nenhum processo cadastrado.</div>'; return; }
            appState.processos.sort((a,b)=> new Date(b.data) - new Date(a.data)).forEach((p, idx) => {
                const qtNotas = (p.notas||[]).length;
                div.innerHTML += `
                    <div class="border rounded p-3 flex justify-between items-start">
                        <div>
                            <div class="font-bold text-gray-800">${p.titulo}</div>
                            <div class="text-xs text-gray-600">SEI: ${p.numero} • Data: ${new Date(p.data).toLocaleDateString('pt-BR')}</div>
                            <div class="text-xs text-gray-600">Notas: ${qtNotas}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-blue-600 text-sm" onclick="abrirProcDetalhe(${idx})">Abrir</button>
                            <button class="text-red-600 text-sm" onclick="excluirProcesso(${idx})">Excluir</button>
                        </div>
                    </div>`;
            });
        }
        function cadastrarProcesso() {
            const numero = document.getElementById('procNumero').value.trim();
            const titulo = document.getElementById('procTitulo').value.trim();
            const data = document.getElementById('procData').value;
            if(!numero || !titulo || !data) return alert('Preencha número, título e data.');
            appState.processos.push({ numero, titulo, data, notas: [] });
            saveProcessos(); renderListaProcessos();
            document.getElementById('procNumero').value = '';
            document.getElementById('procTitulo').value = '';
            document.getElementById('procData').value = '';
        }
        function excluirProcesso(idx) { if(!confirm('Excluir este processo?')) return; appState.processos.splice(idx,1); saveProcessos(); renderListaProcessos(); }
        function abrirProcDetalhe(idx) {
            const p = appState.processos[idx];
            const modal = document.getElementById('procDetalheModal');
            const conteudo = document.getElementById('procDetalheConteudo');
            modal.classList.remove('hidden');
            const notasHtml = (p.notas||[]).map((n,i)=>`<div class="border rounded p-2 mb-1"><div class="text-xs text-gray-600">${new Date(n.quando).toLocaleString('pt-BR')}</div><div>${n.texto}</div><div class="text-right"><button class="text-red-600 text-xs" onclick="excluirNota(${idx}, ${i})">Excluir nota</button></div></div>`).join('');
            conteudo.innerHTML = `
                <div class="space-y-2">
                    <div class="text-sm">SEI: <span class="font-bold">${p.numero}</span></div>
                    <div class="text-sm">Título: <span class="font-bold">${p.titulo}</span></div>
                    <div class="text-sm">Data: <span class="font-bold">${new Date(p.data).toLocaleDateString('pt-BR')}</span></div>
                </div>
                <div class="mt-3">
                    <h4 class="font-bold text-gray-800 mb-1">Bloco de notas</h4>
                    <div class="flex gap-2 mb-2">
                        <input id="notaData" type="datetime-local" class="border rounded px-2 py-1 text-sm">
                        <input id="notaTexto" class="border rounded px-2 py-1 text-sm w-full" placeholder="Resumo, ressalvas...">
                        <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="adicionarNota(${idx})">Adicionar</button>
                    </div>
                    <div>${notasHtml || '<div class=\'text-sm text-gray-500\'>Sem notas.</div>'}</div>
                </div>`;
        }
        function fecharProcDetalhe() { document.getElementById('procDetalheModal').classList.add('hidden'); }
        function adicionarNota(idx) {
            const quando = document.getElementById('notaData').value || new Date().toISOString();
            const texto = document.getElementById('notaTexto').value.trim();
            if(!texto) return;
            appState.processos[idx].notas.push({ quando, texto });
            saveProcessos(); abrirProcDetalhe(idx);
            document.getElementById('notaTexto').value = '';
        }
        function excluirNota(pIdx, nIdx) { appState.processos[pIdx].notas.splice(nIdx,1); saveProcessos(); abrirProcDetalhe(pIdx); }

        // ====================================================================
        // MÓDULO: NOTÍCIAS
        // ====================================================================
        function loadNoticias() { try { appState.noticias = JSON.parse(localStorage.getItem('noticias') || '[]'); } catch { appState.noticias = []; } }
        function saveNoticias() { localStorage.setItem('noticias', JSON.stringify(appState.noticias)); }
        function cadastrarNoticia() {
            const titulo = document.getElementById('newsTitulo').value.trim();
            const resumo = document.getElementById('newsResumo').value.trim();
            const conteudo = document.getElementById('newsConteudo').value.trim();
            const publicado = document.getElementById('newsPublicado').checked;
            if(!titulo || !resumo || !conteudo) return alert('Preencha título, resumo e conteúdo.');
            const item = { titulo, resumo, conteudo, publicado, criadoEm: new Date().toISOString() };
            appState.noticias.push(item); saveNoticias(); renderListaNoticias(); renderHomeNoticias();
            document.getElementById('newsTitulo').value = '';
            document.getElementById('newsResumo').value = '';
            document.getElementById('newsConteudo').value = '';
            document.getElementById('newsPublicado').checked = false;
        }
        function renderListaNoticias() {
            const div = document.getElementById('listaNoticias'); if(!div) return;
            div.innerHTML = '';
            if(appState.noticias.length === 0) { div.innerHTML = '<div class="text-sm text-gray-500">Nenhuma notícia cadastrada.</div>'; return; }
            appState.noticias.sort((a,b)=> new Date(b.criadoEm) - new Date(a.criadoEm)).forEach((n, idx) => {
                div.innerHTML += `
                    <div class="border rounded p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-gray-800">${n.titulo}</div>
                                <div class="text-xs text-gray-600">${new Date(n.criadoEm).toLocaleString('pt-BR')}</div>
                                <div class="text-sm text-gray-700 mt-1">${n.resumo}</div>
                            </div>
                            <div class="text-right">
                                <label class="text-xs text-gray-600 flex items-center gap-1"><input type="checkbox" ${n.publicado?'checked':''} onchange="togglePublicacao(${idx}, this.checked)"> Publicado</label>
                                <button class="text-red-600 text-xs mt-1" onclick="excluirNoticia(${idx})">Excluir</button>
                            </div>
                        </div>
                    </div>`;
            });
        }
        function excluirNoticia(idx) { if(!confirm('Excluir esta notícia?')) return; appState.noticias.splice(idx,1); saveNoticias(); renderListaNoticias(); renderHomeNoticias(); }
        function togglePublicacao(idx, checked) { appState.noticias[idx].publicado = checked; saveNoticias(); renderHomeNoticias(); }
        function renderHomeNoticias() {
            const homeCards = document.querySelector('#home-view .grid'); if(!homeCards) return;
            const publicados = appState.noticias.filter(n=>n.publicado).sort((a,b)=> new Date(b.criadoEm) - new Date(a.criadoEm));
            const avisoCard = homeCards.children[0];
            if(publicados.length > 0) {
                const ult = publicados[0];
                avisoCard.querySelector('h3').textContent = 'Últimos Avisos';
                avisoCard.querySelector('p').textContent = `${ult.titulo} — ${ult.resumo}`;
            } else { avisoCard.querySelector('p').textContent = 'Sem avisos publicados no momento.'; }
            const calCard = homeCards.children[1];
            const y = new Date().getFullYear(); const map = getHolidayMap(y); const hojeISO = keyISO(new Date());
            const proximos = Array.from(map.entries()).filter(([k,_])=> k >= hojeISO).sort(([a],[b])=> a.localeCompare(b));
            if(proximos.length > 0) { const [k, v] = proximos[0]; const [yy,mm,dd] = k.split('-'); calCard.querySelector('p').textContent = `Próximo: ${dd}/${mm}/${yy} — ${v.nome}`; }
        }

        // ====================================================================
        // INIT
        // ====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const selMes = document.getElementById('mesSelect');
            ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m, i) => {
                selMes.innerHTML += `<option value="${pad2(i+1)}">${m}</option>`;
            });
            selMes.value = pad2(new Date().getMonth()+1);

            const selAno = document.getElementById('anoSelect');
            const y = new Date().getFullYear();
            for(let i=y-2; i<=y+2; i++) selAno.innerHTML += `<option value="${i}" ${i===y?'selected':''}>${i}</option>`;

            document.getElementById('carregarDadosBtn').onclick = preencherIndividual;
            const filtroLoteEl = document.getElementById('filtroLote'); if(filtroLoteEl) filtroLoteEl.oninput = debounce(renderListaLote, 250);
            const filtroFeriasEl = document.getElementById('filtroFerias'); if(filtroFeriasEl) filtroFeriasEl.oninput = debounce(renderTabelaFerias, 250);
            document.getElementById('mesSelect').onchange = () => { preencherIndividual(); }; 
            document.getElementById('anoSelect').onchange = () => { preencherIndividual(); }; 

            // Carregar extras persistidos
            try {
                const stored = JSON.parse(localStorage.getItem('extrasMap') || '{}');
                Object.entries(stored).forEach(([k,v])=> appState.extrasMap.set(k, v));
                renderListaExtras();
            } catch(e) {}

            // Inicializa Processos
            loadProcessos();
            renderListaProcessos();
            const btnSalvarProc = document.getElementById('btnSalvarProc');
            if(btnSalvarProc) btnSalvarProc.onclick = cadastrarProcesso;

            // Inicializa Notícias
            loadNoticias();
            renderListaNoticias();
            const btnSalvarNews = document.getElementById('btnSalvarNews');
            if(btnSalvarNews) btnSalvarNews.onclick = cadastrarNoticia;

            // Preenche campo de planilha
            const sheetInput = document.getElementById('sheetUrlInput');
            if(sheetInput) sheetInput.value = SHEET_CSV_URL;

            router('home');
        });

    </script>
</body>
</html>
